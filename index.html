<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Cobblemon Mastery Guide</title>
  <meta name="description" content="Najlepsza polska baza buildów competitive Cobblemon. Poradnik IV, EV, Nature, Moveset dla wszystkich Pokémonów w Minecraft." />
  <meta name="keywords" content="Cobblemon, Pokemon, Minecraft, buildy, poradnik, competitive, IV, EV, Nature, moveset, Pokémon" />
  <meta property="og:title" content="Cobblemon Mastery Guide" />
  <meta property="og:description" content="Najlepsza polska baza buildów competitive Cobblemon." />
  <meta property="og:type" content="website" />
  <meta name="robots" content="index, follow" />
  <link rel="icon" type="image/png" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAR3SURBVFhH7VdNSGNXFD4vqZlR8xLzkhlf3ktmgv2BMuiuCLYLKUFxMZROp0w7yLTQRcGl1KpgS8GFuGlBt4KUFtoM/dkJxS6ycOFu0Hamlhn/Bxx/GjFRC2reV87zXRNvfvybdtUPDi/vvnvP991zzz33huh/nA9VRPQqETUTUZvz5Hdu/9dwiYjeI6IfiegpEaGIcfsPRHTH6f/c8AER/SkTai4XDLcbIZcL7kIxM0R0T3Z0VgSI6Cfh1KMouF1ZiW80DY90HZuGgb9NE1umice6jkQwiDuVlahWlHwhHDH2c2ZEiOh34ehuVRX+0HXg2rVDi0YPLRLJ/XbaH1y9ig+rqvJF/EZEpkxQDn4iesSDKxQFX2tajpQJT2E7hoFvNQ01LpcQwZPxyUSl8LMg/+XKFeD69QKCk2zHNJE2DPwaCiGQE8HLeSI4g+0B9szPQS5sNRzGlmEgoWlQcsvxrkyYjwoiesIdb1VWHoa9iONjVmZZ9kwTc7qOXcPAx9XVQsBjh6co3hah56wu6dxJOCZYNwzsc1uJHHkWDuNpOIyHtbX2tnVEvCUTC9znDjcvXy49+2gUGdPEJ6qKCBFcRIgSoUtVsW2aBSI4D57oOrYNAx/lovC9TMzgyrV8tPbFBESjSEcieM3jsR25vV68cuMGXI7jRo8HGREhZwxHaV7X8Zdh4L6mCQFLROSRBbxERFme0TPDAGKx3J4XFovhU1W1nbS1tVnLy8tgLC0toaWlxW7vVVVLHsuz5zxY1nWxLbNE9KIs4A12cElR0O/z4cuamqIWUBT4/H5sbGzY5AJra2vw+nwIKorF/b7Ksy98PnyuqvhMVfPzoEkWEHc+nGgNDQ3HyAXq6+sL+paxN2UBr/OH2tpaDA8PY2hoqKhpmgav12vPOB+rq6t2eygUKhjT399vW1dXl1VRUSEEFETAzgF2UA49PT22g3g8jvn5ebuNn/F43OL2vr4+eQi2t7exv7+PyclJSzk8qDgH6mQBnJWcnZiYmLBkJwKZTAaNjY1Hoayrqzv63dTUhJ2dnWP99/b2MDc3h62tLQwODtoiiWixVDFKcIfOzs6SAhhM0t3djVgsBg4pP3t7e7G7uyt3RTqdxuzsLDY3N9Hc3CwEfCcTC3CF4nW00ul0WRGMg4MDpFIpZLNZ+dMRVlZW7HwZHx+33G63iNZNmViAw8K1mhOmtNdTgsO/sLBgh1/kiHOzekEmzsdt7qgoipVMJi8kgncGJ+DAwIAgZ7slExYDXywRDAatqampc4ngfGDy0dHR/NDzWXMqqEQ0zYM0TbPGxsbOLEJkvStX+aaIyCsTlUPYGWQ76OjoyC4uLp6YmIxkMmnxWZEX9gdEpMsEpwHfDe0jmo0rXXt7ezaRSGRnZmasVCplZTIZa3193ZqenrZGRkas1tZWUWyE8dF76rtgKdwlood5TjlJEQgE7NLt9/vzCYXxJfR92dFFwFv0HWdGXMm4nOYT8vuCU2Q408tutYuCLy8vOwcYn6L85Pfn+nfsP8E/5+M/g2IKie4AAAAASUVORK5CYII=">
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap" rel="stylesheet" media="print" onload="this.media='all'" />
  <noscript><link href="https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap" rel="stylesheet" /></noscript>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9885277201663964"
     crossorigin="anonymous"></script>
  <script>
  /* ── Loading timeout fallback ── */
  (function(){
    var COB_LOAD_TIMER = setTimeout(function(){
      var m = document.getElementById('main-area');
      if(!m || !m.innerHTML.trim() || m.innerHTML.indexOf('Ladowanie')>-1){
        var d = document.createElement('div');
        d.id='cob-load-fallback';
        d.style.cssText='position:fixed;top:0;left:0;right:0;bottom:0;z-index:99999;background:#1a1a1a;display:flex;flex-direction:column;align-items:center;justify-content:center;font-family:monospace;color:#f0f0f0;text-align:center;padding:24px';
        d.innerHTML='<div style="font-size:28px;margin-bottom:16px">\u23f3</div>'
          +'<div style="font-size:20px;margin-bottom:12px;color:#ffaa00">Strona \u0142aduje si\u0119 zbyt d\u0142ugo...</div>'
          +'<div style="font-size:16px;color:#aaa;margin-bottom:20px">Mo\u017cliwe przyczyny: wolne po\u0142\u0105czenie, blokowanie skrypt\u00f3w lub problem z PokeAPI.</div>'
          +'<button onclick="location.reload()" style="font-family:monospace;font-size:18px;background:#555;color:#fff;border:2px solid #888;padding:8px 24px;cursor:pointer">\ud83d\udd04 Spr\u00f3buj od\u015bwie\u017cy\u0107</button>'
          +'<div style="font-size:13px;color:#666;margin-top:16px">Je\u015bli problem si\u0119 powtarza, wyczy\u015b\u0107 dane strony (Ctrl+Shift+Del) i spr\u00f3buj ponownie.</div>';
        document.body.appendChild(d);
      }
    }, 12000);
    window._cobClearLoadTimer = function(){ clearTimeout(COB_LOAD_TIMER); var f=document.getElementById('cob-load-fallback'); if(f)f.remove(); };
  })();
  </script>
  <style>
    :root {
      --bg:        #1a1a1a;
      --stone:     #2f2f2f;
      --stone2:    #3a3a3a;
      --slot:      #8b8b8b;
      --slot-dark: #555;
      --slot-light:#c6c6c6;
      --green:     #55ff55;
      --gold:      #ffaa00;
      --red:       #ff5555;
      --blue:      #5555ff;
      --aqua:      #55ffff;
      --white:     #f0f0f0;
      --gray:      #aaaaaa;
      --border:    #000;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg);
      color: var(--white);
      font-family: 'VT323', monospace;
      font-size: 18px;
      min-height: 100vh;
    }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--stone); }
    ::-webkit-scrollbar-thumb { background: var(--slot-dark); border: 1px solid #000; }

    /* ── HEADER ── */
    header {
      background: linear-gradient(180deg, #3d2b1a 0%, #2a1d0e 100%);
      border-bottom: 4px solid #000;
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header img.logo { width: 48px; height: 48px; image-rendering: pixelated; }
    .header-title {
      font-family: 'Press Start 2P', monospace;
      font-size: 14px;
      color: var(--green);
      text-shadow: 2px 2px #000, 0 0 12px #00aa00;
      line-height: 1.6;
    }
    .header-subtitle {
      font-family: 'VT323', monospace;
      font-size: 18px;
      color: var(--gold);
    }
    .header-right { margin-left: auto; display: flex; align-items: center; gap: 10px; }
    .mc-badge {
      background: var(--stone2);
      border: 2px solid var(--slot-dark);
      border-right-color: var(--slot-light);
      border-bottom-color: var(--slot-light);
      padding: 4px 10px;
      font-size: 14px;
      color: var(--aqua);
    }

    /* ── MC BUTTON ── */
    .mc-btn {
      font-family: 'VT323', monospace;
      font-size: 20px;
      background: var(--slot);
      color: #fff;
      border: 3px solid;
      border-top-color: var(--slot-light);
      border-left-color: var(--slot-light);
      border-right-color: #333;
      border-bottom-color: #333;
      padding: 4px 14px;
      cursor: pointer;
      text-shadow: 1px 1px #000;
      transition: filter 0.1s;
      user-select: none;
    }
    .mc-btn:hover { filter: brightness(1.15); }
    .mc-btn:active {
      border-top-color: #333;
      border-left-color: #333;
      border-right-color: var(--slot-light);
      border-bottom-color: var(--slot-light);
    }
    .mc-btn.active {
      background: #666;
      border-top-color: #333;
      border-left-color: #333;
      color: var(--green);
    }

    /* ── MC INPUT ── */
    .mc-input {
      font-family: 'VT323', monospace;
      font-size: 22px;
      background: #131313;
      color: var(--white);
      border: 3px solid;
      border-top-color: #333;
      border-left-color: #333;
      border-right-color: var(--slot-light);
      border-bottom-color: var(--slot-light);
      padding: 6px 12px;
      outline: none;
      caret-color: var(--white);
      width: 100%;
    }
    .mc-input:focus { border-color: var(--green); }
    .mc-input::placeholder { color: #666; }

    /* ── LAYOUT ── */
    .app-layout {
      display: flex;
      height: calc(100vh - 80px);
    }
    aside {
      width: 260px;
      min-width: 260px;
      background: var(--stone);
      border-right: 4px solid #000;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .main-area {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* ── SIDEBAR ── */
    .sidebar-search {
      padding: 12px;
      border-bottom: 3px solid #000;
      background: #222;
      position: relative;
      z-index: 10;
    }
    .sidebar-search label {
      display: block;
      color: var(--gray);
      font-size: 14px;
      margin-bottom: 4px;
    }
    .sidebar-close {
      display: none; position: absolute; top: 8px; right: 8px;
      background: none; border: 2px solid #555; color: var(--red);
      font-size: 22px; width: 32px; height: 32px; cursor: pointer;
      font-family: 'VT323', monospace; line-height: 1;
      z-index: 11; text-align: center;
    }
    .sidebar-close:hover { background: #3a1a1a; border-color: var(--red); }
    .tabs { display: flex; gap: 0; border-bottom: 3px solid #000; }
    .tab-btn {
      flex: 1; background: var(--stone2); color: var(--gray); border: none;
      border-right: 2px solid #000; padding: 8px 4px;
      font-family: 'VT323', monospace; font-size: 16px; cursor: pointer; text-align: center;
    }
    .tab-btn:last-child { border-right: none; }
    .tab-btn.active { background: #555; color: var(--green); }
    .tab-btn:hover:not(.active) { background: #444; color: var(--white); }
    .gen-filters {
      padding: 10px 12px; background: #252525; border-bottom: 3px solid #000;
      display: flex; flex-wrap: wrap; gap: 5px;
    }
    .gen-filter-btn {
      font-family: 'VT323', monospace; font-size: 16px;
      background: var(--stone2); color: var(--gray); border: 2px solid #000;
      padding: 2px 8px; cursor: pointer;
    }
    .gen-filter-btn.active { background: #2a5a2a; color: var(--green); border-color: #44aa44; }
    .gen-filter-btn:hover:not(.active) { background: #444; color: var(--white); }

    .pokemon-list { overflow-y: auto; flex: 1; }
    .pokemon-entry {
      display: flex; align-items: center; gap: 10px; padding: 6px 12px;
      border-bottom: 1px solid #2a2a2a; cursor: pointer;
      transition: background 0.1s; user-select: none;
    }
    .pokemon-entry:hover { background: #3a3a3a; }
    .pokemon-entry.selected { background: #2a4a2a; border-left: 3px solid var(--green); }
    .pokemon-entry img { width: 36px; height: 36px; image-rendering: pixelated; }
    .pokemon-entry .entry-name { font-size: 20px; color: var(--white); text-transform: capitalize; }
    .pokemon-entry .entry-id { margin-left: auto; font-size: 14px; color: var(--gray); }
    .entry-badges { display: flex; gap: 4px; }
    .badge-friendship { font-size: 12px; background: #664400; color: var(--gold); padding: 1px 5px; border: 1px solid #aa6600; }
    .badge-trade      { font-size: 12px; background: #004488; color: var(--aqua); padding: 1px 5px; border: 1px solid #0066cc; }

    /* ── MAIN CONTENT ── */
    .page-title {
      font-family: 'Press Start 2P', monospace; font-size: 11px;
      color: var(--green); text-shadow: 1px 1px #000; margin-bottom: 16px;
      display: flex; align-items: center; gap: 10px;
    }
    .page-title::after {
      content: ''; flex: 1; height: 2px;
      background: linear-gradient(to right, #33aa33 0%, transparent 100%);
    }

    /* ── POKEMON DETAIL ── */
    .detail-grid { display: grid; grid-template-columns: 280px 1fr; gap: 16px; }
    .mc-panel {
      background: var(--stone2);
      border: 3px solid;
      border-top-color: var(--slot-light);
      border-left-color: var(--slot-light);
      border-right-color: #333;
      border-bottom-color: #333;
      padding: 14px;
    }
    .mc-panel h2 {
      font-family: 'Press Start 2P', monospace; font-size: 10px;
      color: var(--gold); margin-bottom: 10px; padding-bottom: 6px;
      border-bottom: 2px solid #000;
    }
    .pokemon-portrait { text-align: center; padding: 16px; }
    .pokemon-portrait img {
      width: 128px; height: 128px; image-rendering: pixelated;
      filter: drop-shadow(0 0 8px rgba(85,255,85,0.3));
    }
    .pokemon-name-big {
      font-family: 'Press Start 2P', monospace; font-size: 13px;
      color: var(--white); text-transform: capitalize; margin-top: 8px;
    }
    .pokemon-number { color: var(--gray); font-size: 20px; }
    .types { display: flex; gap: 6px; justify-content: center; margin-top: 8px; flex-wrap: wrap; }
    .type-badge {
      font-family: 'VT323', monospace; font-size: 16px;
      padding: 2px 12px; border: 2px solid #000;
      text-transform: uppercase; letter-spacing: 1px;
    }
    .type-normal   { background:#a8a878; color:#fff; }
    .type-fire     { background:#f08030; color:#fff; }
    .type-water    { background:#6890f0; color:#fff; }
    .type-electric { background:#f8d030; color:#000; }
    .type-grass    { background:#78c850; color:#fff; }
    .type-ice      { background:#98d8d8; color:#000; }
    .type-fighting { background:#c03028; color:#fff; }
    .type-poison   { background:#a040a0; color:#fff; }
    .type-ground   { background:#e0c068; color:#000; }
    .type-flying   { background:#a890f0; color:#fff; }
    .type-psychic  { background:#f85888; color:#fff; }
    .type-bug      { background:#a8b820; color:#fff; }
    .type-rock     { background:#b8a038; color:#fff; }
    .type-ghost    { background:#705898; color:#fff; }
    .type-dragon   { background:#7038f8; color:#fff; }
    .type-dark     { background:#705848; color:#fff; }
    .type-steel    { background:#b8b8d0; color:#000; }
    .type-fairy    { background:#ee99ac; color:#000; }

    .stat-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .stat-name { width: 90px; font-size: 16px; color: var(--gray); }
    .stat-val  { width: 36px; text-align: right; font-size: 18px; color: var(--white); }
    .stat-bar-bg { flex: 1; height: 10px; background: #1a1a1a; border: 1px solid #000; }
    .stat-bar { height: 100%; }

    /* ── IV SECTION ── */
    .iv-section {
      background: #0d1a2a; border: 3px solid #1a4a6a; padding: 14px; margin-top: 12px;
    }
    .iv-section h2 {
      font-family: 'Press Start 2P', monospace; font-size: 10px;
      color: var(--aqua); margin-bottom: 10px; padding-bottom: 6px;
      border-bottom: 2px solid #1a4a6a; display: flex; align-items: center; gap: 8px;
    }
    .iv-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .iv-name { width: 72px; font-size: 16px; color: var(--gray); }
    .iv-input {
      width: 48px; font-family: 'VT323', monospace; font-size: 20px;
      background: #000; color: var(--white); border: 2px solid #1a4a6a;
      text-align: center; padding: 1px 4px; outline: none;
    }
    .iv-input:focus { border-color: var(--aqua); }
    .iv-bar-wrap { flex: 1; height: 12px; background: #0a0a0a; border: 1px solid #111; position: relative; }
    .iv-bar { height: 100%; transition: width 0.2s, background 0.2s; }
    .iv-label { width: 72px; font-size: 15px; text-align: right; }
    .iv-priority { width: 20px; text-align: center; font-size: 18px; cursor: help; }
    .iv-legend {
      display: flex; gap: 12px; flex-wrap: wrap; margin-top: 10px;
      padding-top: 8px; border-top: 1px solid #1a4a6a; font-size: 15px;
    }
    .iv-legend-item { display: flex; align-items: center; gap: 5px; }
    .iv-legend-dot { width: 12px; height: 12px; border: 1px solid #000; }
    .iv-role-badge {
      display: inline-block; background: #0a2a0a; color: var(--green);
      border: 1px solid #2a6a2a; padding: 2px 10px; font-size: 16px; margin-bottom: 6px;
    }
    .iv-summary {
      background: #000; border: 2px solid #1a4a6a; padding: 8px 12px;
      margin-bottom: 10px; font-size: 17px; line-height: 1.8;
    }
    .iv-target { width: 64px; font-size: 15px; text-align: center; font-weight: bold; }
    .iv-row-priority { background: #05151f; }

    /* ── IV HYBRID SLIDER ── */
    .iv-hybrid {
      display: flex; align-items: center; gap: 6px; flex: 1;
    }
    .iv-hybrid input[type="range"] {
      -webkit-appearance: none; appearance: none;
      flex: 1; height: 10px; border-radius: 5px;
      background: #111; border: 1px solid #333;
      outline: none; cursor: pointer;
      min-width: 80px;
    }
    .iv-hybrid input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: 26px; height: 26px; border-radius: 50%;
      background: var(--iv-thumb, #55ffff);
      border: 3px solid #000;
      box-shadow: 0 0 6px var(--iv-thumb, #55ffff), inset 0 0 2px rgba(255,255,255,0.3);
      cursor: pointer;
      margin-top: -8px;
    }
    .iv-hybrid input[type="range"]::-moz-range-thumb {
      width: 22px; height: 22px; border-radius: 50%;
      background: var(--iv-thumb, #55ffff);
      border: 3px solid #000;
      box-shadow: 0 0 6px var(--iv-thumb, #55ffff), inset 0 0 2px rgba(255,255,255,0.3);
      cursor: pointer;
    }
    .iv-hybrid input[type="range"]::-webkit-slider-runnable-track {
      height: 10px; border-radius: 5px;
      background: linear-gradient(to right, var(--iv-track, #55ffff) 0%, var(--iv-track, #55ffff) var(--iv-pct, 100%), #111 var(--iv-pct, 100%), #111 100%);
    }
    .iv-hybrid input[type="range"]::-moz-range-track {
      height: 10px; border-radius: 5px; border: none;
      background: linear-gradient(to right, var(--iv-track, #55ffff) 0%, var(--iv-track, #55ffff) var(--iv-pct, 100%), #111 var(--iv-pct, 100%), #111 100%);
    }
    .iv-hybrid input[type="number"] {
      width: 52px; font-family: 'VT323', monospace; font-size: 20px;
      background: #000; color: var(--white); border: 2px solid #333;
      text-align: center; padding: 2px 4px; outline: none;
    }
    .iv-hybrid input[type="number"]:focus { border-color: var(--aqua); }
    /* calc & battle variants */
    .calc-iv-hybrid {
      display: flex; align-items: center; gap: 6px; margin-top: 4px;
    }
    .calc-iv-hybrid input[type="range"] {
      -webkit-appearance: none; appearance: none;
      flex: 1; height: 10px; border-radius: 5px;
      background: #111; border: 1px solid #333;
      outline: none; cursor: pointer;
      min-width: 60px;
    }
    .calc-iv-hybrid input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none;
      width: 26px; height: 26px; border-radius: 50%;
      background: var(--iv-thumb, #55ffff);
      border: 3px solid #000;
      box-shadow: 0 0 6px var(--iv-thumb, #55ffff), inset 0 0 2px rgba(255,255,255,0.3);
      cursor: pointer;
      margin-top: -8px;
    }
    .calc-iv-hybrid input[type="range"]::-moz-range-thumb {
      width: 22px; height: 22px; border-radius: 50%;
      background: var(--iv-thumb, #55ffff);
      border: 3px solid #000;
      box-shadow: 0 0 6px var(--iv-thumb, #55ffff), inset 0 0 2px rgba(255,255,255,0.3);
      cursor: pointer;
    }
    .calc-iv-hybrid input[type="range"]::-webkit-slider-runnable-track {
      height: 10px; border-radius: 5px;
      background: linear-gradient(to right, var(--iv-track, #55ffff) 0%, var(--iv-track, #55ffff) var(--iv-pct, 100%), #111 var(--iv-pct, 100%), #111 100%);
    }
    .calc-iv-hybrid input[type="range"]::-moz-range-track {
      height: 10px; border-radius: 5px; border: none;
      background: linear-gradient(to right, var(--iv-track, #55ffff) 0%, var(--iv-track, #55ffff) var(--iv-pct, 100%), #111 var(--iv-pct, 100%), #111 100%);
    }
    .calc-iv-hybrid input[type="number"] {
      width: 52px; font-family: 'VT323', monospace; font-size: 18px;
      background: #000; color: var(--white); border: 2px solid #333;
      text-align: center; padding: 2px 4px; outline: none;
    }
    .calc-iv-hybrid input[type="number"]:focus { border-color: var(--gold); }
    @media (max-width: 768px) {
      .iv-hybrid input[type="range"]::-webkit-slider-thumb { width: 32px; height: 32px; margin-top: -11px; }
      .iv-hybrid input[type="range"]::-moz-range-thumb { width: 28px; height: 28px; }
      .calc-iv-hybrid input[type="range"]::-webkit-slider-thumb { width: 32px; height: 32px; margin-top: -11px; }
      .calc-iv-hybrid input[type="range"]::-moz-range-thumb { width: 28px; height: 28px; }
    }

    /* ── MOVES SECTION ── */
    .moves-section {
      background: #1a1a2a; border: 3px solid #3a3a7a; padding: 14px; margin-top: 12px;
    }
    .moves-section h2 {
      font-family: 'Press Start 2P', monospace; font-size: 10px;
      color: var(--aqua); margin-bottom: 10px; padding-bottom: 6px;
      border-bottom: 2px solid #3a3a7a; display: flex; align-items: center; gap: 8px;
    }
    .moves-tabs { display: flex; gap: 0; margin-bottom: 10px; border-bottom: 2px solid #2a2a4a; }
    .moves-tab {
      font-family: 'VT323', monospace; font-size: 18px;
      background: #111; color: #888; border: none; padding: 4px 16px;
      cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px;
    }
    .moves-tab.active { color: var(--aqua); border-bottom-color: var(--aqua); background: #0a0a1a; }
    .moves-tab:hover:not(.active) { color: #ccc; background: #1a1a2a; }
    .moves-panel { display: none; }
    .moves-panel.active { display: block; }
    .move-table { width: 100%; border-collapse: collapse; font-size: 17px; max-width: 100%; }
    .move-table th {
      text-align: left; color: #666; font-size: 14px; padding: 3px 8px;
      border-bottom: 1px solid #2a2a4a; font-family: 'VT323', monospace; font-weight: normal;
    }
    .move-table td { padding: 3px 8px; border-bottom: 1px solid #111; }
    .move-table tr:hover td { background: #0a0a2a; }
    .move-cat-physical { color: #f08030; }
    .move-cat-special  { color: #6890f0; }
    .move-cat-status   { color: #aaaaaa; }
    .move-name { color: var(--white); text-transform: capitalize; }
    .move-lv {
      background: #002a00; color: var(--green); border: 1px solid #004400;
      padding: 0 6px; font-size: 15px; display: inline-block; min-width: 36px; text-align: center;
    }
    .move-tm {
      background: #00002a; color: var(--aqua); border: 1px solid #000066;
      padding: 0 6px; font-size: 15px; display: inline-block; min-width: 36px; text-align: center;
    }

    /* ── COMPETITIVE BUILD SECTION ── */
    .comp-section {
      background: #12101e; border: 3px solid #5a3a9a; padding: 14px; margin-top: 12px;
    }
    .comp-section h2 {
      font-family: 'Press Start 2P', monospace; font-size: 10px;
      color: #c084fc; margin-bottom: 12px; padding-bottom: 6px;
      border-bottom: 2px solid #5a3a9a;
    }
    .comp-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 14px; }
    .comp-grid-full { margin-bottom: 14px; }
    .comp-box { background: #0a0818; border: 2px solid #3a2a6a; padding: 10px; }
    .comp-box-title {
      font-family: 'Press Start 2P', monospace; font-size: 8px;
      color: #c084fc; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;
    }
    .ev-row { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
    .ev-amount { font-family: 'Press Start 2P', monospace; font-size: 9px; min-width: 36px; color: #f0f0f0; }
    .ev-bar-bg { flex: 1; height: 8px; background: #111; border: 1px solid #222; }
    .ev-bar { height: 100%; }
    .ev-stat-name { width: 56px; font-size: 15px; text-align: right; }
    .nature-badge {
      display: block; font-family: 'Press Start 2P', monospace;
      font-size: 11px; color: #f0f0f0; margin-bottom: 6px;
    }
    .nature-detail { font-size: 16px; line-height: 1.7; }
    .nature-up   { color: #55ff55; }
    .nature-down { color: #ff5555; }
    .item-big-name {
      font-family: 'Press Start 2P', monospace; font-size: 9px;
      color: var(--gold); margin-bottom: 6px;
    }
    .item-big-desc { font-size: 16px; color: #aaa; line-height: 1.5; }
    .item-layout { display: flex; gap: 12px; }
    .item-main {
      flex: 1; background: #0d0a1a; border: 1px solid #5a3a9a;
      border-radius: 4px; padding: 10px; text-align: center; min-width: 0;
    }
    .item-main-label {
      font-family: 'Press Start 2P', monospace; font-size: 7px;
      color: #c084fc; margin-bottom: 8px; text-transform: uppercase;
    }
    .item-alt-section { flex: 1; display: flex; flex-direction: column; min-width: 0; }
    .item-alt-label {
      font-family: 'Press Start 2P', monospace; font-size: 7px;
      color: #888; margin-bottom: 8px; text-transform: uppercase;
    }
    .item-alt-grid { display: flex; flex-direction: column; gap: 6px; }
    .item-alt-card {
      display: flex; align-items: center; gap: 8px;
      background: #080614; border: 1px solid #2a1a4a;
      padding: 6px 8px; border-radius: 3px; transition: border-color 0.15s;
    }
    .item-alt-card:hover { border-color: #5a3a9a; }
    .item-alt-info { min-width: 0; }
    .item-alt-name {
      font-family: 'VT323', monospace; font-size: 16px;
      color: var(--gold); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .item-alt-desc { font-size: 13px; color: #777; line-height: 1.3; }
    .ability-box { background: #0a0818; border: 2px solid #6a3aaa; padding: 10px; }
    .ability-name {
      font-family: 'Press Start 2P', monospace; font-size: 9px;
      color: #c084fc; margin-bottom: 6px; text-transform: capitalize;
    }
    .ability-desc { font-size: 15px; color: #aaa; line-height: 1.5; }
    .ability-hidden-tag {
      font-size: 12px; color: #a855f7; margin-left: 4px;
    }
    .ability-rec-tag {
      display: inline-block; font-size: 11px; color: #55ff55; margin-top: 6px;
      border: 1px solid #2a5a2a; background: #0a1a0a; padding: 1px 6px;
    }
    .best4-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .move-card {
      background: #0a0818; border: 2px solid #3a2a6a; padding: 8px 10px; position: relative;
    }
    .move-card-num { position: absolute; top: 6px; right: 8px; font-size: 13px; color: #554488; }
    .move-card-name {
      font-family: 'Press Start 2P', monospace; font-size: 8px;
      color: #f0f0f0; margin-bottom: 5px; text-transform: capitalize;
    }
    .move-card-meta { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    .move-power { background: #1a1a0a; color: var(--gold); border: 1px solid #3a3a0a; padding: 1px 6px; font-size: 15px; }
    .move-cat-p { background:#2a1200; color:#f08030; border:1px solid #5a2a00; padding:1px 6px; font-size:14px; }
    .move-cat-s { background:#00001a; color:#6890f0; border:1px solid #00004a; padding:1px 6px; font-size:14px; }
    .move-cat-z { background:#1a1a1a; color:#aaa; border:1px solid #333; padding:1px 6px; font-size:14px; }
    .move-stab  { background:#0a2a0a; color:#55ff55; border:1px solid #2a5a2a; padding:1px 6px; font-size:14px; }
    .move-coverage { background:#1a0a2a; color:#c084fc; border:1px solid #5a2a8a; padding:1px 6px; font-size:14px; }
    .move-stars { font-size:15px; color: var(--gold); margin-top:3px; }
    .ev-total { font-size:15px; color:#666; margin-top:6px; }

    /* ── COBBLEMON SECTION ── */
    .cobblemon-section {
      background: #1a2a1a; border: 3px solid #2a5a2a; padding: 14px; margin-top: 16px;
    }
    .cobblemon-section h2 {
      font-family: 'Press Start 2P', monospace; font-size: 10px;
      color: var(--green); margin-bottom: 10px; padding-bottom: 6px;
      border-bottom: 2px solid #2a5a2a; display: flex; align-items: center; gap: 8px;
    }
    .cob-icon { font-size: 20px; }
    .info-row {
      display: flex; gap: 8px; align-items: flex-start; margin-bottom: 8px;
      padding: 8px; background: #0f1f0f; border: 1px solid #2a5a2a;
    }
    .info-row .info-icon { font-size: 22px; min-width: 28px; }
    .info-row .info-text { font-size: 18px; color: var(--white); line-height: 1.4; }
    .info-row .info-text em { color: var(--gold); font-style: normal; }
    .info-row .info-text code {
      background: #000; color: var(--aqua); padding: 1px 6px;
      font-family: 'VT323', monospace; font-size: 18px; border: 1px solid #333;
    }
    .cmd-block {
      background: #000; border: 2px solid #333; padding: 8px 12px; margin-top: 8px;
      color: var(--aqua); font-size: 20px;
    }
    .cmd-block::before { content: '> '; color: var(--green); }

    /* ── EVOLUTIONS ── */
    .evo-chain { display: flex; align-items: center; flex-wrap: wrap; gap: 8px; padding: 8px 0; }
    .evo-item {
      display: flex; flex-direction: column; align-items: center; cursor: pointer;
      padding: 6px; border: 2px solid #444; background: #222;
      transition: border-color 0.1s; min-width: 70px;
    }
    .evo-item:hover { border-color: var(--green); transform: scale(1.05); }
    .evo-item img { width: 56px; height: 56px; image-rendering: pixelated; }
    .evo-item span { font-size: 14px; color: var(--white); text-transform: capitalize; text-align: center; }
    .evo-arrow { font-size: 24px; color: var(--gold); }
    .evo-trigger {
      font-size: 12px; color: var(--gray); text-align: center; max-width: 100px;
      line-height: 1.3; white-space: normal;
    }
    .evo-trigger .evo-cond {
      display: block; font-size: 11px; color: #aaa;
    }
    .evo-trigger .evo-cond-special {
      display: block; font-size: 11px; color: #55ddff;
    }
    .evo-trigger .evo-cond-cobblemon {
      display: block; font-size: 10px; color: #55ff55; font-style: italic;
    }
    .evo-condition {
      font-size: 11px; color: var(--gold); text-align: center; max-width: 100px;
      line-height: 1.3; margin-top: 4px; word-wrap: break-word;
    }
    .evo-condition .evo-cond { display: block; font-size: 11px; color: #aaa; text-transform: none; }
    .evo-condition .evo-cond-special { display: block; font-size: 11px; color: #55ddff; text-transform: none; }
    .evo-condition .evo-cond-cobblemon { display: block; font-size: 10px; color: #55ff55; font-style: italic; text-transform: none; }

    /* ── ITEMS PAGE ── */
    .items-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 12px; }
    .item-card {
      background: var(--stone2);
      border: 3px solid;
      border-top-color: var(--slot-light); border-left-color: var(--slot-light);
      border-right-color: #333; border-bottom-color: #333;
      padding: 12px; display: flex; gap: 12px; align-items: flex-start;
    }
    .item-icon { font-size: 32px; min-width: 40px; text-align: center; }
    .item-name {
      font-family: 'Press Start 2P', monospace; font-size: 8px;
      color: var(--gold); margin-bottom: 6px; display: flex; align-items: center; gap: 6px;
    }
    .item-desc { font-size: 16px; color: var(--gray); line-height: 1.4; }
    .item-tag {
      display: inline-block; background: #2a4a0a; color: var(--green);
      border: 1px solid #4a8a1a; font-size: 12px; padding: 1px 6px; margin-top: 4px;
    }
    .item-icon-img {
      width: 32px; height: 32px; image-rendering: pixelated; vertical-align: middle;
    }

    /* ── APRICORNS PAGE ── */
    .apricorn-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-top: 16px; }
    .apricorn-card {
      background: var(--stone2);
      border: 3px solid;
      border-top-color: var(--slot-light); border-left-color: var(--slot-light);
      border-right-color: #333; border-bottom-color: #333;
      padding: 12px; text-align: center;
    }
    .apricorn-icon { font-size: 40px; margin-bottom: 6px; }
    .apricorn-name {
      font-family: 'Press Start 2P', monospace; font-size: 8px;
      color: var(--white); margin-bottom: 8px;
    }
    .apricorn-arrow { color: var(--gold); font-size: 22px; margin: 4px 0; }
    .apricorn-ball {
      font-size: 22px; color: var(--aqua);
      border: 2px solid #2a4a6a; background: #0a1a2a;
      padding: 4px 10px; display: inline-flex; align-items: center; gap: 6px;
    }
    .apricorn-effect { font-size: 14px; color: var(--gray); margin-top: 6px; }

    /* ── WELCOME PAGE ── */
    .welcome-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; margin-top: 16px; }
    .welcome-card {
      background: var(--stone2);
      border: 3px solid;
      border-top-color: var(--slot-light); border-left-color: var(--slot-light);
      border-right-color: #333; border-bottom-color: #333;
      padding: 16px;
    }
    .welcome-card h3 {
      font-family: 'Press Start 2P', monospace; font-size: 9px;
      color: var(--green); margin-bottom: 10px; padding-bottom: 6px;
      border-bottom: 2px solid #000;
    }
    .welcome-card p, .welcome-card li { font-size: 18px; color: var(--gray); line-height: 1.6; }
    .welcome-card ul { padding-left: 20px; }
    .welcome-card li { color: var(--white); }
    .welcome-card li::marker { color: var(--green); }

    /* ── STATUS / SPINNER ── */
    #status-bar {
      padding: 8px 16px; background: #111; border-top: 2px solid #000;
      font-size: 16px; color: var(--gray); display: flex; align-items: center; gap: 8px;
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 200; height: 36px;
    }
    .spinner { width: 14px; height: 14px; border: 3px solid #333; border-top-color: var(--green);
      border-radius: 50%; animation: spin 0.7s linear infinite; display: none; }
    .spinner.active { display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .empty-state { text-align: center; padding: 60px 20px; color: var(--gray); font-size: 22px; }
    .empty-state .big-icon { font-size: 64px; display: block; margin-bottom: 12px; }
    .section-sep { border: none; border-top: 3px solid #333; margin: 16px 0; }
    .info-cols { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .info-entry { margin-bottom: 6px; display: flex; gap: 8px; }
    .info-label { color: var(--gray); font-size: 16px; min-width: 120px; }
    .info-value { color: var(--white); font-size: 18px; text-transform: capitalize; }
    #pokemon-count {
      font-size: 14px; color: var(--gray); padding: 4px 12px;
      border-bottom: 2px solid #1a1a1a; background: #222;
    }

    /* ── HAMBURGER ── */
    .hamburger-btn {
      display: none; background: none; border: none;
      color: var(--white); font-size: 28px; cursor: pointer;
      padding: 4px 8px; font-family: 'VT323', monospace;
    }
    .sidebar-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.6); z-index: 999;
    }
    .sidebar-overlay.active { display: block; }

    /* ── AD CONTAINER ── */
    .ad-container {
      background: var(--stone2); border: 2px dashed #555;
      padding: 12px; text-align: center; color: var(--gray); font-size: 14px;
      min-height: 60px; display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .ad-label {
      background: #444; color: #888; padding: 2px 8px; font-size: 11px;
      border: 1px solid #555; font-family: 'Press Start 2P', monospace;
    }

    /* ── DONATE SECTION (top bar) ── */
    .donate-section {
      background: #1a1a1a; padding: 14px 24px; text-align: center;
      display: flex; align-items: center; justify-content: center; gap: 16px;
      flex-wrap: wrap; min-height: 60px;
    }
    .donate-section h2 {
      font-family: 'Press Start 2P', monospace; font-size: 10px;
      color: var(--green); margin: 0;
    }
    .donate-section p { color: var(--gray); font-size: 16px; margin: 0; line-height: 1.4; }
    .donate-btn {
      font-family: 'Press Start 2P', monospace; font-size: 11px;
      background: linear-gradient(180deg, #4a2, #283); color: #fff;
      border: 3px solid; border-top-color: #6c4; border-left-color: #6c4;
      border-right-color: #142; border-bottom-color: #142;
      padding: 8px 20px; cursor: pointer; text-shadow: 1px 1px #000; transition: filter 0.15s;
    }
    .donate-btn:hover { filter: brightness(1.2); }

    /* ── BUILD TABS ── */
    .build-tabs { display: flex; gap: 0; margin-bottom: 12px; border-bottom: 2px solid #3a2a6a; }
    .build-tab {
      font-family: 'VT323', monospace; font-size: 18px;
      background: #0a0818; color: #888; border: none; padding: 6px 16px;
      cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.15s;
    }
    .build-tab.active { color: #c084fc; border-bottom-color: #c084fc; background: #12101e; }
    .build-tab:hover:not(.active) { color: #ccc; background: #15132a; }
    .build-tab .best-choice-star { color: #ffaa00; margin-right: 2px; font-size: 16px; }
    .build-panel { display: none; }
    .build-panel.active { display: block; }
    .best-choice-badge {
      display: inline-block; font-family: 'Press Start 2P', monospace; font-size: 7px;
      background: linear-gradient(90deg, #3a2a00 0%, #1a1400 100%);
      color: #ffaa00; border: 1px solid #ffaa00; padding: 2px 8px;
      margin-left: 8px; vertical-align: middle; letter-spacing: 0.5px;
      text-shadow: 0 0 6px rgba(255,170,0,0.4);
      animation: bestChoicePulse 2s ease-in-out infinite;
    }
    @keyframes bestChoicePulse {
      0%, 100% { box-shadow: 0 0 4px rgba(255,170,0,0.3); }
      50% { box-shadow: 0 0 12px rgba(255,170,0,0.6); }
    }

    /* ── FAVORITE STAR ── */
    .fav-star {
      background: none; border: none; font-size: 24px; cursor: pointer;
      padding: 2px 6px; filter: grayscale(1) opacity(0.5); transition: all 0.15s;
    }
    .fav-star:hover { filter: grayscale(0) opacity(0.8); }
    .fav-star.active { filter: grayscale(0) opacity(1); }
    .fav-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; margin-top: 10px; }
    .fav-card {
      background: var(--stone2);
      border: 3px solid; border-top-color: var(--slot-light); border-left-color: var(--slot-light);
      border-right-color: #333; border-bottom-color: #333;
      padding: 10px; text-align: center; cursor: pointer; transition: border-color 0.15s;
    }
    .fav-card:hover { border-color: var(--green); }
    .fav-card img { width: 56px; height: 56px; image-rendering: pixelated; }
    .fav-card span { display: block; font-size: 16px; color: var(--white); text-transform: capitalize; margin-top: 4px; }

    /* ── CALCULATOR ── */
    .calc-section {
      background: #1a1a0a; border: 3px solid #5a5a1a; padding: 14px; margin-top: 16px;
    }
    .calc-section h2 {
      font-family: 'Press Start 2P', monospace; font-size: 10px;
      color: var(--gold); margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #5a5a1a;
    }
    .calc-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px; }
    .calc-box { background: #111; border: 2px solid #333; padding: 10px; }
    .calc-box label {
      display: block; font-size: 14px; color: var(--gray); margin-bottom: 4px;
      font-family: 'VT323', monospace;
    }
    .calc-select, .calc-field {
      font-family: 'VT323', monospace; font-size: 18px;
      background: #000; color: var(--white); border: 2px solid #333;
      padding: 4px 8px; width: 100%; outline: none;
    }
    .calc-select:focus, .calc-field:focus { border-color: var(--gold); }
    .calc-verdict {
      background: #000; border: 3px solid #333; padding: 16px; text-align: center;
      font-size: 22px; line-height: 1.8; margin-top: 10px;
    }
    .calc-verdict .verdict-emoji { font-size: 36px; display: block; margin-bottom: 8px; }

    /* ── COPY LINK BTN ── */
    .copy-link-btn {
      font-family: 'VT323', monospace; font-size: 16px;
      background: #1a1a2a; color: var(--aqua); border: 2px solid #3a3a7a;
      padding: 4px 12px; cursor: pointer; transition: all 0.15s;
    }
    .copy-link-btn:hover { background: #2a2a4a; }

    /* ── MOVE TYPE ICON ── */
    .move-type-icon {
      width: 20px; height: 20px; vertical-align: middle; margin-right: 2px;
      image-rendering: pixelated; border-radius: 50%;
    }

    /* ── LANGUAGE TOGGLE ── */
    .lang-toggle {
      display: flex; gap: 0; border: 2px solid var(--slot-dark); margin-left: 8px;
    }
    .lang-btn {
      font-family: 'VT323', monospace; font-size: 16px;
      background: var(--stone2); color: var(--gray); border: none;
      padding: 4px 10px; cursor: pointer; transition: all 0.15s;
    }
    .lang-btn.active { background: #2a5a2a; color: var(--green); }
    .lang-btn:hover:not(.active) { background: #444; color: var(--white); }

    /* ── TEAM ANALYZER ── */
    .team-section {
      background: #1a0a2a; border: 3px solid #5a2a8a; padding: 14px; margin-top: 16px;
    }
    .team-section h2 {
      font-family: 'Press Start 2P', monospace; font-size: 10px;
      color: #c084fc; margin-bottom: 12px; padding-bottom: 6px;
      border-bottom: 2px solid #5a2a8a;
    }
    .team-slots {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 16px;
    }
    .team-slot {
      background: #0a0818; border: 2px dashed #3a2a6a; padding: 12px;
      text-align: center; min-height: 130px; position: relative;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: border-color 0.2s;
    }
    .team-slot.filled { border-style: solid; border-color: #5a3a9a; }
    .team-slot:hover { border-color: #c084fc; }
    .team-slot img { width: 64px; height: 64px; image-rendering: pixelated; }
    .team-slot .slot-name {
      font-size: 16px; color: var(--white); text-transform: capitalize; margin-top: 4px;
    }
    .team-slot .slot-types { display: flex; gap: 4px; justify-content: center; margin-top: 4px; flex-wrap: wrap; }
    .team-slot .slot-remove {
      position: absolute; top: 4px; right: 6px; background: none; border: none;
      color: var(--red); font-size: 18px; cursor: pointer; font-family: 'VT323', monospace;
      opacity: 0.6; transition: opacity 0.15s;
    }
    .team-slot .slot-remove:hover { opacity: 1; }
    .team-slot .slot-num {
      position: absolute; top: 4px; left: 6px; font-size: 14px; color: #554488;
    }
    .team-search-wrap { position: relative; margin-bottom: 16px; max-width: 400px; }
    .team-search-results {
      position: absolute; top: 100%; left: 0; right: 0; background: #1a1a2a;
      border: 2px solid #3a3a7a; max-height: 220px; overflow-y: auto; z-index: 50;
      display: none;
    }
    .team-search-results.open { display: block; }
    .team-search-item {
      display: flex; align-items: center; gap: 8px; padding: 6px 10px;
      cursor: pointer; border-bottom: 1px solid #2a2a4a; font-size: 18px;
      color: var(--white); text-transform: capitalize;
    }
    .team-search-item:hover { background: #2a2a4a; }
    .team-search-item img { width: 32px; height: 32px; image-rendering: pixelated; }
    .defense-summary {
      background: #0a0818; border: 2px solid #3a2a6a; padding: 14px; margin-top: 12px;
    }
    .defense-summary h3 {
      font-family: 'Press Start 2P', monospace; font-size: 9px;
      color: #c084fc; margin-bottom: 10px;
    }
    .defense-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 6px;
    }
    .defense-entry {
      display: flex; align-items: center; gap: 4px; padding: 3px 6px;
      font-size: 15px; border: 1px solid #222;
    }
    .defense-weak { background: #2a0a0a; border-color: #5a2020; color: var(--red); }
    .defense-resist { background: #0a2a0a; border-color: #205a20; color: var(--green); }
    .defense-immune { background: #1a1a2a; border-color: #3a3a5a; color: var(--aqua); }
    .defense-neutral { background: #1a1a1a; border-color: #333; color: var(--gray); }

    /* ── BIOME SECTION ── */
    .biome-section {
      background: #0a1a0a; border: 3px solid #1a5a1a; padding: 14px; margin-top: 12px;
    }
    .biome-section h2 {
      font-family: 'Press Start 2P', monospace; font-size: 10px;
      color: var(--green); margin-bottom: 10px; padding-bottom: 6px;
      border-bottom: 2px solid #1a5a1a;
    }
    .biome-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .biome-tag {
      background: #0f2f0f; color: var(--green); border: 1px solid #2a5a2a;
      padding: 3px 10px; font-size: 15px; display: inline-flex; align-items: center; gap: 4px;
    }
    .time-tag {
      background: #1a1a0a; color: var(--gold); border: 1px solid #3a3a0a;
      padding: 3px 10px; font-size: 15px; display: inline-flex; align-items: center; gap: 4px;
    }

    /* ── APRICORN FRUIT ICON ── */
    .apricorn-fruit {
      width: 40px; height: 40px; border-radius: 50%; margin: 0 auto 6px;
      border: 3px solid rgba(0,0,0,0.4); image-rendering: pixelated;
      box-shadow: inset 0 -4px 6px rgba(0,0,0,0.3), 0 2px 4px rgba(0,0,0,0.5);
    }

    /* ── ITEM CARD IMG-ONLY ── */
    .item-icon-only {
      width: 32px; height: 32px; image-rendering: pixelated;
      display: flex; align-items: center; justify-content: center;
      min-width: 40px;
    }
    .item-icon-only img {
      width: 32px; height: 32px; image-rendering: pixelated;
    }

    /* ── WEAKNESS CHECKER ── */
    .wc-wrap {
      max-width: 800px; margin: 0 auto;
    }
    .wc-intro {
      background: linear-gradient(135deg, #0d0d1f 0%, #1a1a2e 100%);
      border: 2px solid #2a2a4a; padding: 16px 20px; margin-bottom: 20px;
      font-size: 16px; color: var(--gray); line-height: 1.6; text-align: center;
    }
    .wc-intro strong { color: var(--white); }
    .wc-selector-panel {
      background: linear-gradient(135deg, #0a0a1f 0%, #111128 100%);
      border: 3px solid #3a3a6a; padding: 24px; margin-bottom: 24px;
    }
    .wc-selector-panel h3 {
      font-family: 'Press Start 2P', monospace; font-size: 11px;
      color: var(--aqua); margin-bottom: 20px; text-align: center;
    }
    .wc-selector-row {
      display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-bottom: 10px;
    }
    .wc-selector-col {
      flex: 1; min-width: 220px; max-width: 340px;
    }
    .wc-selector-col label {
      display: block; font-family: 'Press Start 2P', monospace; font-size: 9px;
      color: var(--gold); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;
    }
    .wc-type-grid {
      display: flex; flex-wrap: wrap; gap: 5px;
    }
    .wc-type-btn {
      font-family: 'VT323', monospace; font-size: 15px;
      padding: 5px 10px; border: 2px solid transparent; cursor: pointer;
      transition: all 0.15s ease; opacity: 0.7; border-radius: 4px;
      background: none; color: #fff;
    }
    .wc-type-btn:hover { opacity: 1; transform: scale(1.08); }
    .wc-type-btn.wc-selected {
      opacity: 1; border-color: var(--white); transform: scale(1.1);
      box-shadow: 0 0 12px rgba(255,255,255,0.3);
    }
    .wc-none-btn {
      background: #2a2a3a; color: #888; font-size: 14px; padding: 5px 10px; border-radius: 4px;
    }
    .wc-none-btn.wc-selected { background: #3a3a5a; color: var(--white); }
    .wc-selected-display {
      text-align: center; margin: 16px 0 6px;
      font-family: 'VT323', monospace; font-size: 22px; color: var(--gray);
      min-height: 36px;
    }
    .wc-selected-display .type-badge {
      font-size: 16px; padding: 3px 12px; margin: 0 4px;
    }
    /* Critical x4 banner */
    .wc-critical {
      background: linear-gradient(135deg, #3a0000 0%, #550000 50%, #3a0000 100%);
      border: 3px solid #ff2222; padding: 16px; margin-bottom: 16px;
      text-align: center; animation: wc-pulse 2s infinite;
    }
    @keyframes wc-pulse {
      0%, 100% { box-shadow: 0 0 8px rgba(255,34,34,0.3); }
      50% { box-shadow: 0 0 24px rgba(255,34,34,0.6); }
    }
    .wc-critical h4 {
      font-family: 'Press Start 2P', monospace; font-size: 12px;
      color: #ff4444; margin-bottom: 10px; letter-spacing: 1px;
    }
    .wc-critical .wc-badge-row {
      display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;
    }
    .wc-critical .type-badge {
      font-size: 16px; padding: 6px 16px;
    }
    /* Result sections */
    .wc-results {
      display: flex; flex-direction: column; gap: 14px;
    }
    .wc-section {
      background: #111119; border: 2px solid #2a2a3a; padding: 14px 16px;
    }
    .wc-section h4 {
      font-family: 'Press Start 2P', monospace; font-size: 10px;
      margin-bottom: 10px; padding-bottom: 6px; border-bottom: 1px solid #2a2a3a;
      display: flex; align-items: center; gap: 8px;
    }
    .wc-section.wc-threats h4 { color: #ff8855; }
    .wc-section.wc-resists h4 { color: #55cc55; }
    .wc-section.wc-immune h4  { color: #55aaff; }
    .wc-badge-row {
      display: flex; flex-wrap: wrap; gap: 6px; align-items: center;
    }
    .wc-badge-row .type-badge {
      font-size: 15px; padding: 4px 14px;
    }
    .wc-mult-label {
      font-family: 'VT323', monospace; font-size: 16px; margin-right: 4px;
      min-width: 32px; display: inline-block; text-align: right;
    }
    .wc-mult-x4  { color: #ff4444; }
    .wc-mult-x2  { color: #ff8855; }
    .wc-mult-half { color: #55cc55; }
    .wc-mult-quarter { color: #338855; }
    .wc-empty-state {
      text-align: center; padding: 40px 20px; color: #555;
      font-family: 'VT323', monospace; font-size: 22px;
    }
    .wc-neutral-row {
      margin-top: 8px; padding-top: 8px; border-top: 1px solid #1a1a2a;
    }
    .wc-neutral-row .type-badge { opacity: 0.5; font-size: 13px; padding: 2px 8px; }

    /* ── BATTLE SIM ── */
    .battle-page { max-width: 1060px; margin: 0 auto; }
    .battle-setup { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .battle-setup-card {
      background: var(--stone2); border: 3px solid;
      border-top-color: var(--slot-light); border-left-color: var(--slot-light);
      border-right-color: #333; border-bottom-color: #333;
      padding: 14px;
    }
    .battle-setup-card h3 {
      font-family: 'Press Start 2P', monospace; font-size: 10px;
      margin-bottom: 12px; padding-bottom: 6px; border-bottom: 2px solid #000;
    }
    .battle-setup-card.player h3 { color: var(--green); }
    .battle-setup-card.opponent h3 { color: var(--red); }
    .battle-start-wrap { text-align: center; margin: 20px 0; }
    .battle-start-btn {
      font-family: 'Press Start 2P', monospace; font-size: 14px;
      background: linear-gradient(180deg, #3a7a3a, #1a4a1a); color: #fff;
      border: 3px solid; border-top-color: #6c4; border-left-color: #6c4;
      border-right-color: #142; border-bottom-color: #142;
      padding: 12px 32px; cursor: pointer; text-shadow: 1px 1px #000;
      transition: filter 0.15s;
    }
    .battle-start-btn:hover { filter: brightness(1.2); }
    .battle-start-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: none; }
    .battle-arena { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .battle-card {
      background: var(--stone2); border: 3px solid;
      border-top-color: var(--slot-light); border-left-color: var(--slot-light);
      border-right-color: #333; border-bottom-color: #333;
      padding: 14px; position: relative;
    }
    .battle-card.player-card { border-left: 4px solid var(--green); }
    .battle-card.opponent-card { border-left: 4px solid var(--red); }
    .battle-pokemon-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }
    .battle-pokemon-img {
      width: 96px; height: 96px; image-rendering: pixelated;
      filter: drop-shadow(0 0 6px rgba(85,255,85,0.2));
    }
    .battle-pokemon-info { flex: 1; }
    .battle-pokemon-name {
      font-family: 'Press Start 2P', monospace; font-size: 11px;
      color: var(--white); text-transform: capitalize; margin-bottom: 4px;
    }
    .battle-pokemon-types { display: flex; gap: 4px; flex-wrap: wrap; }
    .battle-hp-section { margin: 8px 0; }
    .battle-hp-label { display: flex; justify-content: space-between; font-size: 16px; margin-bottom: 4px; }
    .battle-hp-label .hp-text { color: var(--gray); }
    .battle-hp-label .hp-val { color: var(--white); font-family: 'Press Start 2P', monospace; font-size: 10px; }
    .battle-hp-bar-bg {
      width: 100%; height: 16px; background: #1a1a1a; border: 2px solid #000;
      overflow: hidden; position: relative;
    }
    .battle-hp-bar-fill {
      height: 100%; transition: width 0.6s ease, background-color 0.3s ease;
      position: relative;
    }
    .battle-hp-bar-fill::after {
      content: ''; position: absolute; top: 0; left: 0; right: 0; height: 50%;
      background: linear-gradient(180deg, rgba(255,255,255,0.15), transparent);
    }
    .battle-stat-preview {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; margin-top: 8px; font-size: 14px;
    }
    .battle-stat-item {
      background: #1a1a1a; border: 1px solid #333; padding: 2px 6px;
      display: flex; justify-content: space-between;
    }
    .battle-stat-item .bs-name { color: var(--gray); }
    .battle-stat-item .bs-val { color: var(--white); }
    .battle-moves-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 12px; }
    .battle-move-btn {
      font-family: 'VT323', monospace; font-size: 20px;
      background: #1a1a2a; color: var(--white); border: 2px solid #3a3a6a;
      padding: 10px 8px; cursor: pointer; transition: all 0.15s;
      text-align: left; position: relative; display: flex; flex-direction: column; gap: 2px;
    }
    .battle-move-btn:hover:not(:disabled) { border-color: var(--aqua); background: #2a2a4a; }
    .battle-move-btn:active:not(:disabled) { transform: scale(0.97); }
    .battle-move-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .battle-move-btn.super-effective {
      border-color: #33aa33; background: #0a2a0a;
      box-shadow: 0 0 8px rgba(85,255,85,0.2);
    }
    .battle-move-btn.not-very-effective { border-color: #8a4a00; background: #1a0a00; }
    .battle-move-btn.immune { border-color: #333; background: #111; opacity: 0.5; }
    .battle-move-name { font-size: 18px; font-weight: bold; text-transform: capitalize; }
    .battle-move-meta { font-size: 14px; color: var(--gray); display: flex; gap: 6px; }
    .battle-move-eff { font-size: 12px; position: absolute; top: 4px; right: 6px; }
    .battle-move-eff.se { color: var(--green); }
    .battle-move-eff.nve { color: var(--gold); }
    .battle-move-eff.imm { color: var(--red); }
    .battle-log {
      background: #0a0a0a; border: 3px solid #333; padding: 12px;
      margin-top: 16px; max-height: 220px; overflow-y: auto; font-size: 17px; line-height: 1.8;
    }
    .battle-log-entry { border-bottom: 1px solid #1a1a1a; padding: 2px 0; }
    .battle-log-entry.se { color: var(--green); }
    .battle-log-entry.nve { color: var(--gold); }
    .battle-log-entry.imm { color: var(--red); }
    .battle-log-entry.faint { color: var(--red); font-family: 'Press Start 2P', monospace; font-size: 11px; }
    .battle-log-entry.neutral { color: var(--white); }
    .battle-result {
      text-align: center; padding: 24px;
      background: linear-gradient(135deg, #0a1a0a, #1a2a1a);
      border: 3px solid; margin-top: 16px;
    }
    .battle-result.victory { border-color: var(--green); }
    .battle-result.defeat { border-color: var(--red); }
    .battle-result h2 { font-family: 'Press Start 2P', monospace; font-size: 16px; margin-bottom: 12px; }
    .battle-result.victory h2 { color: var(--green); }
    .battle-result.defeat h2 { color: var(--red); }
    .battle-result-buttons { display: flex; gap: 12px; justify-content: center; margin-top: 16px; }
    .battle-search-wrap { position: relative; margin-bottom: 12px; }
    .battle-search-results {
      position: absolute; top: 100%; left: 0; right: 0; background: #1a1a2a;
      border: 2px solid #3a3a7a; max-height: 200px; overflow-y: auto; z-index: 50; display: none;
    }
    .battle-search-results.open { display: block; }
    .battle-iv-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin: 8px 0; }
    .battle-iv-box { background: #111; border: 1px solid #333; padding: 4px 6px; }
    .battle-iv-box label { display: block; font-size: 13px; color: var(--gray); margin-bottom: 2px; }
    .battle-iv-box input {
      font-family: 'VT323', monospace; font-size: 18px;
      background: #000; color: var(--white); border: 1px solid #333;
      width: 100%; padding: 2px 4px; text-align: center; outline: none;
    }
    .battle-iv-box input:focus { border-color: var(--aqua); }
    .battle-select-row { margin: 8px 0; }
    .battle-select-row label { display: block; font-size: 14px; color: var(--gray); margin-bottom: 4px; }
    .battle-select-row select {
      font-family: 'VT323', monospace; font-size: 18px;
      background: #000; color: var(--white); border: 2px solid #333;
      padding: 4px 8px; width: 100%; outline: none;
    }
    .battle-select-row select:focus { border-color: var(--aqua); }
    .battle-preview {
      display: flex; align-items: center; gap: 12px; padding: 8px;
      background: #1a1a1a; border: 1px solid #333; margin: 8px 0;
    }
    .battle-preview img { width: 64px; height: 64px; image-rendering: pixelated; }
    .battle-preview-info { flex: 1; min-width: 0; }
    .battle-preview-name {
      font-family: 'Press Start 2P', monospace; font-size: 10px;
      color: var(--white); text-transform: capitalize;
    }
    .battle-preview-types { display: flex; gap: 4px; margin-top: 4px; flex-wrap: wrap; }
    .battle-moves-preview { margin-top: 8px; }
    .battle-moves-preview-title { font-size: 14px; color: var(--gray); margin-bottom: 4px; }
    .battle-move-chip {
      display: inline-block; font-size: 14px; padding: 2px 8px; margin: 2px;
      border: 1px solid #3a3a6a; background: #1a1a2a; color: var(--white); text-transform: capitalize;
    }
    .battle-random-btn {
      font-family: 'VT323', monospace; font-size: 20px;
      background: #2a4a2a; color: var(--green); border: 2px solid #55ff55;
      padding: 6px 14px; cursor: pointer; width: 100%; margin-bottom: 8px; transition: filter 0.15s;
    }
    .battle-random-btn:hover { filter: brightness(1.2); }
    .battle-waiting {
      text-align: center; padding: 8px; color: var(--gold); font-size: 20px;
      animation: blink 1s infinite;
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.5} }

    /* ── RESPONSIVE ── */
    @media (max-width: 768px) {
      .wc-selector-row { flex-direction: column; align-items: stretch; }
      .wc-selector-col { max-width: 100%; }
      .wc-critical h4 { font-size: 10px; }
      .hamburger-btn { display: block; }
      .sidebar-close { display: block; }
      header { flex-wrap: wrap; padding: 10px 12px; gap: 8px; }
      .header-title { font-size: 11px; }
      .header-subtitle { font-size: 14px; }
      .header-right { display: none; width: 100%; flex-direction: column; gap: 6px; }
      .header-right.mobile-open { display: flex; }
      .app-layout { flex-direction: column; height: auto; min-height: calc(100vh - 80px); }
      aside {
        position: fixed; left: -280px; top: 0; bottom: 0;
        width: 280px; min-width: 280px; z-index: 1000; transition: left 0.25s ease;
      }
      aside.mobile-open { left: 0; }
      .main-area { padding: 12px; padding-bottom: 50px; }
      .detail-grid { grid-template-columns: 1fr; }
      .comp-grid { grid-template-columns: 1fr; }
      .best4-grid { grid-template-columns: 1fr; }
      .info-cols { grid-template-columns: 1fr; }
      .calc-grid { grid-template-columns: 1fr; }
      .welcome-grid { grid-template-columns: 1fr; }
      .move-table { display: block; max-width: 100%; overflow-x: auto; }
      .items-grid { grid-template-columns: 1fr; }
      .apricorn-grid { grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); }
      .mc-badge { font-size: 12px; padding: 2px 6px; }
      .build-tabs { flex-wrap: wrap; }
      .build-tab { font-size: 14px; padding: 4px 8px; }
      .best-choice-badge { font-size: 6px; padding: 1px 5px; }
      .item-layout { flex-direction: column; }
      .item-main { padding: 8px; }
      .item-main .item-big-name { font-size: 8px; }
      .item-main .item-big-desc { font-size: 14px; }
      .item-alt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
      .item-alt-card { flex-direction: column; text-align: center; padding: 6px; gap: 4px; }
      .item-alt-name { font-size: 14px; white-space: normal; }
      .item-alt-desc { font-size: 11px; }
      .item-alt-info { text-align: center; }
      .ad-container { min-height: 50px; font-size: 12px; }
      .team-slots { grid-template-columns: repeat(2, 1fr); }
      .defense-grid { grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); }
      .battle-setup { grid-template-columns: 1fr; }
      .battle-arena { grid-template-columns: 1fr; }
      .battle-card.opponent-card { order: -1; }
      .battle-iv-grid { grid-template-columns: repeat(2, 1fr); }
      .battle-moves-grid { grid-template-columns: 1fr; }
      .battle-stat-preview { grid-template-columns: repeat(2, 1fr); }
      .battle-start-btn { font-size: 11px; padding: 10px 20px; }
    }

    /* ═══════════════════════════════════════════════════════════
       UI OVERHAUL v2 — Glassmorphism · Readability · Glow
       ═══════════════════════════════════════════════════════════ */

    /* Readability: base 16px, key names 24px */
    body { font-size: 16px; }
    .pokemon-name-big { font-size: 24px !important; }
    .page-title span { font-size: 16px; }
    .mc-panel h2, .iv-section h2, .comp-section h2, .moves-section h2,
    .cobblemon-section h2, .calc-section h2, .team-section h2, .biome-section h2 {
      font-size: 13px !important;
    }
    .entry-name { font-size: 22px !important; }
    .stat-val { font-size: 20px !important; }

    /* Font-weight 900 for key data */
    .type-badge, .iv-name, .iv-target, .stat-val, .stat-name,
    .ev-amount, .nature-badge, .item-big-name, .move-card-name,
    .pokemon-name-big, .entry-name, .defense-entry,
    .battle-pokemon-name, .comp-box-title, .iv-label {
      font-weight: 900 !important;
    }

    /* Glassmorphism panels */
    .mc-panel {
      background: rgba(58, 58, 58, 0.65) !important;
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      border: 1px solid rgba(255,255,255,0.08) !important;
      border-top-color: rgba(200,200,200,0.15) !important;
      border-left-color: rgba(200,200,200,0.15) !important;
      border-right-color: rgba(0,0,0,0.3) !important;
      border-bottom-color: rgba(0,0,0,0.3) !important;
      padding: 17px !important;
      border-radius: 10px;
    }
    .iv-section {
      background: rgba(13, 26, 42, 0.7) !important;
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      border-color: rgba(26,74,106,0.6) !important;
      padding: 17px !important;
      border-radius: 10px;
    }
    .comp-section {
      background: rgba(18, 16, 30, 0.7) !important;
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      border-color: rgba(90,58,154,0.5) !important;
      padding: 17px !important;
      border-radius: 10px;
    }
    .moves-section {
      background: rgba(26, 26, 42, 0.7) !important;
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      border-color: rgba(58,58,122,0.5) !important;
      padding: 17px !important;
      border-radius: 10px;
    }
    .cobblemon-section {
      background: rgba(26, 42, 26, 0.7) !important;
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      border-color: rgba(42,90,42,0.5) !important;
      padding: 17px !important;
      border-radius: 10px;
    }
    .calc-section {
      background: rgba(26, 26, 10, 0.7) !important;
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      border-color: rgba(90,90,26,0.5) !important;
      padding: 17px !important;
      border-radius: 10px;
    }
    .team-section {
      background: rgba(26, 10, 42, 0.7) !important;
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      border-color: rgba(90,42,138,0.5) !important;
      padding: 17px !important;
      border-radius: 10px;
    }
    .biome-section {
      background: rgba(10, 26, 10, 0.7) !important;
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      border-color: rgba(26,90,26,0.5) !important;
      padding: 17px !important;
      border-radius: 10px;
    }
    .welcome-card {
      background: rgba(58, 58, 58, 0.55) !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 10px;
    }
    .item-card {
      background: rgba(58, 58, 58, 0.55) !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 10px;
    }
    .apricorn-card {
      background: rgba(58, 58, 58, 0.55) !important;
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 10px;
    }

    /* Type Badges — pill-shaped with neon glow */
    .type-badge {
      border-radius: 20px !important;
      padding: 3px 14px !important;
      font-weight: 900 !important;
      font-size: 15px !important;
      letter-spacing: 1.2px !important;
      text-transform: uppercase;
      border: 1px solid rgba(255,255,255,0.18) !important;
      text-shadow: 0 1px 2px rgba(0,0,0,0.6);
    }
    .type-normal   { box-shadow: 0 0 10px rgba(168,168,120,0.5), 0 0 20px rgba(168,168,120,0.2); }
    .type-fire     { box-shadow: 0 0 10px rgba(240,128,48,0.6), 0 0 20px rgba(240,128,48,0.25); }
    .type-water    { box-shadow: 0 0 10px rgba(104,144,240,0.6), 0 0 20px rgba(104,144,240,0.25); }
    .type-electric { box-shadow: 0 0 10px rgba(248,208,48,0.6), 0 0 20px rgba(248,208,48,0.25); }
    .type-grass    { box-shadow: 0 0 10px rgba(120,200,80,0.6), 0 0 20px rgba(120,200,80,0.25); }
    .type-ice      { box-shadow: 0 0 10px rgba(152,216,216,0.6), 0 0 20px rgba(152,216,216,0.25); }
    .type-fighting { box-shadow: 0 0 10px rgba(192,48,40,0.6), 0 0 20px rgba(192,48,40,0.25); }
    .type-poison   { box-shadow: 0 0 10px rgba(160,64,160,0.6), 0 0 20px rgba(160,64,160,0.25); }
    .type-ground   { box-shadow: 0 0 10px rgba(224,192,104,0.5), 0 0 20px rgba(224,192,104,0.2); }
    .type-flying   { box-shadow: 0 0 10px rgba(168,144,240,0.6), 0 0 20px rgba(168,144,240,0.25); }
    .type-psychic  { box-shadow: 0 0 10px rgba(248,88,136,0.6), 0 0 20px rgba(248,88,136,0.25); }
    .type-bug      { box-shadow: 0 0 10px rgba(168,184,32,0.5), 0 0 20px rgba(168,184,32,0.2); }
    .type-rock     { box-shadow: 0 0 10px rgba(184,160,56,0.5), 0 0 20px rgba(184,160,56,0.2); }
    .type-ghost    { box-shadow: 0 0 10px rgba(112,88,152,0.7), 0 0 20px rgba(112,88,152,0.3); }
    .type-dragon   { box-shadow: 0 0 10px rgba(112,56,248,0.7), 0 0 20px rgba(112,56,248,0.3); }
    .type-dark     { box-shadow: 0 0 10px rgba(112,88,72,0.6), 0 0 20px rgba(112,88,72,0.25); }
    .type-steel    { box-shadow: 0 0 10px rgba(184,184,208,0.5), 0 0 20px rgba(184,184,208,0.2); }
    .type-fairy    { box-shadow: 0 0 10px rgba(238,153,172,0.6), 0 0 20px rgba(238,153,172,0.25); }

    /* Mobile: 44px min touch targets */
    @media (max-width: 768px) {
      .mc-btn, .gen-filter-btn, .tab-btn, .build-tab, .moves-tab,
      .wc-type-btn, .lang-btn, .battle-move-btn, .battle-random-btn,
      .battle-start-btn, .donate-btn, .ranking-nav-btn {
        min-height: 44px !important;
        display: inline-flex !important; align-items: center; justify-content: center;
      }
      .iv-hybrid input[type="range"], .calc-iv-hybrid input[type="range"] {
        min-height: 44px !important;
      }
      .mc-input, .calc-field, .calc-select {
        min-height: 44px !important;
      }
    }

    /* ── RANKING SECTION ── */
    .ranking-section {
      background: rgba(20, 15, 35, 0.75);
      backdrop-filter: blur(12px) saturate(150%);
      -webkit-backdrop-filter: blur(12px) saturate(150%);
      border: 3px solid rgba(90, 58, 154, 0.5);
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 12px;
    }
    .ranking-section h2 {
      font-family: 'Press Start 2P', monospace;
      font-size: 13px;
      margin-bottom: 14px;
      padding-bottom: 8px;
      border-bottom: 2px solid rgba(90,58,154,0.4);
    }
    .ranking-type-header {
      display: flex; align-items: center; gap: 12px;
      margin-bottom: 16px; padding: 10px 14px;
      background: rgba(0,0,0,0.3);
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.06);
    }
    .ranking-type-header h3 {
      font-family: 'Press Start 2P', monospace;
      font-size: 14px;
      color: var(--white);
      margin: 0;
    }
    .ranking-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 14px;
      margin-bottom: 24px;
    }
    .ranking-card {
      background: rgba(15, 12, 25, 0.8);
      border: 2px solid rgba(80, 60, 130, 0.4);
      border-radius: 12px;
      padding: 14px;
      transition: border-color 0.2s, transform 0.15s, box-shadow 0.2s;
      cursor: pointer;
      position: relative;
    }
    .ranking-card:hover {
      border-color: rgba(192, 132, 252, 0.6);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }
    .ranking-card-rank {
      position: absolute; top: 8px; right: 10px;
      font-family: 'Press Start 2P', monospace;
      font-size: 10px; color: rgba(255,170,0,0.7);
    }
    .ranking-card-header {
      display: flex; align-items: center; gap: 12px;
      margin-bottom: 10px;
    }
    .ranking-card-header img {
      width: 80px; height: 80px;
      image-rendering: auto;
      filter: drop-shadow(0 0 8px rgba(85,255,85,0.2));
    }
    .ranking-card-name {
      font-family: 'Press Start 2P', monospace;
      font-size: 12px;
      font-weight: 900;
      color: var(--white);
      text-transform: capitalize;
      margin-bottom: 4px;
    }
    .ranking-card-types {
      display: flex; gap: 4px; flex-wrap: wrap;
    }
    .ranking-card-types .type-badge {
      font-size: 11px !important; padding: 2px 8px !important;
    }
    .ranking-counters {
      border-top: 1px solid rgba(255,255,255,0.06);
      padding-top: 10px;
      margin-top: 8px;
    }
    .ranking-counters-title {
      font-size: 13px; color: var(--red);
      font-weight: 900; margin-bottom: 6px;
      display: flex; align-items: center; gap: 4px;
    }
    .ranking-counter-item {
      display: flex; align-items: center; gap: 8px;
      padding: 4px 6px; margin-bottom: 4px;
      background: rgba(40,10,10,0.4);
      border-radius: 6px;
      border: 1px solid rgba(255,85,85,0.15);
    }
    .ranking-counter-item img {
      width: 28px; height: 28px;
      image-rendering: pixelated;
    }
    .ranking-counter-name {
      font-size: 15px; font-weight: 900;
      color: var(--white); text-transform: capitalize;
      flex: 1;
    }
    .ranking-counter-reason {
      font-size: 12px; color: var(--gray);
      font-style: italic;
    }
    .ranking-build-btn {
      font-family: 'VT323', monospace;
      font-size: 18px;
      background: linear-gradient(135deg, rgba(42,90,42,0.7), rgba(26,74,26,0.7));
      color: var(--green);
      border: 1px solid rgba(85,255,85,0.3);
      border-radius: 6px;
      padding: 6px 12px;
      cursor: pointer;
      transition: all 0.15s;
      width: 100%;
      margin-top: 8px;
    }
    .ranking-build-btn:hover {
      background: linear-gradient(135deg, rgba(55,120,55,0.8), rgba(35,90,35,0.8));
      border-color: rgba(85,255,85,0.5);
    }
    .ranking-nav-btns {
      display: flex; flex-wrap: wrap; gap: 6px;
      margin-bottom: 20px; justify-content: center;
    }
    .ranking-nav-btn {
      border-radius: 16px;
      padding: 6px 14px;
      font-family: 'VT323', monospace;
      font-size: 16px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.15s;
      border: 2px solid transparent;
      color: #fff;
      text-transform: uppercase;
    }
    .ranking-nav-btn:hover { transform: scale(1.08); }
    .ranking-nav-btn.active-rank {
      border-color: var(--white);
      box-shadow: 0 0 14px rgba(255,255,255,0.35);
      transform: scale(1.1);
    }
    @media (max-width: 768px) {
      .ranking-grid { grid-template-columns: 1fr; }
      .ranking-card-header img { width: 56px; height: 56px; }
      .ranking-card-name { font-size: 10px; }
      .ranking-nav-btns { gap: 4px; }
      .ranking-nav-btn { padding: 6px 10px; font-size: 14px; }
    }
  </style>
</head>
<body>

<header>
  <button class="hamburger-btn" onclick="toggleHamburger()" title="Menu">&#9776;</button>
  <div>
    <a href="index.html" onclick="showPage('welcome');return false;" class="header-title" style="text-decoration:none;color:inherit;cursor:pointer">&#9876; Cobblemon Mastery Guide</a>
    <div class="header-subtitle">Serwerowa Baza Cobblemon &middot; Minecraft Mod</div>
  </div>
  <div class="header-right" id="header-right">
    <div class="lang-toggle">
      <button class="lang-btn active" data-lang="pl" onclick="setLang('pl')">PL</button>
      <button class="lang-btn" data-lang="en" onclick="setLang('en')">EN</button>
    </div>
    <span class="mc-badge" id="badge-gen">&#127807; Generacje 1&ndash;9</span>
    <span class="mc-badge">&#9874; PokeAPI</span>
    <a href="arena.html" class="mc-btn" id="btn-battle" style="background:#5a2a2a;border-top-color:#8a5a5a;border-left-color:#8a5a5a;text-decoration:none">&#9876; Arena Walki</a>
    <button class="mc-btn" onclick="showPage('team-analyzer')" id="btn-team">&#9876; Zespół PvP</button>
    <button class="mc-btn" onclick="showPage('ranking')" id="btn-ranking" style="background:#2a2a5a;border-top-color:#5a5a8a;border-left-color:#5a5a8a">&#127942; Ranking Typów</button>
    <button class="mc-btn" onclick="showPage('type-chart')" id="btn-typechart">&#9878; Tabela Typów</button>
    <button class="mc-btn" onclick="showPage('items')" id="btn-items">&#128230; Przedmioty</button>
    <button class="mc-btn" onclick="showPage('apricorns')" id="btn-apricorns">&#127822; Apricorny</button>
    <button class="mc-btn" onclick="showPage('welcome')" id="btn-start">&#127968; Start</button>
  </div>
</header>

<!-- SUPPORT BANNER (top bar) -->
<div id="ad-top" class="donate-section">
  <h2>💚 <span id="donate-title">Wesprzyj rozwój projektu</span></h2>
  <p id="donate-desc">Cobblemon Mastery Guide to darmowy projekt. Jeśli pomaga Ci w grze, rozważ wsparcie!</p>
  <button class="donate-btn" id="donate-btn" onclick="window.open('https://buycoffee.to/cobblemonmg','_blank')">☕ <span id="donate-btn-text">Postaw kawkę</span></button>
</div>

<!-- SIDEBAR OVERLAY (mobile) -->
<div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleHamburger()"></div>

<div class="app-layout">
  <!-- SIDEBAR -->
  <aside id="sidebar">
    <div class="sidebar-search">
      <button class="sidebar-close" onclick="toggleHamburger()" title="Zamknij">&times;</button>
      <label>&#128269; SZUKAJ POK&Eacute;MONA</label>
      <input class="mc-input" id="search-input" type="text" placeholder="np. Pikachu..." autocomplete="off" />
    </div>
    <div class="gen-filters" id="gen-filters">
      <button class="gen-filter-btn active" data-gen="0">Wszystkie</button>
      <button class="gen-filter-btn" data-gen="1">Gen I</button>
      <button class="gen-filter-btn" data-gen="2">Gen II</button>
      <button class="gen-filter-btn" data-gen="3">Gen III</button>
      <button class="gen-filter-btn" data-gen="4">Gen IV</button>
      <button class="gen-filter-btn" data-gen="5">Gen V</button>
      <button class="gen-filter-btn" data-gen="6">Gen VI</button>
      <button class="gen-filter-btn" data-gen="7">Gen VII</button>
      <button class="gen-filter-btn" data-gen="8">Gen VIII</button>
      <button class="gen-filter-btn" data-gen="9">Gen IX</button>
    </div>
    <div id="pokemon-count">Ladowanie...</div>
    <div class="pokemon-list" id="pokemon-list"></div>
  </aside>

  <!-- MAIN -->
  <main class="main-area" id="main-area"></main>
</div>

<div id="status-bar">
  <div class="spinner" id="spinner"></div>
  <span id="status-text">Ladowanie listy Pok&eacute;mon&oacute;w...</span>
</div>

<script>
/* ================================================================
   DATA
   ================================================================ */
const FRIENDSHIP_EVOS = new Set([
  'pichu','cleffa','igglybuff','togepi','chansey','golbat',
  'eevee','azurill','budew','buneary','riolu','happiny',
  'munchlax','chingling','woobat','swadloon'
]);
const FRIENDSHIP_DETAIL = {
  'pichu':'Pichu \u2192 Pikachu (wysoka przyja\u017a\u0144)',
  'cleffa':'Cleffa \u2192 Clefairy (wysoka przyja\u017a\u0144)',
  'igglybuff':'Igglybuff \u2192 Jigglypuff (wysoka przyja\u017a\u0144)',
  'togepi':'Togepi \u2192 Togetic (wysoka przyja\u017a\u0144)',
  'chansey':'Chansey \u2192 Blissey (wysoka przyja\u017a\u0144)',
  'golbat':'Golbat \u2192 Crobat (wysoka przyja\u017a\u0144)',
  'eevee':'Eevee \u2192 Espeon (dzie\u0144 + przyja\u017a\u0144) / Umbreon (noc + przyja\u017a\u0144)',
  'azurill':'Azurill \u2192 Marill (wysoka przyja\u017a\u0144)',
  'budew':'Budew \u2192 Roselia (wysoka przyja\u017a\u0144, dzie\u0144)',
  'buneary':'Buneary \u2192 Lopunny (wysoka przyja\u017a\u0144)',
  'riolu':'Riolu \u2192 Lucario (wysoka przyja\u017a\u0144, dzie\u0144)',
  'happiny':'Happiny \u2192 Chansey (niesiony Okr\u0105g\u0142y Kamie\u0144 + przyja\u017a\u0144)',
  'munchlax':'Munchlax \u2192 Snorlax (wysoka przyja\u017a\u0144)',
  'chingling':'Chingling \u2192 Chimecho (wysoka przyja\u017a\u0144, noc)',
  'woobat':'Woobat \u2192 Swoobat (wysoka przyja\u017a\u0144)',
  'swadloon':'Swadloon \u2192 Leavanny (wysoka przyja\u017a\u0144)',
};
const LINK_CABLE_EVOS = {
  'kadabra':   { result:'Alakazam', item:null },
  'machoke':   { result:'Machamp', item:null },
  'graveler':  { result:'Golem', item:null },
  'haunter':   { result:'Gengar', item:null },
  'onix':      { result:'Steelix', item:'Metal Coat' },
  'scyther':   { result:'Scizor', item:'Metal Coat' },
  'seadra':    { result:'Kingdra', item:'Dragon Scale' },
  'slowpoke':  { result:'Slowking', item:"King's Rock" },
  'poliwhirl': { result:'Politoed', item:"King's Rock" },
  'porygon':   { result:'Porygon2', item:'Up-Grade' },
  'porygon2':  { result:'Porygon-Z', item:'Dubious Disc' },
  'clamperl':  { result:'Huntail / Gorebyss', item:'Deep Sea Tooth / Deep Sea Scale' },
  'boldore':   { result:'Gigalith', item:null },
  'gurdurr':   { result:'Conkeldurr', item:null },
  'karrablast':{ result:'Escavalier', item:'wymiana z Shelmet' },
  'shelmet':   { result:'Accelgor', item:'wymiana z Karrablast' },
  'phantump':  { result:'Trevenant', item:null },
  'pumpkaboo': { result:'Gourgeist', item:null },
  'spritzee':  { result:'Aromatisse', item:'Sachet' },
  'swirlix':   { result:'Slurpuff', item:'Whipped Dream' },
  'feebas':    { result:'Milotic', item:'Prism Scale' },
};
const GEN_RANGES = [
  null,[1,151],[152,251],[252,386],[387,493],[494,649],[650,721],[722,809],[810,905],[906,1025],
];
const STAT_COLORS = {
  hp:'#ff5555', attack:'#f08030', defense:'#f8d030',
  'special-attack':'#6890f0','special-defense':'#78c850', speed:'#f85888',
};
const STAT_NAMES = {
  hp:'HP', attack:'ATK', defense:'DEF',
  'special-attack':'SpATK','special-defense':'SpDEF', speed:'SPE'
};
var NATURE_NAMES_PL = {
  'Hardy':'Twarda','Lonely':'Samotna','Brave':'Odważna','Adamant':'Zdecydowana','Naughty':'Psotna',
  'Bold':'Zuchwała','Docile':'Uległa','Relaxed':'Spokojna','Impish':'Przekorna','Lax':'Lekkomyślna',
  'Timid':'Nieśmiała','Hasty':'Pospiesszna','Serious':'Poważna','Jolly':'Wesoła','Naive':'Naiwna',
  'Modest':'Skromna','Mild':'Łagodna','Quiet':'Cicha','Bashful':'Wstydliwa','Rash':'Porywcza',
  'Calm':'Spokojna','Gentle':'Delikatna','Sassy':'Zuchwała','Careful':'Ostrożna','Quirky':'Dziwaczna'
};
function natureName(enName) {
  if (currentLang === 'pl' && NATURE_NAMES_PL[enName]) return NATURE_NAMES_PL[enName];
  return enName;
}
var ITEM_NAMES_PL = {
  'Choice Band':'Wstęga Wyboru','Choice Specs':'Okulary Wyboru','Choice Scarf':'Szalik Wyboru',
  'Life Orb':'Sfera Życia','Leftovers':'Resztki','Focus Sash':'Szarfa Skupienia',
  'Assault Vest':'Kamizelka Szturmowa','Rocky Helmet':'Skalny Hełm','Eviolite':'Eviolit',
  'Ability Shield':'Tarcza Umiejętności','Sitrus Berry':'Jagoda Sitrus','Lum Berry':'Jagoda Lum',
  'Metal Coat':'Metalowa Powłoka','Dragon Scale':'Smocza Łuska',"King's Rock":'Skała Króla',
  'Soothe Bell':'Dzwonek Łagodności',
  'Expert Belt':'Pas Eksperta','Weakness Policy':'Polityka Słabości',
  'Light Clay':'Lekka Glina','Heavy-Duty Boots':'Ciężkie Buty',
  'Toxic Orb':'Toksyczna Sfera','Flame Orb':'Płomienna Sfera',
  'Air Balloon':'Balonik','Safety Goggles':'Okulary Ochronne',
  'Mental Herb':'Zioło Psycho','Red Card':'Czerwona Kartka',
  'Scope Lens':'Luneta','White Herb':'Białe Zioło',
  'Loaded Dice':'Obciążone Kości','Throat Spray':'Spray do Gardła',
  'Protective Pads':'Ochraniacze','Covert Cloak':'Maskujący Płaszcz',
  'Black Sludge':'Czarny Szlam'
};
function itemName(enName) {
  if (currentLang === 'pl' && ITEM_NAMES_PL[enName]) return ITEM_NAMES_PL[enName];
  return enName;
}
var COMP_ITEM_DB = {
  'Choice Band':      {slug:'choice-band',      desc:{pl:'Atak \u00d71.5 \u2014 tylko jeden ruch',en:'Atk \u00d71.5 \u2014 one move only'}},
  'Choice Specs':     {slug:'choice-specs',      desc:{pl:'Sp.Atak \u00d71.5 \u2014 tylko jeden ruch',en:'SpAtk \u00d71.5 \u2014 one move only'}},
  'Choice Scarf':     {slug:'choice-scarf',      desc:{pl:'Szybko\u015b\u0107 \u00d71.5 \u2014 tylko jeden ruch',en:'Speed \u00d71.5 \u2014 one move only'}},
  'Life Orb':         {slug:'life-orb',          desc:{pl:'+30% obra\u017ce\u0144, -10% P\u017b za atak',en:'+30% damage, -10% HP per attack'}},
  'Leftovers':        {slug:'leftovers',         desc:{pl:'Regeneruje 1/16 P\u017b co tur\u0119',en:'Restores 1/16 HP per turn'}},
  'Focus Sash':       {slug:'focus-sash',        desc:{pl:'Przetrwa jeden cios z pe\u0142nego P\u017b',en:'Survives one hit at full HP'}},
  'Assault Vest':     {slug:'assault-vest',      desc:{pl:'Sp.Obr \u00d71.5 \u2014 tylko ataki',en:'SpDef \u00d71.5 \u2014 attacks only'}},
  'Rocky Helmet':     {slug:'rocky-helmet',      desc:{pl:'Zadaje 1/6 P\u017b przy kontakcie',en:'Deals 1/6 HP on contact'}},
  'Eviolite':         {slug:'eviolite',          desc:{pl:'Obr i Sp.Obr \u00d71.5 (niewyewol.)',en:'Def & SpDef \u00d71.5 (NFE)'}},
  'Expert Belt':      {slug:'expert-belt',       desc:{pl:'+20% do super-skutecznych',en:'+20% to super-effective moves'}},
  'Weakness Policy':  {slug:'weakness-policy',   desc:{pl:'+2 Atk/SpAtk po super-skut. ciosie',en:'+2 Atk/SpAtk after SE hit'}},
  'Light Clay':       {slug:'light-clay',        desc:{pl:'Reflect/L.Screen na 8 tur',en:'Reflect/L.Screen for 8 turns'}},
  'Heavy-Duty Boots': {slug:'heavy-duty-boots',  desc:{pl:'Ignoruje pu\u0142apki wej\u015bcia',en:'Ignores entry hazards'}},
  'Toxic Orb':        {slug:'toxic-orb',         desc:{pl:'Zatruwa po 1 turze (Guts)',en:'Poisons after 1 turn (Guts combo)'}},
  'Flame Orb':        {slug:'flame-orb',         desc:{pl:'Podpala po 1 turze (Guts)',en:'Burns after 1 turn (Guts combo)'}},
  'Black Sludge':     {slug:'black-sludge',      desc:{pl:'1/16 P\u017b/tur\u0119 (typy Poison)',en:'1/16 HP/turn (Poison types)'}},
  'Air Balloon':      {slug:'air-balloon',       desc:{pl:'Immunitet na Ziemi\u0119 (do trafienia)',en:'Ground immunity (until hit)'}},
  'Safety Goggles':   {slug:'safety-goggles',    desc:{pl:'Odporno\u015b\u0107 na pogod\u0119 i proszki',en:'Weather/powder immunity'}},
  'Sitrus Berry':     {slug:'sitrus-berry',      desc:{pl:'+25% P\u017b poni\u017cej 50%',en:'+25% HP below 50%'}},
  'Lum Berry':        {slug:'lum-berry',         desc:{pl:'Leczy status jednorazowo',en:'Cures status once'}},
  'Mental Herb':      {slug:'mental-herb',       desc:{pl:'Blokuje Taunt/Encore raz',en:'Blocks Taunt/Encore once'}},
  'Red Card':         {slug:'red-card',          desc:{pl:'Wymusza zmian\u0119 po trafieniu',en:'Forces switch after hit'}},
  'Scope Lens':       {slug:'scope-lens',        desc:{pl:'+1 stopie\u0144 krytycznych',en:'+1 critical hit stage'}},
  'White Herb':       {slug:'white-herb',        desc:{pl:'Resetuje obni\u017cone staty raz',en:'Resets lowered stats once'}},
  'Loaded Dice':      {slug:'loaded-dice',       desc:{pl:'Multi-hit: 4-5 trafie\u0144',en:'Multi-hit: 4-5 hits'}},
  'Protective Pads':  {slug:'protective-pads',   desc:{pl:'Blokuje efekty kontaktowe',en:'Blocks contact effects'}},
  'Covert Cloak':     {slug:'covert-cloak',      desc:{pl:'Blokuje dodatkowe efekty atak\u00f3w',en:'Blocks additional effects'}},
  'Throat Spray':     {slug:'throat-spray',      desc:{pl:'+1 SpAtk po ruchu d\u017awi\u0119kowym',en:'+1 SpAtk after sound move'}}
};
function getCompItemDesc(itemEN) {
  var entry = COMP_ITEM_DB[itemEN];
  if (!entry) return '';
  return entry.desc[currentLang] || entry.desc.en || '';
}
function getCompItemSlug(itemEN) {
  var entry = COMP_ITEM_DB[itemEN];
  if (entry) return entry.slug;
  return itemEN.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/-$/, '');
}
const TYPE_NAMES_PL = {
  normal:'Normalny',fire:'Ogie\u0144',water:'Woda',electric:'Elektryczny',grass:'Trawa',
  ice:'L\u00f3d',fighting:'Walka',poison:'Truc.',ground:'Ziemia',flying:'Lataj\u0105cy',
  psychic:'Psycho',bug:'Robak',rock:'Ska\u0142a',ghost:'Duch',dragon:'Smok',
  dark:'Mrok',steel:'Stal',fairy:'Bajkowy'
};

/* ================================================================
   LANGUAGE / TRANSLATIONS
   ================================================================ */
let currentLang = localStorage.getItem('cob_lang') || 'pl';
const TR = {
  'nav.items':       {pl:'Przedmioty',en:'Items'},
  'nav.apricorns':   {pl:'Apricorny',en:'Apricorns'},
  'nav.start':       {pl:'Start',en:'Home'},
  'nav.team':        {pl:'Zesp\u00f3\u0142 PvP',en:'PvP Team'},
  'nav.search':      {pl:'SZUKAJ POK\u00c9MONA',en:'SEARCH POK\u00c9MON'},
  'nav.subtitle':    {pl:'Serwerowa Baza Cobblemon \u00b7 Minecraft Mod',en:'Cobblemon Server Database \u00b7 Minecraft Mod'},
  'nav.genBadge':    {pl:'Generacje 1\u20139',en:'Generations 1\u20139'},
  'stat.hp':{pl:'P\u017b',en:'HP'},'stat.atk':{pl:'ATAK',en:'ATK'},'stat.def':{pl:'OBR',en:'DEF'},
  'stat.spatk':{pl:'Sp.ATAK',en:'SpATK'},'stat.spdef':{pl:'Sp.OBR',en:'SpDEF'},'stat.spe':{pl:'SZYB',en:'SPE'},
  'sec.baseStats':   {pl:'Statystyki bazowe',en:'Base Stats'},
  'sec.iv':          {pl:'Individual Values (IV)',en:'Individual Values (IV)'},
  'sec.evo':         {pl:'\u0141a\u0144cuch ewolucji',en:'Evolution Chain'},
  'evo.level':       {pl:'Poz.',en:'Lvl'},
  'evo.trade':       {pl:'Link Cable',en:'Link Cable'},
  'evo.friendship':  {pl:'Przyja\u017a\u0144',en:'Friendship'},
  'evo.day':         {pl:'Dzie\u0144',en:'Day'},
  'evo.night':       {pl:'Noc',en:'Night'},
  'evo.rain':        {pl:'Deszcz',en:'Rain'},
  'evo.male':        {pl:'\u2642 Samiec',en:'\u2642 Male'},
  'evo.female':      {pl:'\u2640 Samica',en:'\u2640 Female'},
  'evo.atkGtDef':    {pl:'ATK > DEF',en:'ATK > DEF'},
  'evo.defGtAtk':    {pl:'DEF > ATK',en:'DEF > ATK'},
  'evo.atkEqDef':    {pl:'ATK = DEF',en:'ATK = DEF'},
  'evo.move':        {pl:'Zna atak:',en:'Knows move:'},
  'evo.moveType':    {pl:'Zna atak typu:',en:'Knows move type:'},
  'evo.held':        {pl:'Trzyma:',en:'Holds:'},
  'evo.stone':       {pl:'U\u017cyj:',en:'Use:'},
  'sec.moves':       {pl:'Pe\u0142na lista atak\u00f3w',en:'Full Move List'},
  'sec.comp':        {pl:'Competitive Build',en:'Competitive Build'},
  'sec.cobblemon':   {pl:'Polecane dla Cobblemon',en:'Cobblemon Recommendations'},
  'sec.biomes':      {pl:'Habitat / Biomy',en:'Habitat / Biomes'},
  'sec.calc':        {pl:'Oce\u0144 mojego Pok\u00e9mona',en:'Rate My Pok\u00e9mon'},
  'sec.items':       {pl:'Kluczowe Przedmioty Cobblemon',en:'Key Cobblemon Items'},
  'sec.apricorns':   {pl:'Apricorny i Pok\u00e9balle',en:'Apricorns & Pok\u00e9balls'},
  'sec.team':        {pl:'Analizator Zespo\u0142u PvP',en:'PvP Team Analyzer'},
  'sec.favorites':   {pl:'Twoje Ulubione Buildy',en:'Your Favorite Builds'},
  'sec.basicData':   {pl:'Dane podstawowe',en:'Basic Data'},
  'team.search':     {pl:'Wyszukaj Pok\u00e9mona...',en:'Search Pok\u00e9mon...'},
  'team.clear':      {pl:'Wyczy\u015b\u0107 Zesp\u00f3\u0142',en:'Clear Team'},
  'team.empty':      {pl:'Kliknij aby doda\u0107',en:'Click to add'},
  'team.weak':       {pl:'S\u0142abo\u015bci zespo\u0142u',en:'Team Weaknesses'},
  'team.resist':     {pl:'Odporno\u015bci zespo\u0142u',en:'Team Resistances'},
  'team.neutral':    {pl:'Neutralne',en:'Neutral'},
  'team.immune':     {pl:'Immunitety',en:'Immunities'},
  'team.desc':       {pl:'Dodaj do 6 Pok\u00e9mon\u00f3w i sprawd\u017a pokrycie typ\u00f3w.', en:'Add up to 6 Pok\u00e9mon and check your type coverage.'},
  'det.height':      {pl:'Wzrost',en:'Height'},
  'det.weight':      {pl:'Waga',en:'Weight'},
  'det.types':       {pl:'Typy',en:'Types'},
  'det.abilities':   {pl:'Zdolno\u015bci',en:'Abilities'},
  'det.habitat':     {pl:'Habitat',en:'Habitat'},
  'det.catch':       {pl:'Wsp. \u0142apania',en:'Catch Rate'},
  'det.baseExp':     {pl:'Bazowe Do\u015bw.',en:'Base Exp.'},
  'biome.spawn':     {pl:'Pora spawnu',en:'Spawn Time'},
  'biome.day':       {pl:'Dzie\u0144',en:'Day'},
  'biome.night':     {pl:'Noc',en:'Night'},
  'biome.any':       {pl:'Dowolna',en:'Any'},
  'biome.biomes':    {pl:'Biomy Minecraft',en:'Minecraft Biomes'},
  'mv.level':        {pl:'Przez poziom',en:'Level Up'},
  'mv.tm':           {pl:'TM/TR',en:'TM/TR'},
  'mv.egg':          {pl:'Egg Moves',en:'Egg Moves'},
  'mv.power':        {pl:'MOC',en:'PWR'},
  'mv.lvl':          {pl:'Poz.',en:'Lv.'},
  'mv.attack':       {pl:'Atak',en:'Attack'},
  'mv.type':         {pl:'Typ',en:'Type'},
  'build.phys':      {pl:'Fizyczny Atakuj\u0105cy',en:'Physical Attacker'},
  'build.spec':      {pl:'Specjalny Atakuj\u0105cy',en:'Special Attacker'},
  'build.def':       {pl:'Defensywny',en:'Defensive'},
  'build.ev':        {pl:'Rozk\u0142ad EV',en:'EV Spread'},
  'build.nature':    {pl:'Natura',en:'Nature'},
  'build.item':      {pl:'Przedmiot',en:'Item'},
  'build.ability':   {pl:'Zdolno\u015b\u0107',en:'Ability'},
  'build.abilityHidden': {pl:'[ukryta]',en:'[hidden]'},
  'build.abilityRec':    {pl:'Zalecana dla tego buildu',en:'Recommended for this build'},
  'build.best4':     {pl:'Najlepsze 4 Ataki',en:'Best 4 Moves'},
  'build.copyLink':  {pl:'Kopiuj Link do Buildu',en:'Copy Build Link'},
  'build.mixed':     {pl:'Mieszany',en:'Mixed'},
  'build.support':   {pl:'Wsparcie',en:'Support'},
  'build.niche':     {pl:'Niszowy',en:'Niche'},
  'build.bestChoice': {pl:'NAJLEPSZY WYB\u00d3R',en:'BEST CHOICE'},
  'build.mainItem':  {pl:'G\u0142\u00f3wny',en:'Primary'},
  'build.altItems':  {pl:'Alternatywy',en:'Alternatives'},
  'gen.loading':     {pl:'\u0141adowanie...',en:'Loading...'},
  'gen.noResults':   {pl:'Brak wynik\u00f3w',en:'No results'},
  'gen.all':         {pl:'Wszystkie',en:'All'},
  'gen.evaluate':    {pl:'Oce\u0144!',en:'Rate!'},
  'gen.sum':         {pl:'Suma',en:'Total'},
  'gen.donate':      {pl:'Wesprzyj rozw\u00f3j projektu',en:'Support the Project'},
  'gen.coffee':      {pl:'Postaw kawk\u0119',en:'Buy a Coffee'},
  'gen.donateDesc':  {pl:'Cobblemon Mastery Guide to darmowy projekt. Je\u015bli pomaga Ci w grze, rozwa\u017c wsparcie!',en:'Cobblemon Mastery Guide is a free project. If it helps you, consider supporting us!'},
  'gen.ad':          {pl:'Miejsce na Twoj\u0105 reklam\u0119 \u2014 skontaktuj si\u0119 z nami!',en:'Your ad here \u2014 contact us!'},
  'gen.adLabel':     {pl:'REKLAMA',en:'AD'},
  'gen.pokemon':     {pl:'Pok\u00e9mon\u00f3w',en:'Pok\u00e9mon'},
  'apricorn.how':    {pl:'JAK ZBIERA\u0106 APRICORNY?',en:'HOW TO COLLECT APRICORNS?'},
  'apricorn.howDesc':{pl:'Drzewa Apricorn\u00f3w rosn\u0105 naturalnie w r\u00f3\u017cnych biomach. Zbieraj owoce i craftuj Pok\u00e9balle w Cobblemon Crafting Bench.',en:'Apricorn trees grow naturally in various biomes. Collect fruits and craft Pok\u00e9balls at the Cobblemon Crafting Bench.'},
  'welcome.what':    {pl:'Czym jest Cobblemon?',en:'What is Cobblemon?'},
  'welcome.whatDesc':{pl:'Cobblemon to mod do Minecrafta integruj\u0105cy creatury inspirowane Pok\u00e9monami. \u0141ap, trenuj i ewoluuj swoje stworzenia w \u015bwiecie Minecrafta!',en:'Cobblemon is a Minecraft mod featuring Pok\u00e9mon-inspired creatures. Catch, train and evolve your creatures in the Minecraft world!'},
  'welcome.howUse':  {pl:'Jak u\u017cywa\u0107 bazy?',en:'How to use the database?'},
  'welcome.friend':  {pl:'Przyja\u017a\u0144 (/checkfriendship)',en:'Friendship (/checkfriendship)'},
  'welcome.link':    {pl:'Link Cable (Wymiana)',en:'Link Cable (Trade)'},
  'nav.typechart':   {pl:'Kalkulator S\u0142abo\u015bci',en:'Weakness Checker'},
  'sec.typechart':   {pl:'\u2696 Kalkulator S\u0142abo\u015bci',en:'\u2696 Weakness Checker'},
  'tc.intro':        {pl:'Wybierz typ(y) swojego Pok\u00e9mona, aby sprawdzi\u0107 na co jest s\u0142aby, odporny lub ca\u0142kowicie immunizowany. Obs\u0142uguje podw\u00f3jne typy z mno\u017cnikami \u00d74!',en:'Select your Pok\u00e9mon\'s type(s) to check weaknesses, resistances and immunities. Supports dual types with \u00d74 multipliers!'},
  'tc.pickType':     {pl:'Wybierz typ',en:'Pick a type'},
  'tc.type1':        {pl:'\ud83d\udee1 TYP PIERWSZY',en:'\ud83d\udee1 PRIMARY TYPE'},
  'tc.type2':        {pl:'\ud83d\udee1 TYP DRUGI (opcjonalny)',en:'\ud83d\udee1 SECONDARY TYPE (optional)'},
  'tc.none':         {pl:'Brak',en:'None'},
  'tc.clear':        {pl:'\u2716 Wyczy\u015b\u0107',en:'\u2716 Clear'},
  'tc.critical':     {pl:'\u26a0 KRYTYCZNA S\u0141ABO\u015a\u0106 (\u00d74)',en:'\u26a0 CRITICAL WEAKNESS (\u00d74)'},
  'tc.threats':      {pl:'\ud83d\udd25 Zagro\u017cenia',en:'\ud83d\udd25 Threats'},
  'tc.resists':      {pl:'\ud83d\udee1 Odporno\u015bci',en:'\ud83d\udee1 Resistances'},
  'tc.immune':       {pl:'\ud83d\udeab Immunitet',en:'\ud83d\udeab Immunity'},
  'tc.neutral':      {pl:'Neutralne (\u00d71)',en:'Neutral (\u00d71)'},
  'tc.emptyState':   {pl:'\u2190 Wybierz typ po lewej, aby zobaczy\u0107 wyniki',en:'\u2190 Select a type above to see results'},
  'tc.analyzing':    {pl:'Analiza typ\u00f3w:',en:'Analyzing types:'},
  'tc.resX4':        {pl:'\u00d74',en:'\u00d74'},
  'tc.resX2':        {pl:'\u00d72',en:'\u00d72'},
  'tc.resHalf':      {pl:'\u00d70.5',en:'\u00d70.5'},
  'tc.resQuarter':   {pl:'\u00d70.25',en:'\u00d70.25'},
  'nav.battle':      {pl:'Arena Walki',en:'Battle Arena'},
  'battle.random':   {pl:'\ud83c\udfb2 Losuj Pok\u00e9mona',en:'\ud83c\udfb2 Random Pok\u00e9mon'},
  'battle.searchPoke':{pl:'Szukaj Pok\u00e9mona...',en:'Search Pok\u00e9mon...'},
  'battle.ivLabel':  {pl:'Individual Values (IV) \u2014 0-31',en:'Individual Values (IV) \u2014 0-31'},
  'battle.selectFirst':{pl:'Najpierw wybierz Pok\u00e9mona',en:'Select a Pok\u00e9mon first'},
  'battle.startBattle':{pl:'ROZPOCZNIJ WALK\u0118!',en:'START BATTLE!'},
  'battle.intro':    {pl:'Wybierz Pok\u00e9mony, dostosuj IV, Natur\u0119 i Zdolno\u015b\u0107, a nast\u0119pnie walcz! System automatycznie dobierze 4 najlepsze ataki.',en:'Choose Pok\u00e9mon, customize IVs, Nature and Ability, then fight! The system auto-picks the 4 best moves.'},
  'battle.yourPoke':  {pl:'\ud83d\udc64 TW\u00d3J POK\u00c9MON',en:'\ud83d\udc64 YOUR POK\u00c9MON'},
  'battle.opponent':  {pl:'\ud83c\udfaf PRZECIWNIK',en:'\ud83c\udfaf OPPONENT'},
  'battle.opponentThink':{pl:'\u23f3 Przeciwnik my\u015bli...',en:'\u23f3 Opponent is thinking...'},
  'battle.victory':  {pl:'\ud83c\udfc6 ZWYCI\u0118STWO!',en:'\ud83c\udfc6 VICTORY!'},
  'battle.defeat':   {pl:'\ud83d\udc80 PORA\u017bKA!',en:'\ud83d\udc80 DEFEAT!'},
  'battle.rematch':  {pl:'\ud83d\udd04 Rewan\u017c',en:'\ud83d\udd04 Rematch'},
  'battle.newBattle': {pl:'\u2699 Nowa Walka',en:'\u2699 New Battle'},
  'battle.knownMoves':{pl:'Znane Ataki:',en:'Known Moves:'},
  'battle.fasterOpp': {pl:'Przeciwnik jest szybszy!',en:'The opponent is faster!'},
  'battle.superEff':  {pl:'Bardzo skuteczne!',en:"It's super effective!"},
  'battle.notVeryEff':{pl:'Ma\u0142o skuteczne...',en:"It's not very effective..."},
  'battle.noEffect':  {pl:'Brak efektu!',en:'It has no effect!'},
  'battle.yourUsed':  {pl:'Tw\u00f3j %p u\u017cy\u0142 %m!',en:'Your %p used %m!'},
  'battle.oppUsed':   {pl:'Przeciwny %p u\u017cy\u0142 %m!',en:"Opponent's %p used %m!"},
  'battle.fainted':   {pl:'\ud83d\udc80 %p zemdla\u0142!',en:'\ud83d\udc80 %p fainted!'},
  'battle.yourWon':   {pl:'Tw\u00f3j %p wygra\u0142 walk\u0119!',en:'Your %p won the battle!'},
  'battle.yourLost':  {pl:'Tw\u00f3j %p zemdla\u0142!',en:'Your %p fainted!'},
  'battle.se':        {pl:'BSkut!',en:'SE!'},
  'battle.nve':       {pl:'MS',en:'NVE'},
  'battle.phys':      {pl:'Fiz',en:'Phys'},
  'battle.spec':      {pl:'Spec',en:'Spec'},
  'battle.welcomeDesc':{pl:'Symuluj walk\u0119 Pok\u00e9mon\u00f3w z pe\u0142n\u0105 mechanik\u0105 obra\u017ce\u0144, IV, Natur i typ\u00f3w!',en:'Simulate Pok\u00e9mon battles with full damage mechanics, IVs, Natures and types!'},
  'nav.ranking':      {pl:'Ranking Typ\u00f3w',en:'Type Ranking'},
  'sec.ranking':      {pl:'\ud83c\udfc6 Ranking Typ\u00f3w \u2014 Top 6 Cobblemon',en:'\ud83c\udfc6 Type Ranking \u2014 Top 6 Cobblemon'},
  'ranking.counters':  {pl:'Najlepsze Kontry',en:'Best Counters'},
  'ranking.buildBtn':  {pl:'Build & Counter-Strategy',en:'Build & Counter-Strategy'},
  'ranking.desc':      {pl:'Najlepsze Pok\u00e9mony ka\u017cdego typu z kontrstrategi\u0105. Kliknij aby za\u0142adowa\u0107 build.',en:'Best Pok\u00e9mon of each type with counter-strategy. Click to load build.'},
};
function t(key){var e=TR[key];if(!e)return key;return e[currentLang]||e['pl']||key;}

const TYPE_NAMES_EN = {
  normal:'Normal',fire:'Fire',water:'Water',electric:'Electric',grass:'Grass',
  ice:'Ice',fighting:'Fighting',poison:'Poison',ground:'Ground',flying:'Flying',
  psychic:'Psychic',bug:'Bug',rock:'Rock',ghost:'Ghost',dragon:'Dragon',
  dark:'Dark',steel:'Steel',fairy:'Fairy'
};
function typeName(n){return currentLang==='en'?(TYPE_NAMES_EN[n]||n):(TYPE_NAMES_PL[n]||n);}

/* ================================================================
   TYPE EFFECTIVENESS (DEFENSIVE)
   ================================================================ */
const TYPE_EFF = {
  normal:  {weak:['fighting'],resist:[],immune:['ghost']},
  fire:    {weak:['water','ground','rock'],resist:['fire','grass','ice','bug','steel','fairy'],immune:[]},
  water:   {weak:['electric','grass'],resist:['fire','water','ice','steel'],immune:[]},
  electric:{weak:['ground'],resist:['electric','flying','steel'],immune:[]},
  grass:   {weak:['fire','ice','poison','flying','bug'],resist:['water','electric','grass','ground'],immune:[]},
  ice:     {weak:['fire','fighting','rock','steel'],resist:['ice'],immune:[]},
  fighting:{weak:['flying','psychic','fairy'],resist:['bug','rock','dark'],immune:[]},
  poison:  {weak:['ground','psychic'],resist:['fighting','poison','bug','grass','fairy'],immune:[]},
  ground:  {weak:['water','grass','ice'],resist:['poison','rock'],immune:['electric']},
  flying:  {weak:['electric','ice','rock'],resist:['fighting','bug','grass'],immune:['ground']},
  psychic: {weak:['bug','ghost','dark'],resist:['fighting','psychic'],immune:[]},
  bug:     {weak:['fire','flying','rock'],resist:['fighting','ground','grass'],immune:[]},
  rock:    {weak:['water','grass','fighting','ground','steel'],resist:['normal','fire','poison','flying'],immune:[]},
  ghost:   {weak:['ghost','dark'],resist:['poison','bug'],immune:['normal','fighting']},
  dragon:  {weak:['ice','dragon','fairy'],resist:['fire','water','electric','grass'],immune:[]},
  dark:    {weak:['fighting','bug','fairy'],resist:['ghost','dark'],immune:['psychic']},
  steel:   {weak:['fire','fighting','ground'],resist:['normal','grass','ice','flying','psychic','bug','rock','dragon','steel','fairy'],immune:['poison']},
  fairy:   {weak:['poison','steel'],resist:['fighting','bug','dark'],immune:['dragon']}
};
const ALL_TYPES = Object.keys(TYPE_EFF);

/* ================================================================
   BIOME MAPPING
   ================================================================ */
const HABITAT_BIOMES = {
  cave:            {biomes:['Lush Caves','Dripstone Caves','Deep Dark'],icon:'\u26f0'},
  forest:          {biomes:['Forest','Birch Forest','Dark Forest','Flower Forest'],icon:'\ud83c\udf32'},
  grassland:       {biomes:['Plains','Sunflower Plains','Meadow'],icon:'\ud83c\udf3f'},
  mountain:        {biomes:['Stony Peaks','Jagged Peaks','Windswept Hills'],icon:'\ud83c\udfd4'},
  rare:            {biomes:['Deep Dark','End Highlands','Mushroom Fields'],icon:'\u2728'},
  'rough-terrain': {biomes:['Badlands','Savanna','Windswept Forest','Stony Shore'],icon:'\ud83c\udfdc'},
  sea:             {biomes:['Ocean','Deep Ocean','Warm Ocean','Lukewarm Ocean'],icon:'\ud83c\udf0a'},
  urban:           {biomes:['Plains (Villages)','Savanna (Villages)'],icon:'\ud83c\udfe0'},
  'waters-edge':   {biomes:['River','Beach','Swamp','Mangrove Swamp'],icon:'\ud83c\udfd6'}
};
function getSpawnTime(types){
  var tn=types.map(function(t){return t.type.name;});
  if(tn.includes('ghost')||tn.includes('dark'))return 'night';
  if(tn.includes('fairy')||tn.includes('psychic'))return 'day';
  if(tn.includes('bug'))return 'day';
  return 'any';
}
function buildBiomeSection(habitat,types){
  var hab=habitat?habitat.name:null;
  var biomeData=hab&&HABITAT_BIOMES[hab]?HABITAT_BIOMES[hab]:{biomes:['Plains','Forest','Meadow'],icon:'\ud83c\udf0d'};
  var spawnTime=getSpawnTime(types);
  var timeLabels={day:'\u2600 '+t('biome.day'),night:'\ud83c\udf19 '+t('biome.night'),any:'\u2600\ud83c\udf19 '+t('biome.any')};
  var biomeTags=biomeData.biomes.map(function(b){return '<span class="biome-tag">'+biomeData.icon+' '+b+'</span>';}).join('');
  var timeTag='<span class="time-tag">'+(timeLabels[spawnTime]||timeLabels['any'])+'</span>';
  return '<div class="biome-section"><h2>\ud83c\udf0d '+t('sec.biomes')+'</h2>'
    +'<div style="margin-bottom:8px;font-size:16px;color:#888">'+t('biome.biomes')+':</div>'
    +'<div class="biome-tags">'+biomeTags+'</div>'
    +'<div style="margin-top:10px;font-size:16px;color:#888">'+t('biome.spawn')+':</div>'
    +'<div class="biome-tags" style="margin-top:4px">'+timeTag+'</div></div>';
}

/* ================================================================
   TEAM ANALYZER
   ================================================================ */
const TEAM_KEY='cob_team';
let teamSlots=[];
function loadTeam(){try{var s=localStorage.getItem(TEAM_KEY);teamSlots=s?JSON.parse(s):[];}catch(e){teamSlots=[];}}
function saveTeam(){localStorage.setItem(TEAM_KEY,JSON.stringify(teamSlots));}
function clearTeam(){teamSlots=[];localStorage.removeItem(TEAM_KEY);renderTeamPage();}
function removeFromTeam(id){teamSlots=teamSlots.filter(function(s){return s.id!==id;});saveTeam();renderTeamPage();}
function computeTeamDefense(){
  var result={};
  ALL_TYPES.forEach(function(at){result[at]={weak:0,resist:0,immune:0,neutral:0};});
  teamSlots.forEach(function(slot){
    ALL_TYPES.forEach(function(at){
      var mult=1;
      slot.types.forEach(function(dt){
        if(!TYPE_EFF[dt])return;
        if(TYPE_EFF[dt].weak.includes(at))mult*=2;
        else if(TYPE_EFF[dt].resist.includes(at))mult*=0.5;
        else if(TYPE_EFF[dt].immune.includes(at))mult*=0;
      });
      if(mult===0)result[at].immune++;else if(mult>1)result[at].weak++;else if(mult<1)result[at].resist++;else result[at].neutral++;
    });
  });
  return result;
}
let teamSearchTimeout=null;
function onTeamSearch(input){
  clearTimeout(teamSearchTimeout);
  var q=input.value.trim().toLowerCase();
  var results=document.getElementById('team-search-results');
  if(q.length<2){results.classList.remove('open');return;}
  teamSearchTimeout=setTimeout(function(){
    var matches=allPokemon.filter(function(p){return p.name.includes(q)||String(p.id).includes(q);}).slice(0,8);
    if(!matches.length){results.innerHTML='<div class="team-search-item" style="color:#666">'+t('gen.noResults')+'</div>';results.classList.add('open');return;}
    results.innerHTML=matches.map(function(p){
      return '<div class="team-search-item" onclick="addTeamPokemon('+p.id+',\''+p.name+'\')">'
        +'<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/'+p.id+'.png"/>'
        +'<span>'+p.name+'</span><span style="color:#666;margin-left:auto">#'+String(p.id).padStart(3,'0')+'</span></div>';
    }).join('');
    results.classList.add('open');
  },200);
}
async function addTeamPokemon(id,name){
  if(teamSlots.length>=6||teamSlots.some(function(s){return s.id===id;}))return;
  var results=document.getElementById('team-search-results');
  results.classList.remove('open');
  document.getElementById('team-search-input').value='';
  try{
    var data=detailCache[id];
    if(!data){var res=await fetch('https://pokeapi.co/api/v2/pokemon/'+id);var p=await res.json();data={p:p};detailCache[id]=data;}
    var types=data.p.types.map(function(t){return t.type.name;});
    teamSlots.push({id:id,name:name,types:types});
    saveTeam();renderTeamPage();
  }catch(e){teamSlots.push({id:id,name:name,types:['normal']});saveTeam();renderTeamPage();}
}
function renderTeamPage(){
  var container=document.getElementById('team-analyzer-content');
  if(!container)return;
  var slotsHTML='';
  for(var i=0;i<6;i++){
    if(i<teamSlots.length){
      var slot=teamSlots[i];
      var typeBadges=slot.types.map(function(tp){return '<span class="type-badge type-'+tp+'" style="font-size:11px;padding:1px 6px">'+typeName(tp)+'</span>';}).join('');
      slotsHTML+='<div class="team-slot filled"><span class="slot-num">'+(i+1)+'</span>'
        +'<button class="slot-remove" onclick="removeFromTeam('+slot.id+')" title="Usu\u0144">\u2715</button>'
        +'<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/'+slot.id+'.png"/>'
        +'<div class="slot-name">'+slot.name+'</div>'
        +'<div class="slot-types">'+typeBadges+'</div></div>';
    }else{
      slotsHTML+='<div class="team-slot"><span class="slot-num">'+(i+1)+'</span>'
        +'<div style="color:#555;font-size:32px">+</div>'
        +'<div style="color:#555;font-size:14px">'+t('team.empty')+'</div></div>';
    }
  }
  var defenseHTML='';
  if(teamSlots.length>0){
    var analysis=computeTeamDefense();
    var weakTypes=ALL_TYPES.filter(function(tp){return analysis[tp].weak>analysis[tp].resist+analysis[tp].immune;});
    var resistTypes=ALL_TYPES.filter(function(tp){return analysis[tp].resist+analysis[tp].immune>analysis[tp].weak;});
    var immuneTypes=ALL_TYPES.filter(function(tp){return analysis[tp].immune>0;});
    var neutralTypes=ALL_TYPES.filter(function(tp){return !weakTypes.includes(tp)&&!resistTypes.includes(tp);});
    defenseHTML='<div class="defense-summary"><h3>\ud83d\udd34 '+t('team.weak')+' ('+weakTypes.length+')</h3>'
      +'<div class="defense-grid">'+weakTypes.map(function(tp){return '<div class="defense-entry defense-weak">'+typeIconHTML(tp,18)+' '+typeName(tp)+' <span style="margin-left:auto;font-size:13px">'+analysis[tp].weak+'\u00d7</span></div>';}).join('')+'</div></div>'
      +'<div class="defense-summary" style="margin-top:8px"><h3>\ud83d\udfe2 '+t('team.resist')+' ('+resistTypes.length+')</h3>'
      +'<div class="defense-grid">'+resistTypes.map(function(tp){return '<div class="defense-entry defense-resist">'+typeIconHTML(tp,18)+' '+typeName(tp)+' <span style="margin-left:auto;font-size:13px">'+analysis[tp].resist+'\u00d7</span></div>';}).join('')+'</div></div>';
    if(immuneTypes.length)defenseHTML+='<div class="defense-summary" style="margin-top:8px"><h3>\ud83d\udfe3 '+t('team.immune')+' ('+immuneTypes.length+')</h3>'
      +'<div class="defense-grid">'+immuneTypes.map(function(tp){return '<div class="defense-entry defense-immune">'+typeIconHTML(tp,18)+' '+typeName(tp)+'</div>';}).join('')+'</div></div>';
    defenseHTML+='<div class="defense-summary" style="margin-top:8px"><h3>\u26aa '+t('team.neutral')+' ('+neutralTypes.length+')</h3>'
      +'<div class="defense-grid">'+neutralTypes.map(function(tp){return '<div class="defense-entry defense-neutral">'+typeIconHTML(tp,18)+' '+typeName(tp)+'</div>';}).join('')+'</div></div>';
  }
  container.innerHTML='<div style="font-size:16px;color:#888;margin-bottom:12px">'+t('team.desc')+'</div>'
    +'<div class="team-search-wrap">'
    +'<input class="mc-input" id="team-search-input" type="text" placeholder="'+t('team.search')+'" oninput="onTeamSearch(this)" autocomplete="off"/>'
    +'<div class="team-search-results" id="team-search-results"></div></div>'
    +'<div class="team-slots">'+slotsHTML+'</div>'
    +'<div style="display:flex;gap:8px;margin-bottom:16px">'
    +'<button class="mc-btn" onclick="clearTeam()" style="background:#5a2020;border-top-color:#8a4040;border-left-color:#8a4040">\ud83d\uddd1 '+t('team.clear')+'</button></div>'
    +defenseHTML;
}

/* ================================================================
   LANGUAGE SWITCH
   ================================================================ */
function setLang(lang){
  currentLang=lang;
  localStorage.setItem('cob_lang',lang);
  document.querySelectorAll('.lang-btn').forEach(function(b){b.classList.toggle('active',b.dataset.lang===lang);});
  // Update header text
  var sub=document.querySelector('.header-subtitle');if(sub)sub.textContent=t('nav.subtitle');
  var lbl=document.querySelector('.sidebar-search label');if(lbl)lbl.textContent='\ud83d\udd0d '+t('nav.search');
  var inp=document.getElementById('search-input');if(inp)inp.placeholder=currentLang==='en'?'e.g. Pikachu...':'np. Pikachu...';
  var gb=document.getElementById('badge-gen');if(gb)gb.innerHTML='\ud83c\udf3f '+t('nav.genBadge');
  var ab=document.querySelector('.gen-filter-btn[data-gen="0"]');if(ab)ab.textContent=t('gen.all');
  var bi=document.getElementById('btn-items');if(bi)bi.innerHTML='\ud83d\udce6 '+t('nav.items');
  var ba=document.getElementById('btn-apricorns');if(ba)ba.innerHTML='\ud83c\udf4e '+t('nav.apricorns');
  var bs=document.getElementById('btn-start');if(bs)bs.innerHTML='\ud83c\udfe0 '+t('nav.start');
  var bt=document.getElementById('btn-team');if(bt)bt.innerHTML='\u2694 '+t('nav.team');
  var bc=document.getElementById('btn-typechart');if(bc)bc.innerHTML='\u2696 '+t('nav.typechart');
  var bb=document.getElementById('btn-battle');if(bb)bb.innerHTML='\u2694 '+t('nav.battle');
  var brk=document.getElementById('btn-ranking');if(brk)brk.innerHTML='\ud83c\udfc6 '+t('nav.ranking');
  // Update donate bar
  var dt=document.getElementById('donate-title');if(dt)dt.textContent=t('gen.donate');
  var dd=document.getElementById('donate-desc');if(dd)dd.textContent=t('gen.donateDesc');
  var db=document.getElementById('donate-btn-text');if(db)db.textContent=t('gen.coffee');
  // Re-render current page
  if(currentPage==='welcome')showPage('welcome');
  else if(currentPage==='items')showPage('items');
  else if(currentPage==='apricorns')showPage('apricorns');
  else if(currentPage==='team-analyzer')showPage('team-analyzer');
  else if(currentPage==='type-chart')showPage('type-chart');
  else if(currentPage==='ranking')showPage('ranking');
  else if(currentPage==='battle-sim')window.location.href='arena.html';
  else if(selectedId){var f=allPokemon.find(function(p){return p.id===selectedId;});if(f)loadDetail(f.id,f.name);}
}

const MOVE_DATA = {
  'hyper-voice':[90,'normal','S'],'boomburst':[140,'normal','S'],'body-slam':[85,'normal','P'],
  'double-edge':[120,'normal','P'],'facade':[70,'normal','P'],'return':[102,'normal','P'],
  'quick-attack':[40,'normal','P'],'extreme-speed':[80,'normal','P'],'last-resort':[140,'normal','P'],
  'swift':[60,'normal','S'],'swords-dance':[0,'normal','Z'],'rest':[0,'normal','Z'],
  'protect':[0,'normal','Z'],'substitute':[0,'normal','Z'],'recover':[0,'normal','Z'],
  'wish':[0,'normal','Z'],'belly-drum':[0,'normal','Z'],'work-up':[0,'normal','Z'],
  'slack-off':[0,'normal','Z'],'soft-boiled':[0,'normal','Z'],'milk-drink':[0,'normal','Z'],
  'shell-smash':[0,'normal','Z'],'egg-bomb':[100,'normal','P'],
  'thunderbolt':[90,'electric','S'],'thunder':[110,'electric','S'],'wild-charge':[90,'electric','P'],
  'volt-switch':[70,'electric','S'],'discharge':[80,'electric','S'],'thunder-punch':[75,'electric','P'],
  'spark':[65,'electric','P'],'rising-voltage':[70,'electric','S'],'nuzzle':[20,'electric','P'],
  'flamethrower':[90,'fire','S'],'fire-blast':[110,'fire','S'],'flare-blitz':[120,'fire','P'],
  'fire-punch':[75,'fire','P'],'mystical-fire':[75,'fire','S'],'overheat':[130,'fire','S'],
  'heat-wave':[95,'fire','S'],'will-o-wisp':[0,'fire','Z'],'burning-jealousy':[70,'fire','S'],
  'surf':[90,'water','S'],'hydro-pump':[110,'water','S'],'waterfall':[80,'water','P'],
  'scald':[80,'water','S'],'aqua-jet':[40,'water','P'],'aqua-tail':[90,'water','P'],
  'liquidation':[85,'water','P'],'flip-turn':[60,'water','P'],'rain-dance':[0,'water','Z'],
  'sparkling-aria':[90,'water','S'],'surging-strikes':[25,'water','P'],
  'moonblast':[95,'fairy','S'],'dazzling-gleam':[80,'fairy','S'],'play-rough':[90,'fairy','P'],
  'draining-kiss':[50,'fairy','S'],'disarming-voice':[40,'fairy','S'],'geomancy':[0,'fairy','Z'],
  'fleur-cannon':[130,'fairy','S'],'spirit-break':[75,'fairy','P'],'strange-steam':[90,'fairy','S'],
  'psychic':[90,'psychic','S'],'psyshock':[80,'psychic','S'],'future-sight':[120,'psychic','S'],
  'extrasensory':[80,'psychic','S'],'zen-headbutt':[80,'psychic','P'],'psybeam':[65,'psychic','S'],
  'calm-mind':[0,'psychic','Z'],'trick-room':[0,'psychic','Z'],'agility':[0,'psychic','Z'],
  'reflect':[0,'psychic','Z'],'stored-power':[20,'psychic','S'],'expanding-force':[80,'psychic','S'],
  'prismatic-laser':[160,'psychic','S'],'amnesia':[0,'psychic','Z'],'cosmic-power':[0,'psychic','Z'],
  'close-combat':[120,'fighting','P'],'aura-sphere':[80,'fighting','S'],'drain-punch':[75,'fighting','P'],
  'high-jump-kick':[130,'fighting','P'],'mach-punch':[40,'fighting','P'],'superpower':[120,'fighting','P'],
  'focus-blast':[120,'fighting','S'],'sacred-sword':[90,'fighting','P'],'bulk-up':[0,'fighting','Z'],
  'hammer-arm':[100,'fighting','P'],'thunderous-kick':[90,'fighting','P'],'vacuum-wave':[40,'fighting','S'],
  'earthquake':[100,'ground','P'],'earth-power':[90,'ground','S'],'stomping-tantrum':[75,'ground','P'],
  'dig':[80,'ground','P'],'stealth-rock':[0,'ground','Z'],'spikes':[0,'ground','Z'],
  'scorching-sands':[70,'ground','S'],'shore-up':[0,'ground','Z'],
  'energy-ball':[90,'grass','S'],'leaf-blade':[90,'grass','P'],'giga-drain':[75,'grass','S'],
  'power-whip':[120,'grass','P'],'wood-hammer':[120,'grass','P'],'leaf-storm':[130,'grass','S'],
  'solar-beam':[120,'grass','S'],'seed-bomb':[80,'grass','P'],'leech-seed':[0,'grass','Z'],
  'synthesis':[0,'grass','Z'],'grassy-glide':[70,'grass','P'],'spore':[0,'grass','Z'],
  'petal-dance':[120,'grass','S'],
  'ice-beam':[90,'ice','S'],'blizzard':[110,'ice','S'],'ice-punch':[75,'ice','P'],
  'ice-shard':[40,'ice','P'],'icicle-crash':[85,'ice','P'],'freeze-dry':[70,'ice','S'],
  'glacial-lance':[120,'ice','P'],'aurora-veil':[0,'ice','Z'],'triple-axel':[20,'ice','P'],
  'shadow-ball':[80,'ghost','S'],'phantom-force':[90,'ghost','P'],'poltergeist':[110,'ghost','P'],
  'shadow-claw':[70,'ghost','P'],'shadow-sneak':[40,'ghost','P'],'moongeist-beam':[100,'ghost','S'],
  'hex':[65,'ghost','S'],'astral-barrage':[120,'ghost','S'],'destiny-bond':[0,'ghost','Z'],
  'dark-pulse':[80,'dark','S'],'crunch':[80,'dark','P'],'knock-off':[65,'dark','P'],
  'night-slash':[70,'dark','P'],'sucker-punch':[70,'dark','P'],'throat-chop':[80,'dark','P'],
  'wicked-blow':[80,'dark','P'],'nasty-plot':[0,'dark','Z'],'taunt':[0,'dark','Z'],
  'parting-shot':[0,'dark','Z'],'night-daze':[85,'dark','S'],'darkest-lariat':[85,'dark','P'],
  'fiery-wrath':[90,'dark','S'],'lash-out':[75,'dark','P'],
  'dragon-pulse':[85,'dragon','S'],'outrage':[120,'dragon','P'],'dragon-claw':[80,'dragon','P'],
  'draco-meteor':[130,'dragon','S'],'dragon-dance':[0,'dragon','Z'],'dual-chop':[40,'dragon','P'],
  'dragon-rush':[100,'dragon','P'],'clanging-scales':[110,'dragon','S'],'eternabeam':[160,'dragon','S'],
  'iron-head':[80,'steel','P'],'flash-cannon':[80,'steel','S'],'heavy-slam':[100,'steel','P'],
  'gyro-ball':[100,'steel','P'],'meteor-mash':[90,'steel','P'],'iron-defense':[0,'steel','Z'],
  'bullet-punch':[40,'steel','P'],'sunsteel-strike':[100,'steel','P'],'steel-beam':[140,'steel','S'],
  'stone-edge':[100,'rock','P'],'rock-slide':[75,'rock','P'],'power-gem':[80,'rock','S'],
  'meteor-beam':[120,'rock','S'],'head-smash':[150,'rock','P'],
  'sludge-bomb':[90,'poison','S'],'gunk-shot':[120,'poison','P'],'poison-jab':[80,'poison','P'],
  'sludge-wave':[95,'poison','S'],'toxic':[0,'poison','Z'],'shell-side-arm':[90,'poison','S'],
  'bug-buzz':[90,'bug','S'],'leech-life':[80,'bug','P'],'x-scissor':[80,'bug','P'],
  'u-turn':[70,'bug','P'],'lunge':[80,'bug','P'],'first-impression':[90,'bug','P'],'quiver-dance':[0,'bug','Z'],
  'brave-bird':[120,'flying','P'],'hurricane':[110,'flying','S'],'air-slash':[75,'flying','S'],
  'acrobatics':[55,'flying','P'],'fly':[90,'flying','P'],'aerial-ace':[60,'flying','P'],
  'roost':[0,'flying','Z'],'tailwind':[0,'flying','Z'],'defog':[0,'flying','Z'],'dual-wingbeat':[40,'flying','P'],
};

/* ================================================================
   STATE
   ================================================================ */
let allPokemon = [];
let filteredList = [];
let selectedGen = 0;
let searchQuery = '';
let currentPage = 'welcome';
let selectedId = null;
let detailCache = {};
let listOffset = 0;
const PAGE_SIZE = 80;
const FAVORITES_KEY = 'cob_favorites';
let currentBuildIndex = 0;
let lastBuildData = null;
let rankingSelectedType = 'fire';

/* ================================================================
   TYPE RANKING DATA — Top 6 per type + Counter Picks
   ================================================================ */
const TYPE_RANKING = {
  normal:   [[143,'snorlax',['normal']],[242,'blissey',['normal']],[474,'porygon-z',['normal']],[398,'staraptor',['normal','flying']],[428,'lopunny',['normal']],[289,'slaking',['normal']]],
  fire:     [[6,'charizard',['fire','flying']],[59,'arcanine',['fire']],[257,'blaziken',['fire','fighting']],[392,'infernape',['fire','fighting']],[637,'volcarona',['bug','fire']],[815,'cinderace',['fire']]],
  water:    [[130,'gyarados',['water','flying']],[260,'swampert',['water','ground']],[350,'milotic',['water']],[658,'greninja',['water','dark']],[748,'toxapex',['water','poison']],[818,'inteleon',['water']]],
  electric: [[135,'jolteon',['electric']],[243,'raikou',['electric']],[462,'magnezone',['electric','steel']],[466,'electivire',['electric']],[807,'zeraora',['electric']],[894,'regieleki',['electric']]],
  grass:    [[3,'venusaur',['grass','poison']],[497,'serperior',['grass']],[591,'amoonguss',['grass','poison']],[598,'ferrothorn',['grass','steel']],[812,'rillaboom',['grass']],[724,'decidueye',['grass','ghost']]],
  ice:      [[131,'lapras',['water','ice']],[461,'weavile',['dark','ice']],[473,'mamoswine',['ice','ground']],[471,'glaceon',['ice']],[646,'kyurem',['dragon','ice']],[713,'avalugg',['ice']]],
  fighting: [[68,'machamp',['fighting']],[257,'blaziken',['fire','fighting']],[448,'lucario',['fighting','steel']],[534,'conkeldurr',['fighting']],[620,'mienshao',['fighting']],[892,'urshifu',['fighting','dark']]],
  poison:   [[34,'nidoking',['poison','ground']],[94,'gengar',['ghost','poison']],[452,'drapion',['poison','dark']],[591,'amoonguss',['grass','poison']],[748,'toxapex',['water','poison']],[758,'salazzle',['poison','fire']]],
  ground:   [[260,'swampert',['water','ground']],[330,'flygon',['ground','dragon']],[445,'garchomp',['dragon','ground']],[450,'hippowdon',['ground']],[530,'excadrill',['ground','steel']],[553,'krookodile',['ground','dark']]],
  flying:   [[6,'charizard',['fire','flying']],[149,'dragonite',['dragon','flying']],[227,'skarmory',['steel','flying']],[468,'togekiss',['fairy','flying']],[663,'talonflame',['fire','flying']],[823,'corviknight',['flying','steel']]],
  psychic:  [[65,'alakazam',['psychic']],[196,'espeon',['psychic']],[282,'gardevoir',['psychic','fairy']],[376,'metagross',['steel','psychic']],[579,'reuniclus',['psychic']],[858,'hatterene',['psychic','fairy']]],
  bug:      [[212,'scizor',['bug','steel']],[214,'heracross',['bug','fighting']],[416,'vespiquen',['bug','flying']],[637,'volcarona',['bug','fire']],[826,'orbeetle',['bug','psychic']],[851,'centiskorch',['fire','bug']]],
  rock:     [[142,'aerodactyl',['rock','flying']],[248,'tyranitar',['rock','dark']],[464,'rhyperior',['ground','rock']],[526,'gigalith',['rock']],[745,'lycanroc',['rock']],[839,'coalossal',['rock','fire']]],
  ghost:    [[94,'gengar',['ghost','poison']],[609,'chandelure',['ghost','fire']],[681,'aegislash',['steel','ghost']],[778,'mimikyu',['ghost','fairy']],[855,'polteageist',['ghost']],[887,'dragapult',['dragon','ghost']]],
  dragon:   [[149,'dragonite',['dragon','flying']],[373,'salamence',['dragon','flying']],[445,'garchomp',['dragon','ground']],[612,'haxorus',['dragon']],[635,'hydreigon',['dark','dragon']],[887,'dragapult',['dragon','ghost']]],
  dark:     [[248,'tyranitar',['rock','dark']],[359,'absol',['dark']],[461,'weavile',['dark','ice']],[553,'krookodile',['ground','dark']],[635,'hydreigon',['dark','dragon']],[861,'grimmsnarl',['dark','fairy']]],
  steel:    [[212,'scizor',['bug','steel']],[376,'metagross',['steel','psychic']],[462,'magnezone',['electric','steel']],[530,'excadrill',['ground','steel']],[598,'ferrothorn',['grass','steel']],[823,'corviknight',['flying','steel']]],
  fairy:    [[36,'clefable',['fairy']],[282,'gardevoir',['psychic','fairy']],[468,'togekiss',['fairy','flying']],[700,'sylveon',['fairy']],[778,'mimikyu',['ghost','fairy']],[858,'hatterene',['psychic','fairy']]]
};
const COUNTER_PICKS = {
  normal:   [{id:68,name:'machamp',r:{pl:'Walka SE + wysoki Atak',en:'Fighting SE + high Atk'}},{id:448,name:'lucario',r:{pl:'Walka/Stal odporny',en:'Fight/Steel resistant'}},{id:534,name:'conkeldurr',r:{pl:'Wysoka Obrona + Walka',en:'High Defense + Fighting'}}],
  fire:     [{id:130,name:'gyarados',r:{pl:'Wodny + wysoki Atak',en:'Water + high Atk'}},{id:260,name:'swampert',r:{pl:'Woda/Ziemia podw\u00f3jne SE',en:'Water/Ground double SE'}},{id:248,name:'tyranitar',r:{pl:'Skalny + wysoka Obrona',en:'Rock + high Defense'}}],
  water:    [{id:462,name:'magnezone',r:{pl:'Elektryczny + stalowa Obr',en:'Electric + Steel bulk'}},{id:812,name:'rillaboom',r:{pl:'Trawiasty STAB + priorytet',en:'Grass STAB + priority'}},{id:3,name:'venusaur',r:{pl:'Trawa/Trucizna odporny',en:'Grass/Poison resistant'}}],
  electric: [{id:445,name:'garchomp',r:{pl:'Ziemny immunitet',en:'Ground immunity'}},{id:530,name:'excadrill',r:{pl:'Ziemia/Stal odporny',en:'Ground/Steel resistant'}},{id:260,name:'swampert',r:{pl:'Ziemny + Wodny',en:'Ground + Water'}}],
  grass:    [{id:637,name:'volcarona',r:{pl:'Ognisty + Robak SE',en:'Fire + Bug SE'}},{id:663,name:'talonflame',r:{pl:'Ogie\u0144/Lot priorytet',en:'Fire/Flying priority'}},{id:461,name:'weavile',r:{pl:'Lodowy + szybki',en:'Ice + fast'}}],
  ice:      [{id:257,name:'blaziken',r:{pl:'Ogie\u0144/Walka SE',en:'Fire/Fight SE'}},{id:392,name:'infernape',r:{pl:'Ogie\u0144/Walka szybki',en:'Fire/Fight fast'}},{id:376,name:'metagross',r:{pl:'Stalowy odporny',en:'Steel resistant'}}],
  fighting: [{id:468,name:'togekiss',r:{pl:'Bajkowy/Lataj\u0105cy SE',en:'Fairy/Flying SE'}},{id:65,name:'alakazam',r:{pl:'Psycho + szybki',en:'Psychic + fast'}},{id:282,name:'gardevoir',r:{pl:'Psycho/Bajkowy',en:'Psychic/Fairy'}}],
  poison:   [{id:445,name:'garchomp',r:{pl:'Ziemny SE',en:'Ground SE'}},{id:65,name:'alakazam',r:{pl:'Psycho SE szybki',en:'Psychic SE fast'}},{id:530,name:'excadrill',r:{pl:'Ziemia/Stal',en:'Ground/Steel'}}],
  ground:   [{id:130,name:'gyarados',r:{pl:'Lotny immunitet + Wodny',en:'Flying immune + Water'}},{id:598,name:'ferrothorn',r:{pl:'Trawiasty/Stalowy',en:'Grass/Steel'}},{id:461,name:'weavile',r:{pl:'Lodowy szybki',en:'Ice fast'}}],
  flying:   [{id:462,name:'magnezone',r:{pl:'Elektryczny + Stal',en:'Electric + Steel'}},{id:461,name:'weavile',r:{pl:'Lodowy szybki',en:'Ice fast'}},{id:248,name:'tyranitar',r:{pl:'Skalny SE',en:'Rock SE'}}],
  psychic:  [{id:212,name:'scizor',r:{pl:'Robak/Stal + priorytet',en:'Bug/Steel + priority'}},{id:94,name:'gengar',r:{pl:'Duch SE szybki',en:'Ghost SE fast'}},{id:248,name:'tyranitar',r:{pl:'Mroczny + wysoka Obr',en:'Dark + high Def'}}],
  bug:      [{id:6,name:'charizard',r:{pl:'Ogie\u0144/Lot SE',en:'Fire/Flying SE'}},{id:663,name:'talonflame',r:{pl:'Ogie\u0144/Lot priorytet',en:'Fire/Flying priority'}},{id:248,name:'tyranitar',r:{pl:'Skalny SE',en:'Rock SE'}}],
  rock:     [{id:260,name:'swampert',r:{pl:'Woda/Ziemia SE',en:'Water/Ground SE'}},{id:598,name:'ferrothorn',r:{pl:'Trawa/Stal SE',en:'Grass/Steel SE'}},{id:448,name:'lucario',r:{pl:'Walka/Stal SE',en:'Fight/Steel SE'}}],
  ghost:    [{id:94,name:'gengar',r:{pl:'Duch SE szybki',en:'Ghost SE fast'}},{id:248,name:'tyranitar',r:{pl:'Mroczny SE + tank',en:'Dark SE + tank'}},{id:461,name:'weavile',r:{pl:'Mroczny + szybki',en:'Dark + fast'}}],
  dragon:   [{id:461,name:'weavile',r:{pl:'Lodowy + szybki',en:'Ice + fast'}},{id:468,name:'togekiss',r:{pl:'Bajkowy immunitet',en:'Fairy immunity'}},{id:282,name:'gardevoir',r:{pl:'Bajkowy SE',en:'Fairy SE'}}],
  dark:     [{id:448,name:'lucario',r:{pl:'Walka/Stal SE',en:'Fight/Steel SE'}},{id:212,name:'scizor',r:{pl:'Robak SE + priorytet',en:'Bug SE + priority'}},{id:282,name:'gardevoir',r:{pl:'Bajkowy SE',en:'Fairy SE'}}],
  steel:    [{id:257,name:'blaziken',r:{pl:'Ogie\u0144/Walka SE',en:'Fire/Fight SE'}},{id:445,name:'garchomp',r:{pl:'Ziemny SE',en:'Ground SE'}},{id:392,name:'infernape',r:{pl:'Ogie\u0144/Walka szybki',en:'Fire/Fight fast'}}],
  fairy:    [{id:94,name:'gengar',r:{pl:'Trucizna SE + szybki',en:'Poison SE + fast'}},{id:376,name:'metagross',r:{pl:'Stal SE + wysoki Atak',en:'Steel SE + high Atk'}},{id:530,name:'excadrill',r:{pl:'Stal SE + Ziemia',en:'Steel SE + Ground'}}]
};

/* ================================================================
   FAVORITES
   ================================================================ */
function getFavorites() {
  try { return JSON.parse(localStorage.getItem(FAVORITES_KEY)) || []; }
  catch(e) { return []; }
}
function isFavorite(id) { return getFavorites().some(function(f){ return f.id === id; }); }
function toggleFavorite(id, name) {
  var favs = getFavorites();
  var idx = -1;
  for (var i = 0; i < favs.length; i++) { if (favs[i].id === id) { idx = i; break; } }
  if (idx >= 0) favs.splice(idx, 1);
  else favs.push({ id: id, name: name });
  localStorage.setItem(FAVORITES_KEY, JSON.stringify(favs));
  var star = document.getElementById('fav-star-btn');
  if (star) star.classList.toggle('active', isFavorite(id));
}
function renderFavoritesSection() {
  var favs = getFavorites();
  if (!favs.length) {
    return '<div class="welcome-card"><h3>\u2b50 Twoje Ulubione Buildy</h3><p>Kliknij gwiazdk\u0119 \u2b50 obok nazwy Pok\u00e9mona, aby doda\u0107 go do ulubionych.</p></div>';
  }
  var cards = favs.map(function(f){
    return '<div class="fav-card" onclick="loadDetail('+f.id+',\''+f.name+'\')">' +
      '<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/'+f.id+'.png" alt="'+f.name+'"/>' +
      '<span>'+f.name+'</span></div>';
  }).join('');
  return '<div class="welcome-card" style="grid-column:1/-1"><h3>\u2b50 Twoje Ulubione Buildy</h3><div class="fav-grid">'+cards+'</div></div>';
}

/* ================================================================
   HAMBURGER
   ================================================================ */
function toggleHamburger() {
  document.getElementById('sidebar').classList.toggle('mobile-open');
  document.getElementById('sidebar-overlay').classList.toggle('active');
}

/* ================================================================
   COPY BUILD LINK
   ================================================================ */
function copyBuildLink() {
  var url = window.location.origin + window.location.pathname + (selectedId ? '#pokemon-'+selectedId : '');
  if (navigator.clipboard && navigator.clipboard.writeText) {
    navigator.clipboard.writeText(url).then(function(){
      var btn = document.getElementById('copy-link-btn');
      if(btn){btn.textContent='\u2705 Skopiowano!';setTimeout(function(){btn.textContent='\ud83d\udd17 Kopiuj Link do Buildu';},2000);}
    }).catch(function(){
      cobFallbackCopy(url);
    });
  } else {
    cobFallbackCopy(url);
  }
}
function cobFallbackCopy(url) {
  try {
    var ta = document.createElement('textarea');ta.value=url;document.body.appendChild(ta);ta.select();document.execCommand('copy');document.body.removeChild(ta);
    var btn = document.getElementById('copy-link-btn');
    if(btn){btn.textContent='\u2705 Skopiowano!';setTimeout(function(){btn.textContent='\ud83d\udd17 Kopiuj Link do Buildu';},2000);}
  } catch(e) {}
}

/* ================================================================
   INIT
   ================================================================ */
async function init() {
  // ── Cache versioning: clear stale data on version bump ──
  var COB_VERSION = '2.1';
  try {
    var storedVer = localStorage.getItem('cob_version');
    if (storedVer !== COB_VERSION) {
      localStorage.removeItem('cob_pokemon_list');
      localStorage.setItem('cob_version', COB_VERSION);
    }
  } catch(e) {}

  // Load saved language
  currentLang = localStorage.getItem('cob_lang') || 'pl';
  document.querySelectorAll('.lang-btn').forEach(function(b){b.classList.toggle('active',b.dataset.lang===currentLang);});
  // Load saved team
  loadTeam();

  setStatus((currentLang==='en'?'Fetching Pok\u00e9mon list from PokeAPI...':'Pobieranie listy Pok\u00e9mon\u00f3w z PokeAPI...'), true);
  var cached = localStorage.getItem('cob_pokemon_list');
  if (cached) {
    allPokemon = JSON.parse(cached);
    setStatus((currentLang==='en'?'Loaded ':'Za\u0142adowano ')+allPokemon.length+(currentLang==='en'?' Pok\u00e9mon from cache.':' Pok\u00e9mon\u00f3w z cache.'), false);
  } else {
    try {
      var res = await fetch('https://pokeapi.co/api/v2/pokemon?limit=10000');
      var data = await res.json();
      allPokemon = data.results.map(function(p){
        var parts = p.url.split('/').filter(Boolean);
        var id = parseInt(parts[parts.length - 1]);
        return { id: id, name: p.name };
      }).filter(function(p){ return p.id <= 1025; });
      localStorage.setItem('cob_pokemon_list', JSON.stringify(allPokemon));
      setStatus((currentLang==='en'?'Loaded ':'Za\u0142adowano ')+allPokemon.length+(currentLang==='en'?' Pok\u00e9mon.':' Pok\u00e9mon\u00f3w.'), false);
    } catch (e) {
      setStatus((currentLang==='en'?'Connection error with PokeAPI!':'B\u0142\u0105d po\u0142\u0105czenia z PokeAPI!'), false);
    }
  }
  // Apply saved language to header elements
  if(currentLang==='en')setLang('en');
  applyFilters();
  showPage('welcome');
  // Clear loading timeout – page loaded successfully
  if (window._cobClearLoadTimer) window._cobClearLoadTimer();
  // Check hash for deep link
  if (window.location.hash.startsWith('#pokemon-')) {
    var hid = parseInt(window.location.hash.replace('#pokemon-',''));
    if (hid) { var found = allPokemon.find(function(p){return p.id===hid;}); if(found) loadDetail(found.id, found.name); }
  }
}

/* ================================================================
   FILTERS
   ================================================================ */
function applyFilters() {
  var q = searchQuery.trim().toLowerCase();
  filteredList = allPokemon.filter(function(p) {
    if (selectedGen > 0) {
      var range = GEN_RANGES[selectedGen];
      if (p.id < range[0] || p.id > range[1]) return false;
    }
    if (q) return p.name.includes(q) || String(p.id).includes(q);
    return true;
  });
  listOffset = 0;
  renderList();
}

function renderList() {
  var container = document.getElementById('pokemon-list');
  document.getElementById('pokemon-count').textContent = filteredList.length + ' ' + t('gen.pokemon');
  if (!filteredList.length) {
    container.innerHTML = '<div class="empty-state"><span class="big-icon">\ud83d\udd0d</span>'+t('gen.noResults')+'</div>';
    return;
  }
  var chunk = filteredList.slice(0, listOffset + PAGE_SIZE);
  container.innerHTML = '';
  chunk.forEach(function(p) {
    var div = document.createElement('div');
    div.className = 'pokemon-entry' + (p.id === selectedId ? ' selected' : '');
    div.dataset.id = p.id;
    var hasFriendship = FRIENDSHIP_EVOS.has(p.name);
    var hasTrade = p.name in LINK_CABLE_EVOS;
    div.innerHTML = '<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/'+p.id+'.png" onerror="this.src=\'data:image/svg+xml,<svg xmlns=\\\'http://www.w3.org/2000/svg\\\'/>\'" />'
      + '<span class="entry-name">'+p.name+'</span>'
      + '<span class="entry-id">#'+String(p.id).padStart(3,'0')+'</span>'
      + '<div class="entry-badges">'
      + (hasFriendship ? '<span class="badge-friendship" title="Ewolucja przez przyja\u017a\u0144">\u2665</span>' : '')
      + (hasTrade ? '<span class="badge-trade" title="Ewolucja przez wymian\u0119 (Link Cable)">\u21c4</span>' : '')
      + '</div>';
    div.addEventListener('click', function(){ loadDetail(p.id, p.name); });
    container.appendChild(div);
  });
  if (chunk.length < filteredList.length) {
    var sentinel = document.createElement('div');
    sentinel.style.cssText = 'height:4px';
    sentinel.id = 'list-sentinel';
    container.appendChild(sentinel);
    var obs = new IntersectionObserver(function(entries){
      if (entries[0].isIntersecting) { obs.disconnect(); listOffset += PAGE_SIZE; renderList(); }
    });
    obs.observe(sentinel);
  }
}

/* ================================================================
   DETAIL
   ================================================================ */
async function loadDetail(id, name) {
  selectedId = id;
  document.querySelectorAll('.pokemon-entry').forEach(function(el){
    el.classList.toggle('selected', parseInt(el.dataset.id) === id);
  });
  // close mobile menu
  document.getElementById('sidebar').classList.remove('mobile-open');
  document.getElementById('sidebar-overlay').classList.remove('active');
  showPage('detail-loading');
  setStatus('Pobieranie danych: '+name+'...', true);
  try {
    var data = detailCache[id];
    if (!data) {
      var results = await Promise.all([
        fetch('https://pokeapi.co/api/v2/pokemon/'+id),
        fetch('https://pokeapi.co/api/v2/pokemon-species/'+id)
      ]);
      var p = await results[0].json();
      var s = await results[1].json();
      data = { p:p, s:s };
      detailCache[id] = data;
    }
    // Fetch ability details
    if (!data.abilityDetails) {
      try {
        var abilityPromises = data.p.abilities.map(function(a){
          return fetch('https://pokeapi.co/api/v2/ability/'+a.ability.name).then(function(r){return r.json();});
        });
        data.abilityDetails = await Promise.all(abilityPromises);
      } catch(e2) { data.abilityDetails = []; }
      detailCache[id] = data;
    }
    var evoChainUrl = data.s.evolution_chain ? data.s.evolution_chain.url : null;
    var evoChain = null;
    if (evoChainUrl) { var evoRes = await fetch(evoChainUrl); evoChain = await evoRes.json(); }
    renderDetail(data.p, data.s, evoChain, name, data.abilityDetails);
    setStatus('#'+String(id).padStart(3,'0')+' '+name, false);
    window.location.hash = 'pokemon-'+id;
  } catch(e) {
    setStatus('B\u0142\u0105d podczas pobierania danych.', false);
    document.getElementById('main-area').innerHTML = '<div class="empty-state"><span class="big-icon">\u26a0</span>B\u0142\u0105d po\u0142\u0105czenia z PokeAPI.</div>';
  }
}

/* ================================================================
   TYPE ICON HELPER
   ================================================================ */
function typeIconHTML(tpName, size) {
  size = size || 20;
  // Use colored circle badges as type icons
  var colors = {
    normal:'#a8a878',fire:'#f08030',water:'#6890f0',electric:'#f8d030',grass:'#78c850',
    ice:'#98d8d8',fighting:'#c03028',poison:'#a040a0',ground:'#e0c068',flying:'#a890f0',
    psychic:'#f85888',bug:'#a8b820',rock:'#b8a038',ghost:'#705898',dragon:'#7038f8',
    dark:'#705848',steel:'#b8b8d0',fairy:'#ee99ac'
  };
  var c = colors[tpName] || '#888';
  var label = typeName(tpName).substring(0,3).toUpperCase();
  return '<span style="display:inline-block;width:'+size+'px;height:'+size+'px;border-radius:50%;background:'+c+';text-align:center;line-height:'+size+'px;font-size:'+(size*0.5)+'px;color:#fff;font-family:VT323,monospace;vertical-align:middle;margin-right:2px;border:1px solid rgba(0,0,0,0.3)" title="'+typeName(tpName)+'">'+label+'</span>';
}

/* ================================================================
   RENDER DETAIL
   ================================================================ */
function renderDetail(p, s, evoChain, name, abilityDetails) {
  var isFriendship = FRIENDSHIP_EVOS.has(p.name);
  var isTradeEvo = p.name in LINK_CABLE_EVOS;
  var flavor = '';
  if (s.flavor_text_entries) {
    var fe = s.flavor_text_entries.find(function(f){return f.language.name==='en';});
    if (fe) flavor = fe.flavor_text.replace(/\f/g,' ');
  }

  // ── IV helpers ──
  function getIVColor(iv) { return iv>=28?'#55ff55':iv>=20?'#f8d030':iv>=10?'#f08030':'#ff5555'; }
  function getIVLabel(iv) {
    if(iv>=28) return '<span style="color:#55ff55">Doskona\u0142e</span>';
    if(iv>=20) return '<span style="color:#f8d030">Dobre</span>';
    if(iv>=10) return '<span style="color:#f08030">S\u0142abe</span>';
    return '<span style="color:#ff5555">Z\u0142e</span>';
  }

  function buildIVSection(stats) {
    var statMap = {}; stats.forEach(function(s){statMap[s.stat.name]=s.base_stat;});
    var atk=statMap['attack']||0, spatk=statMap['special-attack']||0, def=statMap['defense']||0, spdef=statMap['special-defense']||0, spe=statMap['speed']||0, hp=statMap['hp']||0;
    var isPhysical=atk>=spatk+15,isSpecial=spatk>=atk+15,isMixed=!isPhysical&&!isSpecial,isTank=(def+spdef)/2>=90&&spe<80,isSpeedy=spe>=80,isTrickRoom=spe<=50;
    var role='\u2696 Zbalansowany';
    if(isPhysical&&isSpeedy)role='\u2694 Fizyczny Atakuj\u0105cy';else if(isPhysical&&isTank)role='\ud83d\udee1 Fizyczny Tank';else if(isPhysical)role='\u2694 Fizyczny';else if(isSpecial&&isSpeedy)role='\u2728 Specjalny Atakuj\u0105cy';else if(isSpecial&&isTank)role='\ud83d\udd2e Specjalny Tank';else if(isSpecial)role='\u2728 Specjalny';else if(isTank)role='\ud83d\udee1 Tank';else if(isSpeedy)role='\ud83d\udca8 Szybko\u015bciowy';else if(isMixed)role='\u2694\u2728 Mieszany';
    var targets={};
    targets['hp']={val:'31',color:'#55ff55',prio:true,note:'Zawsze przydatne'};
    if(isTrickRoom)targets['speed']={val:'0',color:'#aaa',prio:false,note:'Trick Room'};else if(isSpeedy)targets['speed']={val:'31',color:'#55ff55',prio:true,note:'Kluczowe'};else targets['speed']={val:'\u226520',color:'#f8d030',prio:false,note:'Pomocne'};
    if(isPhysical||isMixed)targets['attack']={val:'31',color:'#55ff55',prio:true,note:'G\u0142\u00f3wne \u017ar\u00f3d\u0142o obra\u017ce\u0144'};else targets['attack']={val:'0',color:'#888',prio:false,note:'Nie u\u017cywasz'};
    if(isSpecial||isMixed)targets['special-attack']={val:'31',color:'#55ff55',prio:true,note:'G\u0142\u00f3wne \u017ar\u00f3d\u0142o obra\u017ce\u0144'};else targets['special-attack']={val:'0',color:'#888',prio:false,note:'Nie u\u017cywasz'};
    if(isTank||def>=100)targets['defense']={val:'31',color:'#55ff55',prio:true,note:'Warto maksowa\u0107'};else targets['defense']={val:'\u226520',color:'#f8d030',prio:false,note:'Przydatne'};
    if(isTank||spdef>=100)targets['special-defense']={val:'31',color:'#55ff55',prio:true,note:'Warto maksowa\u0107'};else targets['special-defense']={val:'\u226520',color:'#f8d030',prio:false,note:'Przydatne'};
    var mustBe31=['hp','attack','defense','special-attack','special-defense','speed'].filter(function(sn){return targets[sn].val==='31';}).map(function(sn){return '<span style="color:'+(STAT_COLORS[sn]||'#fff')+'">'+STAT_NAMES[sn]+'</span>';});
    var mustBe0=['attack','special-attack','speed'].filter(function(sn){return targets[sn].val==='0';}).map(function(sn){return '<span style="color:#888">'+STAT_NAMES[sn]+'</span>';});
    var summaryLine='Celuj w <b style="color:#55ff55">31</b>: '+mustBe31.join(', ');
    if(mustBe0.length)summaryLine+='<br>Zostaw na <b style="color:#888">0</b>: '+mustBe0.join(', ');
    var ORDER=['hp','attack','defense','special-attack','special-defense','speed'];
    var rows=ORDER.map(function(sn){
      var label=STAT_NAMES[sn]||sn;var color=STAT_COLORS[sn]||'#888';var t=targets[sn];
      var rowClass=t.prio?'iv-row iv-row-priority':'iv-row';var prioIcon=t.prio?'\u2b50':'\u25aa';
      var defaultVal=t.val==='0'?0:31;
      return '<div class="'+rowClass+'" id="iv-row-'+sn+'">'
        +'<span class="iv-priority" title="'+t.note+'">'+prioIcon+'</span>'
        +'<span class="iv-name" style="color:'+color+'">'+label+'</span>'
        +'<div class="iv-hybrid" data-stat="'+sn+'">' 
        +'<input type="range" min="0" max="31" value="'+defaultVal+'" oninput="syncIVHybrid(this,\'range\')" />' 
        +'<input class="iv-input" type="number" min="0" max="31" value="'+defaultVal+'" data-stat="'+sn+'" oninput="syncIVHybrid(this,\'number\')" />' 
        +'</div>'
        +'<div class="iv-bar-wrap"><div class="iv-bar" id="ivbar-'+sn+'" style="width:'+Math.round(defaultVal/31*100)+'%;background:'+getIVColor(defaultVal)+'"></div></div>'
        +'<div class="iv-target" style="color:'+t.color+'" title="'+t.note+'">CEL: '+t.val+'</div>'
        +'<div class="iv-label" id="ivlabel-'+sn+'">'+getIVLabel(defaultVal)+'</div></div>';
    }).join('');
    return '<div class="iv-section"><h2>\ud83c\udfb2 Individual Values (IV) <span style="font-size:11px;color:#aaa;font-family:VT323,monospace">skala 0\u201331</span></h2>'
      +'<div class="iv-role-badge">Rola: '+role+'</div>'
      +'<div class="iv-summary">'+summaryLine+'</div>'
      +'<div style="font-size:14px;color:#666;margin-bottom:6px">\u2b50 priorytet | \u25aa mniej wa\u017cne | Zmie\u0144 liczby \u017ceby sprawdzi\u0107</div>'
      +rows
      +'<div class="iv-legend">'
      +'<div class="iv-legend-item"><div class="iv-legend-dot" style="background:#55ff55"></div>28\u201331 Doskona\u0142e</div>'
      +'<div class="iv-legend-item"><div class="iv-legend-dot" style="background:#f8d030"></div>20\u201327 Dobre</div>'
      +'<div class="iv-legend-item"><div class="iv-legend-dot" style="background:#f08030"></div>10\u201319 S\u0142abe</div>'
      +'<div class="iv-legend-item"><div class="iv-legend-dot" style="background:#ff5555"></div>0\u20139 Z\u0142e</div>'
      +'</div></div>';
  }

  // ── ROLE DETECTION ──
  function detectRole(statMap) {
    var atk=statMap['attack']||0,spatk=statMap['special-attack']||0,def=statMap['defense']||0,spdef=statMap['special-defense']||0,spe=statMap['speed']||0,hp=statMap['hp']||0;
    var isPhys=atk>=spatk+15,isSpec=spatk>=atk+15,isMixed=!isPhys&&!isSpec,isTank=(def+spdef)/2>=90&&spe<80,isFast=spe>=80,isTR=spe<=50;
    var label='\u2696 Zbalansowany';
    if(isPhys&&isFast)label='\u2694 Fizyczny Atakuj\u0105cy';else if(isPhys&&isTank)label='\ud83d\udee1 Fizyczny Tank';else if(isPhys)label='\u2694 Fizyczny (wolny)';else if(isSpec&&isFast)label='\u2728 Specjalny Atakuj\u0105cy';else if(isSpec&&isTank)label='\ud83d\udd2e Specjalny Tank';else if(isSpec)label='\u2728 Specjalny (wolny)';else if(isTank)label='\ud83d\udee1 Tank';else if(isFast)label='\ud83d\udca8 Szybki Mieszany';else label='\u2694\u2728 Mieszany';
    return {atk:atk,spatk:spatk,def:def,spdef:spdef,spe:spe,hp:hp,isPhys:isPhys,isSpec:isSpec,isMixed:isMixed,isTank:isTank,isFast:isFast,isTR:isTR,label:label};
  }

  // ── BUILD GENERATOR ──
  // ── ABILITY RECOMMENDATION LOGIC ──
  var ABILITY_PREF = {
    physical: ['huge-power','pure-power','tough-claws','sheer-force','iron-fist','moxie','technician','skill-link','guts','sand-rush','swift-swim','chlorophyll','reckless','adaptability','hustle','strong-jaw','no-guard','scrappy','defiant','intrepid-sword'],
    special: ['adaptability','download','soul-heart','beast-boost','serene-grace','sheer-force','magic-guard','protean','libero','tinted-lens','drought','drizzle','electric-surge','psychic-surge','grassy-surge','misty-surge','transistor','dragons-maw','compound-eyes'],
    defensive: ['regenerator','multiscale','magic-bounce','magic-guard','unaware','natural-cure','sturdy','intimidate','imposter','poison-heal','thick-fat','water-absorb','volt-absorb','flash-fire','levitate','marvel-scale','fur-coat','ice-scales','prankster','heatproof'],
    mixed: ['protean','libero','adaptability','sheer-force','download','beast-boost','soul-heart','galvanize','pixilate','refrigerate','aerilate','tough-claws','hustle','no-guard'],
    support: ['prankster','regenerator','magic-bounce','natural-cure','intimidate','drizzle','drought','snow-warning','sand-stream','unaware','poison-heal','levitate','thick-fat','serene-grace','synchronize','trace','healer'],
    niche: ['speed-boost','contrary','magic-guard','simple','moody','disguise','wonder-guard','huge-power','pure-power','gorilla-tactics','ice-scales','fur-coat','skill-link','technician']
  };

  function pickAbility(pokemonAbilities, abilityDetails, buildType) {
    var prefs = ABILITY_PREF[buildType] || [];
    var abilities = pokemonAbilities || [];
    var details = abilityDetails || [];
    // Score each ability
    var scored = abilities.map(function(a, idx) {
      var slug = a.ability.name;
      var prefIdx = prefs.indexOf(slug);
      var score = prefIdx !== -1 ? (prefs.length - prefIdx) : 0;
      if (a.is_hidden && score > 0) score += 5; // hidden competitive abilities are often best
      if (!a.is_hidden && score === 0) score = 1; // prefer non-hidden as baseline
      var detail = details[idx] || null;
      return { slug: slug, isHidden: a.is_hidden, score: score, detail: detail };
    });
    scored.sort(function(a, b) { return b.score - a.score; });
    return scored[0] || null;
  }

  function getAbilityText(abilityDetail) {
    if (!abilityDetail) return { name: '?', desc: '' };
    var eName = abilityDetail.name || '?';
    // Get localized name
    var nameEntry;
    if (currentLang === 'pl') {
      nameEntry = (abilityDetail.names || []).find(function(n){ return n.language.name === 'pl'; });
    }
    if (!nameEntry) nameEntry = (abilityDetail.names || []).find(function(n){ return n.language.name === 'en'; });
    var displayName = nameEntry ? nameEntry.name : eName.replace(/-/g, ' ');
    // Get localized description
    var descEntry;
    var langCode = currentLang === 'pl' ? 'pl' : 'en';
    var flavorEntries = abilityDetail.flavor_text_entries || [];
    descEntry = flavorEntries.filter(function(f){ return f.language.name === langCode; }).pop();
    if (!descEntry && langCode === 'pl') descEntry = flavorEntries.filter(function(f){ return f.language.name === 'en'; }).pop();
    var desc = descEntry ? descEntry.flavor_text.replace(/\n/g, ' ').replace(/\f/g, ' ') : '';
    return { name: displayName, desc: desc };
  }

  function renderItemBox(mainItem, altItems) {
    var mainSlug = getCompItemSlug(mainItem);
    var mainDesc = getCompItemDesc(mainItem);
    var mainName = itemName(mainItem);
    var mainImg = '<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/'+mainSlug+'.png" onerror="this.parentNode.innerHTML=\'<span style=color:#555;font-size:32px>\u25a1</span>\'" style="width:48px;height:48px" />';
    var mainHTML = '<div class="item-main">' +
      '<div class="item-main-label">\ud83d\udd39 '+t('build.mainItem')+'</div>' +
      '<div style="margin:6px 0">'+mainImg+'</div>' +
      '<div class="item-big-name">'+mainName+'</div>' +
      (mainName !== mainItem ? '<div style="font-size:11px;color:#555">('+mainItem+')</div>' : '') +
      '<div class="item-big-desc">'+mainDesc+'</div></div>';
    var altsHTML = '';
    if (altItems && altItems.length > 0) {
      var altCards = altItems.map(function(ai) {
        var aSlug = getCompItemSlug(ai);
        var aName = itemName(ai);
        var aDesc = getCompItemDesc(ai);
        var aImg = '<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/'+aSlug+'.png" onerror="this.style.display=\'none\'" style="width:24px;height:24px" />';
        return '<div class="item-alt-card">' + aImg +
          '<div class="item-alt-info"><div class="item-alt-name">'+aName+'</div>' +
          (aName !== ai ? '<div style="font-size:10px;color:#555">('+ai+')</div>' : '') +
          '<div class="item-alt-desc">'+aDesc+'</div></div></div>';
      }).join('');
      altsHTML = '<div class="item-alt-section">' +
        '<div class="item-alt-label">'+t('build.altItems')+'</div>' +
        '<div class="item-alt-grid">' + altCards + '</div></div>';
    }
    return '<div class="comp-box"><div class="comp-box-title">\ud83d\udce6 '+t('build.item')+'</div>' +
      '<div class="item-layout">' + mainHTML + altsHTML + '</div></div>';
  }

  function generateBuild(statMap, pokemonTypes, moves, buildType, pokemonAbilities, abilityDetails) {
    var r = detectRole(statMap);
    var spread, note, nName, nUp, nDown, nWhy, item, altItems;
    if (buildType === 'physical') {
      if(r.isFast) spread=[['attack',252],['speed',252],['hp',4]]; else spread=[['attack',252],['hp',252],['defense',4]];
      note=currentLang==='en'?'Max physical damage.':'Maksuj fizyczne obra\u017cenia.';
      if(r.isFast){nName='Jolly';nUp='+Szybk.';nDown='-Sp.Atak';nWhy=currentLang==='en'?'Faster without losing Atk':'Szybszy bez straty Ataku';}
      else{nName='Adamant';nUp='+Atak';nDown='-Sp.Atak';nWhy=currentLang==='en'?'Max Atk':'Maks Atak';}
      if(r.spe>=100){item='Choice Band';altItems=['Life Orb','Focus Sash'];}
      else{item='Life Orb';altItems=['Choice Band','Assault Vest'];}
    } else if (buildType === 'special') {
      if(r.isFast) spread=[['special-attack',252],['speed',252],['hp',4]]; else spread=[['special-attack',252],['hp',252],['special-defense',4]];
      note=currentLang==='en'?'Max special damage.':'Maksuj specjalne obra\u017cenia.';
      if(r.isFast){nName='Timid';nUp='+Szybk.';nDown='-Atak';nWhy=currentLang==='en'?'Faster without losing SpAtk':'Szybszy bez straty Sp.Atak';}
      else{nName='Modest';nUp='+Sp.Atak';nDown='-Atak';nWhy=currentLang==='en'?'Max SpAtk':'Maks Sp.Atak';}
      if(r.spe>=100){item='Choice Specs';altItems=['Life Orb','Focus Sash'];}
      else{item='Life Orb';altItems=['Choice Specs','Assault Vest'];}
    } else if (buildType === 'defensive') {
      var defMore = r.def >= r.spdef;
      if(defMore) spread=[['hp',252],['defense',252],['special-defense',4]]; else spread=[['hp',252],['special-defense',252],['defense',4]];
      note=currentLang==='en'?'Maximum endurance.':'Maksymalna wytrzyma\u0142o\u015b\u0107.';
      if(defMore){nName='Impish';nUp='+'+(currentLang==='en'?'Def':'Obrona');nDown='-Sp.Atak';nWhy=currentLang==='en'?'Physical endurance':'Fizyczna wytrzyma\u0142o\u015b\u0107';}
      else{nName='Calm';nUp='+'+(currentLang==='en'?'SpDef':'Sp.Obr');nDown='-Atak';nWhy=currentLang==='en'?'Special endurance':'Specjalna wytrzyma\u0142o\u015b\u0107';}
      item='Leftovers';altItems=['Rocky Helmet','Sitrus Berry'];
    } else if (buildType === 'mixed') {
      spread=[['attack',128],['special-attack',128],['speed',252]];
      note=currentLang==='en'?'Balanced offensive coverage.':'Zbalansowana ofensywa mieszana.';
      if(r.isFast){nName='Naive';nUp='+Szybk.';nDown='-Sp.Obr';nWhy=currentLang==='en'?'Speed without losing offense':'Szybko\u015b\u0107 bez utraty ofensywy';}
      else if(r.atk>r.spatk){nName='Lonely';nUp='+Atak';nDown='-Obrona';nWhy=currentLang==='en'?'Max physical for mixed':'Maks fiz. dla mieszanego';}
      else{nName='Mild';nUp='+Sp.Atak';nDown='-Obrona';nWhy=currentLang==='en'?'Max special for mixed':'Maks spec. dla mieszanego';}
      item='Life Orb';altItems=['Expert Belt','Weakness Policy'];
    } else if (buildType === 'support') {
      var defMore2 = r.def >= r.spdef;
      spread=[['hp',252],[defMore2?'defense':'special-defense',252],[defMore2?'special-defense':'defense',4]];
      note=currentLang==='en'?'Team support and utility.':'Wsparcie dru\u017cyny i u\u017cyteczno\u015b\u0107.';
      if(defMore2){nName='Bold';nUp='+'+(currentLang==='en'?'Def':'Obrona');nDown='-Atak';nWhy=currentLang==='en'?'Max bulk for support':'Maks obrona dla wsparcia';}
      else{nName='Calm';nUp='+'+(currentLang==='en'?'SpDef':'Sp.Obr');nDown='-Atak';nWhy=currentLang==='en'?'Max SpDef for support':'Maks Sp.Obr dla wsparcia';}
      item='Light Clay';altItems=['Leftovers','Mental Herb','Red Card'];
    } else {
      // niche
      if(r.spe<=50){
        spread=[[r.isPhys?'attack':'special-attack',252],['hp',252],[r.isPhys?'defense':'special-defense',4]];
        note=currentLang==='en'?'Trick Room abuser \u2014 minimum speed.':'Pod Trick Room \u2014 minimalna szybko\u015b\u0107.';
        nName=r.isPhys?'Brave':'Quiet';nUp=r.isPhys?'+Atak':'+Sp.Atak';nDown='-Szybk.';nWhy=currentLang==='en'?'Min speed for Trick Room':'Min szybko\u015b\u0107 pod Trick Room';
        item=r.isPhys?'Choice Band':'Choice Specs';altItems=['Life Orb','Assault Vest'];
      } else {
        spread=[[r.isPhys?'attack':'special-attack',252],['speed',252],['hp',4]];
        note=currentLang==='en'?'Revenge killer / lead.':'Revenge killer / lead.';
        nName=r.isPhys?'Jolly':'Timid';nUp='+Szybk.';nDown=r.isPhys?'-Sp.Atak':'-Atak';nWhy=currentLang==='en'?'Max speed for revenge kills':'Maks szybko\u015b\u0107 na revenge kille';
        item='Focus Sash';altItems=['Choice Scarf','Heavy-Duty Boots','Air Balloon'];
      }
    }
    var total = spread.reduce(function(s,e){return s+e[1];},0);
    var evRows = spread.map(function(e){
      var sn=e[0],val=e[1],color=STAT_COLORS[sn]||'#888',pct=Math.round(val/252*100);
      return '<div class="ev-row"><span class="ev-amount">'+val+'</span><span class="ev-stat-name" style="color:'+color+'">'+(STAT_NAMES[sn]||sn)+'</span><div class="ev-bar-bg"><div class="ev-bar" style="width:'+pct+'%;background:'+color+'"></div></div></div>';
    }).join('');
    var evHTML='<div class="comp-box"><div class="comp-box-title">\ud83d\udcca '+t('build.ev')+' <span style="font-size:10px;color:#888;font-family:VT323,monospace">(max 510)</span></div>'+evRows+'<div class="ev-total">'+t('gen.sum')+': '+total+'/510</div><div style="font-size:14px;color:#666;margin-top:5px">'+note+'</div></div>';
    var natureHTML='<div class="comp-box"><div class="comp-box-title">\ud83d\udc8e '+t('build.nature')+'</div><div class="nature-badge">'+natureName(nName)+'</div><div style="font-size:12px;color:#555;margin-bottom:4px">('+nName+')</div><div class="nature-detail"><span class="nature-up">\u25b2 '+nUp+'</span> | <span class="nature-down">\u25bc '+nDown+'</span></div><div style="font-size:14px;color:#666;margin-top:6px">'+nWhy+'</div></div>';
    var itemHTML = renderItemBox(item, altItems);
    // Ability box
    var picked = pickAbility(pokemonAbilities, abilityDetails, buildType);
    var abilText = picked ? getAbilityText(picked.detail) : { name: '?', desc: '' };
    var hiddenTag = (picked && picked.isHidden) ? '<span class="ability-hidden-tag">'+t('build.abilityHidden')+'</span>' : '';
    var recTag = (picked && picked.score > 1) ? '<div class="ability-rec-tag">\u2705 '+t('build.abilityRec')+'</div>' : '';
    var abilityHTML='<div class="ability-box"><div class="comp-box-title">\u26a1 '+t('build.ability')+'</div><div class="ability-name">'+abilText.name+hiddenTag+'</div><div class="ability-desc">'+abilText.desc+'</div>'+recTag+'</div>';
    var movesHTML = buildBest4ForType(moves, pokemonTypes, statMap, buildType);
    return '<div class="comp-grid-full">'+evHTML+'</div>'
      +'<div class="comp-grid">'+natureHTML+itemHTML+abilityHTML+'</div>'
      +'<div class="comp-box-title" style="margin-bottom:8px">\u2694 '+t('build.best4')+'</div>'
      +'<div style="font-size:14px;color:#666;margin-bottom:8px">'+(currentLang==='en'?'Automatically selected based on types and stats.':'Automatycznie dobrane na podstawie typ\u00f3w i statystyk.')+'</div>'
      +'<div class="best4-grid">'+movesHTML+'</div>';
  }

  // ── BEST 4 FOR BUILD TYPE ──
  function buildBest4ForType(moves, pokemonTypes, statMap, buildType) {
    var r = detectRole(statMap);
    var typeSet = new Set(pokemonTypes);
    var pool = [];
    moves.forEach(function(m){
      var vgd = m.version_group_details.slice().sort(function(a,b){return b.version_group.url.localeCompare(a.version_group.url,undefined,{numeric:true});})[0];
      if(!vgd) return;
      var method = vgd.move_learn_method.name;
      if(!['level-up','machine','egg'].includes(method)) return;
      var nm = m.move.name, md = MOVE_DATA[nm], lv = vgd.level_learned_at;
      var power = md?md[0]:0, mtype = md?md[1]:'normal', cat = md?md[2]:(power>0?(r.isPhys?'P':'S'):'Z');
      var score = 0;
      if(cat==='Z'){
        var offSetup=['swords-dance','dragon-dance','nasty-plot','quiver-dance','tail-glow','shell-smash','belly-drum','work-up','geomancy','calm-mind','bulk-up','coil'];
        var defSetup=['recover','roost','soft-boiled','slack-off','milk-drink','synthesis','moonlight','morning-sun','wish','rest','shore-up'];
        if(buildType==='defensive'||buildType==='support'){
          if(defSetup.includes(nm))score=90;else if(['stealth-rock','toxic','will-o-wisp','thunder-wave','spikes'].includes(nm))score=70;else if(offSetup.includes(nm))score=30;else score=20;
          if(buildType==='support'){if(['stealth-rock','toxic','will-o-wisp','thunder-wave','spikes','reflect','light-screen','aurora-veil','tailwind','sticky-web','trick-room','healing-wish','rapid-spin','defog','u-turn','volt-switch','knock-off','encore','taunt','yawn','haze','whirlwind','roar'].includes(nm))score+=30;}
        } else {
          if(offSetup.includes(nm))score=80;else if(defSetup.includes(nm))score=15;else score=10;
        }
      } else {
        score = power;
        if(buildType==='physical'&&cat==='P')score*=1.5;else if(buildType==='special'&&cat==='S')score*=1.5;else if(buildType==='mixed')score*=1.2;else if(buildType==='defensive'||buildType==='support')score*=0.8;
        if(buildType==='physical'&&cat==='S')score*=0.3;
        if(buildType==='special'&&cat==='P')score*=0.3;
        if(buildType==='mixed'){if(cat==='P')score*=1.1;if(cat==='S')score*=1.1;}
        if(typeSet.has(mtype))score*=1.5;
        var prioMoves=['extreme-speed','quick-attack','aqua-jet','ice-shard','mach-punch','bullet-punch','sucker-punch','shadow-sneak','vacuum-wave','first-impression'];
        if(prioMoves.includes(nm))score+=25;
      }
      pool.push({nm:nm,power:power,mtype:mtype,cat:cat,score:score,lv:lv,method:method});
    });
    var seen = new Set();
    var unique = pool.filter(function(m){if(seen.has(m.nm))return false;seen.add(m.nm);return true;});
    unique.sort(function(a,b){return b.score-a.score;});
    var chosen=[],typeCounts={};
    for(var i=0;i<unique.length&&chosen.length<4;i++){
      var m=unique[i],tc=typeCounts[m.mtype]||0;
      if(tc>=2)continue;
      typeCounts[m.mtype]=(tc||0)+1;chosen.push(m);
    }
    for(var i=0;i<unique.length&&chosen.length<4;i++){if(!chosen.includes(unique[i]))chosen.push(unique[i]);}
    if(!chosen.length)return '<div style="color:#666">Brak danych o atakach.</div>';
    var stars=function(sc){return sc>=180?'\u2b50\u2b50\u2b50\u2b50':sc>=120?'\u2b50\u2b50\u2b50':sc>=60?'\u2b50\u2b50':'\u2b50';};
    var catLabel=function(cat){return cat==='P'?'<span class="move-cat-p">Fiz.</span>':cat==='S'?'<span class="move-cat-s">Spec.</span>':'<span class="move-cat-z">Status</span>';};
    return chosen.map(function(m,i){
      var isStab=typeSet.has(m.mtype);
      var stabL=isStab?'<span class="move-stab">STAB</span>':'<span class="move-coverage">'+typeName(m.mtype)+'</span>';
      var pwrStr=m.power>0?'<span class="move-power">MOC: '+m.power+'</span>':'<span class="move-power" style="color:#666">Status</span>';
      return '<div class="move-card"><span class="move-card-num">'+(i+1)+'</span><div class="move-card-name">'+typeIconHTML(m.mtype,18)+' '+m.nm.replace(/-/g,' ')+'</div><div class="move-card-meta">'+catLabel(m.cat)+stabL+pwrStr+'</div><div class="move-stars">'+stars(m.score)+'</div></div>';
    }).join('');
  }

  // ── ELIGIBLE BUILDS ──
  function getEligibleBuilds(statMap) {
    var atk=statMap['attack']||0, spatk=statMap['special-attack']||0;
    var def=statMap['defense']||0, spdef=statMap['special-defense']||0;
    var spe=statMap['speed']||0, hp=statMap['hp']||0;
    var builds = ['physical','special','defensive'];
    if (atk >= 65 && spatk >= 65) builds.push('mixed');
    if (hp >= 60 && (def >= 65 || spdef >= 65)) builds.push('support');
    if (spe <= 50 || spe >= 100 || builds.length <= 3) builds.push('niche');
    return builds;
  }

  // ── SORT BUILDS BY BASE STATS PRIORITY ──
  function sortBuildsByStats(builds, statMap) {
    var atk  = statMap['attack'] || 0;
    var spatk = statMap['special-attack'] || 0;
    var def  = statMap['defense'] || 0;
    var spdef = statMap['special-defense'] || 0;
    var spe  = statMap['speed'] || 0;
    var hp   = statMap['hp'] || 0;
    var totalOff = atk + spatk;
    var totalDef = def + spdef + hp;
    var scored = builds.map(function(b) {
      var score = 0;
      switch (b.key) {
        case 'physical':
          score = atk * 3 + spe;
          if (atk > spatk) score += (atk - spatk) * 2;
          break;
        case 'special':
          score = spatk * 3 + spe;
          if (spatk > atk) score += (spatk - atk) * 2;
          break;
        case 'defensive':
          score = def * 2 + spdef * 2 + hp * 1.5;
          if (totalDef > totalOff * 1.2) score += 80;
          break;
        case 'mixed':
          score = atk * 1.5 + spatk * 1.5 + spe;
          var diff = Math.abs(atk - spatk);
          if (diff < 20) score += 60;
          else score -= diff;
          break;
        case 'support':
          score = hp * 2 + def + spdef + 30;
          if (totalDef > totalOff * 1.3) score += 60;
          break;
        case 'niche':
          score = spe * 1.5 + Math.max(atk, spatk);
          if (spe <= 50) score += 30;
          if (spe >= 100) score += 20;
          break;
      }
      return { build: b, score: score };
    });
    scored.sort(function(a, b) { return b.score - a.score; });
    return scored.map(function(s) { return s.build; });
  }

  // ── COMPETITIVE SECTION WITH UP TO 6 BUILDS ──
  function buildCompetitiveSection(stats, pokemonTypes, moves, pokemonAbilities, abilityDetails) {
    var statMap = {}; stats.forEach(function(s){statMap[s.stat.name]=s.base_stat;});
    var r = detectRole(statMap);
    lastBuildData = {statMap:statMap, pokemonTypes:pokemonTypes, r:r};
    var allBuilds = [
      {key:'physical',  label:t('build.phys'),    icon:'\u2694'},
      {key:'special',   label:t('build.spec'),    icon:'\u2728'},
      {key:'defensive', label:t('build.def'),     icon:'\ud83d\udee1'},
      {key:'mixed',     label:t('build.mixed'),   icon:'\ud83d\udd00'},
      {key:'support',   label:t('build.support'), icon:'\ud83d\udc9a'},
      {key:'niche',     label:t('build.niche'),   icon:'\ud83c\udfaf'}
    ];
    var eligible = getEligibleBuilds(statMap);
    var filteredBuilds = allBuilds.filter(function(b){ return eligible.indexOf(b.key) !== -1; });
    var builds = sortBuildsByStats(filteredBuilds, statMap);
    var tabsHTML = builds.map(function(b,i){
      var bestStar = i===0 ? '<span class="best-choice-star">\u2b50</span>' : '';
      var bestBadge = i===0 ? ' <span class="best-choice-badge">'+t('build.bestChoice')+'</span>' : '';
      return '<button class="build-tab'+(i===0?' active':'')+'" onclick="switchBuildTab(this,\'build-panel-'+i+'\')">'+bestStar+(i+1)+'. '+b.icon+' '+b.label+bestBadge+'</button>';
    }).join('');
    var panelsHTML = builds.map(function(b,i){
      return '<div class="build-panel'+(i===0?' active':'')+'" id="build-panel-'+i+'">'+generateBuild(statMap,pokemonTypes,moves,b.key,pokemonAbilities,abilityDetails)+'</div>';
    }).join('');
    return '<div class="comp-section"><h2>\ud83c\udfc6 '+t('sec.comp')+' \u2014 '+r.label+'  <button class="copy-link-btn" id="copy-link-btn" onclick="copyBuildLink()" style="float:right;margin-top:-4px">\ud83d\udd17 '+t('build.copyLink')+'</button></h2>'
      +'<div class="build-tabs">'+tabsHTML+'</div>'
      +panelsHTML
      +'</div>';
  }

  // ── FULL MOVELIST with type icons ──
  function buildMovesSection(moves) {
    var lvlMoves=[],tmMoves=[],eggMoves=[];
    moves.forEach(function(m){
      var vgd=m.version_group_details.slice().sort(function(a,b){return b.version_group.url.localeCompare(a.version_group.url,undefined,{numeric:true});})[0];
      if(!vgd)return;
      var method=vgd.move_learn_method.name,lv=vgd.level_learned_at,nm=m.move.name;
      if(method==='level-up')lvlMoves.push({name:nm,lv:lv});
      else if(method==='machine')tmMoves.push({name:nm});
      else if(method==='egg')eggMoves.push({name:nm});
    });
    lvlMoves.sort(function(a,b){return a.lv-b.lv;});tmMoves.sort(function(a,b){return a.name.localeCompare(b.name);});eggMoves.sort(function(a,b){return a.name.localeCompare(b.name);});
    var lvlHTML=lvlMoves.length?'<table class="move-table"><tr><th>'+t('mv.lvl')+'</th><th>'+t('mv.attack')+'</th><th>'+t('mv.type')+'</th><th>'+t('mv.power')+'</th></tr>'+lvlMoves.map(function(m){var md=MOVE_DATA[m.name];var mt=md?md[1]:'normal';return '<tr><td><span class="move-lv">'+(m.lv||'\u2014')+'</span></td><td class="move-name">'+typeIconHTML(mt,16)+' '+m.name.replace(/-/g,' ')+'</td><td><span class="type-badge type-'+mt+'" style="font-size:12px;padding:1px 6px">'+typeName(mt)+'</span></td><td style="color:#f8d030;font-size:17px">'+(md?md[0]||'\u2014':'\u2014')+'</td></tr>';}).join('')+'</table>':'<div style="color:#666">'+(currentLang==='en'?'None.':'Brak.')+'</div>';
    var tmHTML=tmMoves.length?'<div style="display:flex;flex-wrap:wrap;gap:6px;padding-top:4px">'+tmMoves.map(function(m){var md=MOVE_DATA[m.name];var mt=md?md[1]:'normal';return '<span class="move-tm">'+typeIconHTML(mt,14)+' '+m.name.replace(/-/g,' ')+'</span>';}).join('')+'</div>':'<div style="color:#666">'+(currentLang==='en'?'None.':'Brak.')+'</div>';
    var eggHTML=eggMoves.length?'<div style="display:flex;flex-wrap:wrap;gap:6px;padding-top:4px">'+eggMoves.map(function(m){var md=MOVE_DATA[m.name];var mt=md?md[1]:'normal';return '<span style="background:#1a0a1a;color:#c084fc;border:1px solid #7c3aed;padding:1px 8px;font-size:15px">'+typeIconHTML(mt,14)+' '+m.name.replace(/-/g,' ')+'</span>';}).join('')+'</div>':'<div style="color:#666">'+(currentLang==='en'?'None.':'Brak.')+'</div>';
    return '<div class="moves-section"><h2>\ud83d\udcdc '+t('sec.moves')+'</h2><div class="moves-tabs"><button class="moves-tab active" onclick="switchMovesTab(this,\'mv-lvl\')">\ud83d\udcc8 '+t('mv.level')+' ('+lvlMoves.length+')</button><button class="moves-tab" onclick="switchMovesTab(this,\'mv-tm\')">\ud83d\udcbf '+t('mv.tm')+' ('+tmMoves.length+')</button>'+(eggMoves.length?'<button class="moves-tab" onclick="switchMovesTab(this,\'mv-egg\')">\ud83e\udd5a '+t('mv.egg')+' ('+eggMoves.length+')</button>':'')+'</div><div class="moves-panel active" id="mv-lvl">'+lvlHTML+'</div><div class="moves-panel" id="mv-tm">'+tmHTML+'</div>'+(eggMoves.length?'<div class="moves-panel" id="mv-egg">'+eggHTML+'</div>':'')+'</div>';
  }

  // ── CALCULATOR SECTION ──
  function buildCalculatorSection(stats, abilityDetailsArr) {
    var statMap={}; stats.forEach(function(s){statMap[s.stat.name]=s.base_stat;});
    var calcEligible = getEligibleBuilds(statMap);
    var _bLabels = {'physical':t('build.phys'),'special':t('build.spec'),'defensive':t('build.def'),'mixed':t('build.mixed'),'support':t('build.support'),'niche':t('build.niche')};
    var calcBuildOpts = calcEligible.map(function(key){return '<option value="'+key+'">'+(_bLabels[key]||key)+'</option>';}).join('');
    var ORDER=['hp','attack','defense','special-attack','special-defense','speed'];
    var ivRows = ORDER.map(function(sn){
      return '<div class="calc-box"><label>'+(STAT_NAMES[sn]||sn)+' IV (0-31)</label><div class="calc-iv-hybrid"><input type="range" min="0" max="31" value="31" oninput="syncCalcIVHybrid(this,\'range\',\''+sn+'\')" /><input class="calc-field" type="number" min="0" max="31" value="31" id="calc-iv-'+sn+'" oninput="syncCalcIVHybrid(this,\'number\',\''+sn+'\')" /></div></div>';
    }).join('');
    var natures = ['Hardy','Lonely','Brave','Adamant','Naughty','Bold','Docile','Relaxed','Impish','Lax','Timid','Hasty','Serious','Jolly','Naive','Modest','Mild','Quiet','Bashful','Rash','Calm','Gentle','Sassy','Careful','Quirky'];
    var natureOpts = natures.map(function(n){return '<option value="'+n+'">'+natureName(n)+(natureName(n)!==n?' ('+n+')':'')+'</option>';}).join('');
    var abilities = p.abilities.map(function(a){return a.ability.name;});
    var adArr = abilityDetailsArr || [];
    var abilityOpts = abilities.map(function(a, idx){
      var detail = adArr[idx];
      var localName = a;
      if (detail) {
        var ne; if(currentLang==='pl') ne=(detail.names||[]).find(function(n){return n.language.name==='pl';});
        if(!ne) ne=(detail.names||[]).find(function(n){return n.language.name==='en';});
        if(ne) localName=ne.name;
      }
      var isH = p.abilities.find(function(ab){return ab.ability.name===a;}).is_hidden;
      return '<option value="'+a+'">'+localName+(isH?' ['+(currentLang==='en'?'hidden':'ukryta')+']':'')+'</option>';
    }).join('');
    return '<div class="calc-section"><h2>\ud83e\uddee '+t('sec.calc')+'</h2>'
      +'<div style="font-size:16px;color:#888;margin-bottom:10px">'+(currentLang==='en'?'Enter your IVs, choose Nature and Ability to compare with the optimal build.':'Wpisz swoje IV, wybierz Natur\u0119 i Zdolno\u015b\u0107, aby por\u00f3wna\u0107 z optymalnym buildem.')+'</div>'
      +'<div class="calc-grid">'+ivRows+'</div>'
      +'<div class="calc-grid"><div class="calc-box"><label>'+t('build.nature')+'</label><select class="calc-select" id="calc-nature">'+natureOpts+'</select></div>'
      +'<div class="calc-box"><label>'+t('build.ability')+'</label><select class="calc-select" id="calc-ability">'+abilityOpts+'</select></div></div>'
      +'<div class="calc-grid"><div class="calc-box"><label>'+(currentLang==='en'?'Compare with build:':'Por\u00f3wnaj z buildem:')+'</label><select class="calc-select" id="calc-build-type">'+calcBuildOpts+'</select></div>'
      +'<div class="calc-box" style="display:flex;align-items:flex-end"><button class="mc-btn" onclick="evaluatePokemon()" style="width:100%">\ud83d\udcca '+t('gen.evaluate')+'</button></div></div>'
      +'<div class="calc-verdict" id="calc-verdict"><span class="verdict-emoji">\u2753</span>'+(currentLang==='en'?'Enter data and click "Rate!"':'Wpisz dane i kliknij "Oce\u0144!"')+'</div></div>';
  }

  // Build stats HTML
  var statsHTML = p.stats.map(function(st){
    var sname=STAT_NAMES[st.stat.name]||st.stat.name,val=st.base_stat,pct=Math.min(100,Math.round(val/255*100)),color=STAT_COLORS[st.stat.name]||'#888';
    return '<div class="stat-row"><span class="stat-name">'+sname+'</span><span class="stat-val">'+val+'</span><div class="stat-bar-bg"><div class="stat-bar" style="width:'+pct+'%;background:'+color+'"></div></div></div>';
  }).join('');

  var typesHTML = p.types.map(function(tp){return '<span class="type-badge type-'+tp.type.name+'">'+typeName(tp.type.name)+'</span>';}).join('');
  var evoHTML = evoChain ? renderEvoChain(evoChain.chain) : '<span style="color:#666">'+(currentLang==='en'?'No evolution data':'Brak danych ewolucji')+'</span>';

  // Cobblemon section
  var cobHTML = '';
  if (isFriendship) {
    var detail = FRIENDSHIP_DETAIL[p.name] || (currentLang==='en'?'Requires high friendship.':'Wymaga wysokiej przyja\u017ani.');
    cobHTML += '<div class="info-row"><span class="info-icon">\ud83d\udc9b</span><div class="info-text"><em>'+(currentLang==='en'?'Friendship Evolution':'Ewolucja przez Przyja\u017a\u0144')+'</em><br>'+detail+'<br>'+(currentLang==='en'?'Check friendship level:':'Sprawd\u017a poziom przyja\u017ani komend\u0105:')+'<div class="cmd-block">/checkfriendship @s</div></div></div>';
  }
  if (isTradeEvo) {
    var te = LINK_CABLE_EVOS[p.name];
    cobHTML += '<div class="info-row"><span class="info-icon">\ud83d\udd17</span><div class="info-text"><em>'+(currentLang==='en'?'Link Cable Evolution':'Ewolucja przez Link Cable')+'</em> \u2192 <em>'+te.result+'</em><br>'+(te.item?(currentLang==='en'?'Held item: ':'Trzymany przedmiot: ')+'<code>'+te.item+'</code><br>':'')+(currentLang==='en'?'Use Link Cable and activate in hand.':'U\u017cyj Link Cable i aktywuj go w r\u0119ce.')+'</div></div>';
  }

  var abilitiesHTML = p.abilities.map(function(a){
    return '<span style="color:'+(a.is_hidden?'#a855f7':'#55ffff')+'">'+a.ability.name+(a.is_hidden?' <span style="font-size:13px;color:#a855f7">['+(currentLang==='en'?'hidden':'ukryta')+']</span>':'')+'</span>';
  }).join(', ');
  var height=(p.height/10).toFixed(1),weight=(p.weight/10).toFixed(1);
  function getGen(id){for(var g=1;g<=9;g++){var r=GEN_RANGES[g];if(id>=r[0]&&id<=r[1])return (currentLang==='en'?'Generation ':'Generacja ')+['I','II','III','IV','V','VI','VII','VIII','IX'][g-1];}return '?';}
  if(!cobHTML)cobHTML='<div class="info-row"><span class="info-icon">\u2705</span><div class="info-text">'+(currentLang==='en'?'This Pok\u00e9mon has no special Cobblemon requirements.':'Ten Pok\u00e9mon nie wymaga specjalnych warunk\u00f3w Cobblemon.')+'</div></div>';
  var artworkUrl = (p.sprites&&p.sprites.other&&p.sprites.other['official-artwork']?p.sprites.other['official-artwork'].front_default:null) || 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/'+p.id+'.png';
  var isFav = isFavorite(p.id);

  // Build biome section
  var biomeHTML = buildBiomeSection(s.habitat, p.types);

  document.getElementById('main-area').innerHTML =
    '<div class="page-title"><span>#'+String(p.id).padStart(3,'0')+' '+p.name.toUpperCase()+' <button class="fav-star'+(isFav?' active':'')+'" id="fav-star-btn" onclick="toggleFavorite('+p.id+',\''+p.name+'\')" title="'+(currentLang==='en'?'Add to favorites':'Dodaj do ulubionych')+'">\u2b50</button></span></div>'
    +'<div class="detail-grid"><div>'
    +'<div class="mc-panel pokemon-portrait"><img src="'+artworkUrl+'" onerror="this.src=\'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/'+p.id+'.png\'" alt="'+p.name+'" style="width:160px;height:160px"/><div class="pokemon-name-big">'+p.name+'</div><div class="pokemon-number">#'+String(p.id).padStart(3,'0')+' \u00b7 '+getGen(p.id)+'</div><div class="types" style="margin-top:10px">'+typesHTML+'</div><hr class="section-sep" style="margin:10px 0"><div style="font-size:16px;color:#888;font-style:italic;max-width:200px;margin:0 auto;text-align:center">'+flavor+'</div></div>'
    +'<div class="mc-panel" style="margin-top:12px"><h2>\ud83d\udccb '+t('sec.basicData')+'</h2><div class="info-entry"><span class="info-label">'+t('det.height')+':</span><span class="info-value">'+height+' m</span></div><div class="info-entry"><span class="info-label">'+t('det.weight')+':</span><span class="info-value">'+weight+' kg</span></div><div class="info-entry"><span class="info-label">'+t('det.types')+':</span><span class="info-value">'+p.types.map(function(tp){return typeName(tp.type.name);}).join(', ')+'</span></div><div class="info-entry"><span class="info-label">'+t('det.abilities')+':</span><span class="info-value" style="font-size:16px">'+abilitiesHTML+'</span></div><div class="info-entry"><span class="info-label">'+t('det.habitat')+':</span><span class="info-value">'+(s.habitat?s.habitat.name:'\u2014')+'</span></div><div class="info-entry"><span class="info-label">'+t('det.catch')+':</span><span class="info-value">'+s.capture_rate+'/255</span></div><div class="info-entry"><span class="info-label">'+t('det.baseExp')+':</span><span class="info-value">'+(p.base_experience||'?')+'</span></div></div>'
    +biomeHTML
    +'</div>'
    +'<div>'
    +'<div class="mc-panel"><h2>\ud83d\udcca '+t('sec.baseStats')+'</h2>'+statsHTML+'<div style="font-size:15px;color:#666;margin-top:6px;">'+t('gen.sum')+': <span style="color:#fff">'+p.stats.reduce(function(a,st){return a+st.base_stat;},0)+'</span></div></div>'
    +buildIVSection(p.stats)
    +'<div class="mc-panel" style="margin-top:12px"><h2>\ud83e\uddec '+t('sec.evo')+'</h2><div class="evo-chain" id="evo-chain-container">'+evoHTML+'</div></div></div></div>'
    +'<div class="cobblemon-section" style="margin-top:16px"><h2><span class="cob-icon">\u2694</span> '+t('sec.cobblemon')+'</h2>'+cobHTML+'</div>'
    +buildCompetitiveSection(p.stats, p.types.map(function(tp){return tp.type.name;}), p.moves, p.abilities, abilityDetails || [])
    +buildMovesSection(p.moves)
    +buildCalculatorSection(p.stats, abilityDetails)
    +'<div style="height:40px"></div>';

  document.querySelectorAll('.iv-input').forEach(function(inp){updateIVBar(inp);});
  initAllIVSliders();
  document.querySelectorAll('.evo-item[data-evo-name]').forEach(function(el){
    el.addEventListener('click', function(){
      var n=el.dataset.evoName;var found=allPokemon.find(function(p){return p.name===n;});
      if(found)loadDetail(found.id,found.name);
    });
  });
}

/* ================================================================
   EVALUATE POKEMON (Calculator)
   ================================================================ */
function evaluatePokemon() {
  if (!lastBuildData) return;
  var buildType = document.getElementById('calc-build-type').value;
  var ORDER = ['hp','attack','defense','special-attack','special-defense','speed'];
  var ivs = {};
  ORDER.forEach(function(sn) {
    var el = document.getElementById('calc-iv-'+sn);
    ivs[sn] = el ? parseInt(el.value)||0 : 31;
  });
  var nature = document.getElementById('calc-nature').value;

  // Define ideal IVs per build type
  var idealIVs = {};
  if (buildType === 'physical') {
    idealIVs = {hp:31, attack:31, defense:20, 'special-attack':0, 'special-defense':20, speed:31};
  } else if (buildType === 'special') {
    idealIVs = {hp:31, attack:0, defense:20, 'special-attack':31, 'special-defense':20, speed:31};
  } else if (buildType === 'mixed') {
    idealIVs = {hp:31, attack:31, defense:20, 'special-attack':31, 'special-defense':20, speed:31};
  } else if (buildType === 'support') {
    idealIVs = {hp:31, attack:0, defense:31, 'special-attack':0, 'special-defense':31, speed:20};
  } else if (buildType === 'niche') {
    idealIVs = {hp:31, attack:31, defense:20, 'special-attack':31, 'special-defense':20, speed:31};
  } else {
    idealIVs = {hp:31, attack:0, defense:31, 'special-attack':0, 'special-defense':31, speed:20};
  }

  // Define ideal natures
  var idealNatures = {
    physical: ['Adamant','Jolly'],
    special: ['Modest','Timid'],
    defensive: ['Bold','Calm','Impish','Careful'],
    mixed: ['Naive','Hasty','Lonely','Mild'],
    support: ['Bold','Calm','Impish','Careful'],
    niche: ['Brave','Quiet','Jolly','Timid','Adamant','Modest']
  };

  // Define key stats per build
  var keyStats = {
    physical: ['attack','speed'],
    special: ['special-attack','speed'],
    defensive: ['hp','defense','special-defense'],
    mixed: ['attack','special-attack','speed'],
    support: ['hp','defense','special-defense'],
    niche: ['attack','special-attack','speed']
  };

  // Score calculation
  var totalScore = 0, maxScore = 0;
  var keys = keyStats[buildType] || [];
  ORDER.forEach(function(sn) {
    var weight = keys.includes(sn) ? 3 : 1;
    var ideal = idealIVs[sn];
    var actual = Math.min(31, Math.max(0, ivs[sn]));
    var diff;
    if (ideal === 0) {
      diff = 31 - actual; // lower is better
    } else {
      diff = actual; // higher is better, just use the value relative to ideal
      if (ideal < 31) diff = Math.min(actual, ideal); // cap at ideal
    }
    var statScore;
    if (ideal === 0) {
      statScore = actual <= 5 ? 1 : actual <= 15 ? 0.6 : 0.2;
    } else {
      statScore = actual >= ideal ? 1 : actual / ideal;
    }
    totalScore += statScore * weight;
    maxScore += weight;
  });

  // Nature bonus
  var isIdealNature = idealNatures[buildType] && idealNatures[buildType].includes(nature);
  if (isIdealNature) totalScore += 2;
  maxScore += 2;

  var pct = totalScore / maxScore;
  var verdict, emoji, color;
  if (pct >= 0.9) { verdict = currentLang==='en'?'Perfect!':'Idealny!'; emoji = '\ud83d\udfe2'; color = '#55ff55'; }
  else if (pct >= 0.7) { verdict = currentLang==='en'?'Good':'Dobry'; emoji = '\ud83d\udfe1'; color = '#f8d030'; }
  else if (pct >= 0.5) { verdict = currentLang==='en'?'Average':'\u015aredni'; emoji = '\ud83d\udfe0'; color = '#f08030'; }
  else { verdict = currentLang==='en'?'Keep looking':'Szukaj dalej'; emoji = '\ud83d\udd34'; color = '#ff5555'; }

  var idealList = idealNatures[buildType].map(function(n){ return natureName(n); }).join(' / ');
  var natureStatus = isIdealNature
    ? '<span style="color:#55ff55">\u2705 '+(currentLang==='en'?'Ideal nature!':'Idealna natura!')+'</span>'
    : '<span style="color:#f08030">\u26a0 '+(currentLang==='en'?'Non-optimal nature (recommended: ':'Nieoptymalna natura (zalecane: ')+idealList+')</span>';
  var pctStr = Math.round(pct * 100);
  var matchLabel = currentLang==='en'?'Build match:':'Zgodno\u015b\u0107 z buildem:';

  document.getElementById('calc-verdict').innerHTML =
    '<span class="verdict-emoji">'+emoji+'</span>'
    +'<div style="font-size:28px;color:'+color+';font-family:\'Press Start 2P\',monospace">'+verdict+'</div>'
    +'<div style="font-size:18px;color:#aaa;margin-top:8px">'+matchLabel+' <span style="color:'+color+'">'+pctStr+'%</span></div>'
    +'<div style="font-size:16px;margin-top:6px">'+natureStatus+'</div>';
}

/* ================================================================
   EVO CHAIN
   ================================================================ */
/* ================================================================
   COBBLEMON EVO OVERRIDES
   ================================================================ */
var COBBLEMON_EVO_EXTRA = {
  'goomy>sliggoo':     {pl:'+ Deszcz',en:'+ Rain'},
  'sliggoo>goodra':    {pl:'+ Deszcz',en:'+ Rain'},
  'eevee>espeon':      {pl:'+ Dzie\u0144',en:'+ Day'},
  'eevee>umbreon':     {pl:'+ Noc',en:'+ Night'},
  'eevee>leafeon':     {pl:'Kamie\u0144 Li\u015bcia',en:'Leaf Stone'},
  'eevee>glaceon':     {pl:'Kamie\u0144 Lodu',en:'Ice Stone'},
  'eevee>sylveon':     {pl:'+ Atak Fairy',en:'+ Fairy move'},
  'budew>roselia':     {pl:'+ Dzie\u0144',en:'+ Day'},
  'riolu>lucario':     {pl:'+ Dzie\u0144',en:'+ Day'},
  'chingling>chimecho':{pl:'+ Noc',en:'+ Night'},
  'sneasel>weavile':   {pl:'+ Noc + Ostry Szpon',en:'+ Night + Razor Claw'},
  'happiny>chansey':   {pl:'+ Okr\u0105g\u0142y Kam.',en:'+ Oval Stone'},
  'gligar>gliscor':    {pl:'+ Noc + Ostry K\u0142yk',en:'+ Night + Razor Fang'},
  'magneton>magnezone':{pl:'Kamie\u0144 Gromu',en:'Thunder Stone'},
  'nosepass>probopass': {pl:'Kamie\u0144 Gromu',en:'Thunder Stone'},
  'charjabug>vikavolt': {pl:'Kamie\u0144 Gromu',en:'Thunder Stone'},
  'crabrawler>crabominable':{pl:'Kamie\u0144 Lodu',en:'Ice Stone'},
  'pikachu>raichu':    {pl:'Kamie\u0144 Gromu',en:'Thunder Stone'},
  'exeggcute>exeggutor':{pl:'Kamie\u0144 Li\u015bcia',en:'Leaf Stone'},
  'cubone>marowak':    {pl:'Poz. 28',en:'Lvl 28'},
  'tyrogue>hitmonlee': {pl:'ATK > DEF',en:'ATK > DEF'},
  'tyrogue>hitmonchan':{pl:'DEF > ATK',en:'DEF > ATK'},
  'tyrogue>hitmontop': {pl:'ATK = DEF',en:'ATK = DEF'},
  'wurmple>silcoon':   {pl:'Losowo',en:'Random'},
  'wurmple>cascoon':   {pl:'Losowo',en:'Random'},
  'feebas>milotic':    {pl:'Link Cable + Pryzmowa \u0141uska',en:'Link Cable + Prism Scale'},
  'inkay>malamar':     {pl:'Poz. 30 + Obr\u00f3\u0107 ekran',en:'Lvl 30 + Flip screen'},
  'pancham>pangoro':   {pl:'Poz. 32 + Mroczny w dru\u017cynie',en:'Lvl 32 + Dark type in party'},
  'mantyke>mantine':   {pl:'Remoraid w dru\u017cynie',en:'Remoraid in party'},
  'rockruff>lycanroc': {pl:'Poz. 25 (pora dnia)',en:'Lvl 25 (time of day)'},
  'cosmoem>solgaleo':  {pl:'Poz. 53 (dzie\u0144)',en:'Lvl 53 (day)'},
  'cosmoem>lunala':    {pl:'Poz. 53 (noc)',en:'Lvl 53 (night)'},
  'kubfu>urshifu':     {pl:'Wie\u017ca Stylu',en:'Tower of Style'},
  'applin>flapple':    {pl:'Kwa\u015bne Jab\u0142ko',en:'Tart Apple'},
  'applin>appletun':   {pl:'S\u0142odkie Jab\u0142ko',en:'Sweet Apple'},
  'milcery>alcremie':  {pl:'Obr\u00f3\u0107 z s\u0142odyczami',en:'Spin with sweets'},
  'yamask>runerigus':  {pl:'49+ DMG + \u0141uk Kamieni',en:'49+ DMG + Stone Bridge'},
  'galarian_yamask>runerigus':{pl:'49+ DMG + \u0141uk',en:'49+ DMG + Arc'},
  'farfetchd>sirfetchd':{pl:'3 Kryt. Trafienia',en:'3 Critical Hits'},
  'kadabra>alakazam':  {pl:'Link Cable',en:'Link Cable'},
  'machoke>machamp':   {pl:'Link Cable',en:'Link Cable'},
  'graveler>golem':    {pl:'Link Cable',en:'Link Cable'},
  'haunter>gengar':    {pl:'Link Cable',en:'Link Cable'},
  'boldore>gigalith':  {pl:'Link Cable',en:'Link Cable'},
  'gurdurr>conkeldurr':{pl:'Link Cable',en:'Link Cable'},
  'phantump>trevenant':{pl:'Link Cable',en:'Link Cable'},
  'pumpkaboo>gourgeist':{pl:'Link Cable',en:'Link Cable'},
  'onix>steelix':      {pl:'Link Cable + Metalowa Pow\u0142oka',en:'Link Cable + Metal Coat'},
  'scyther>scizor':    {pl:'Link Cable + Metalowa Pow\u0142oka',en:'Link Cable + Metal Coat'},
  'seadra>kingdra':    {pl:'Link Cable + Smocza \u0141uska',en:'Link Cable + Dragon Scale'},
  'slowpoke>slowking': {pl:'Link Cable + Ska\u0142a Kr\u00f3la',en:"Link Cable + King's Rock"},
  'poliwhirl>politoed':{pl:'Link Cable + Ska\u0142a Kr\u00f3la',en:"Link Cable + King's Rock"},
  'porygon>porygon2':  {pl:'Link Cable + Ulepszenie',en:'Link Cable + Up-Grade'},
  'porygon2>porygon-z':{pl:'Link Cable + W\u0105tpliwy Dysk',en:'Link Cable + Dubious Disc'},
  'spritzee>aromatisse':{pl:'Link Cable + Saszetka',en:'Link Cable + Sachet'},
  'swirlix>slurpuff':  {pl:'Link Cable + Bita \u015amietana',en:'Link Cable + Whipped Dream'},
  'clamperl>huntail':  {pl:'Link Cable + Z\u0105b G\u0142\u0119bin',en:'Link Cable + Deep Sea Tooth'},
  'clamperl>gorebyss': {pl:'Link Cable + \u0141uska G\u0142\u0119bin',en:'Link Cable + Deep Sea Scale'},
  'karrablast>escavalier':{pl:'Link Cable (z Shelmet)',en:'Link Cable (with Shelmet)'},
  'shelmet>accelgor':  {pl:'Link Cable (z Karrablast)',en:'Link Cable (with Karrablast)'},
  'rhydon>rhyperior':  {pl:'Link Cable + Protektor',en:'Link Cable + Protector'},
  'electabuzz>electivire':{pl:'Link Cable + Elektrowzmacniacz',en:'Link Cable + Electirizer'},
  'magmar>magmortar':  {pl:'Link Cable + Magmowzmacniacz',en:'Link Cable + Magmarizer'},
  'dusclops>dusknoir': {pl:'Link Cable + Tkanina \u017ba\u0142oby',en:'Link Cable + Reaper Cloth'}
};

function renderEvoChain(chain) {
  var html = '';
  function buildTriggerText(det, fromName, toName) {
    var parts = [];
    // Check Cobblemon override first
    var key = fromName.toLowerCase() + '>' + toName.toLowerCase();
    var cob = COBBLEMON_EVO_EXTRA[key];
    if (cob) {
      return '<span class="evo-cond-cobblemon">' + cob[currentLang] + '</span>';
    }
    if (!det) return '';
    // Level
    if (det.min_level) {
      parts.push(t('evo.level') + ' ' + det.min_level);
    }
    // Friendship
    if (det.min_happiness) {
      parts.push('\u2665 ' + t('evo.friendship'));
    }
    // Trigger type
    if (det.trigger) {
      if (det.trigger.name === 'trade') {
        parts.push(t('evo.trade'));
      } else if (det.trigger.name === 'use-item' && det.item) {
        var stoneEN = det.item.name.replace(/-/g, ' ');
        var stonePL = itemName(stoneEN.split(' ').map(function(w){return w.charAt(0).toUpperCase()+w.slice(1);}).join(' '));
        parts.push(t('evo.stone') + ' ' + (currentLang==='pl' ? stonePL : stoneEN));
      }
    }
    // Held item
    if (det.held_item) {
      var heldEN = det.held_item.name.replace(/-/g, ' ');
      var heldPL = itemName(heldEN.split(' ').map(function(w){return w.charAt(0).toUpperCase()+w.slice(1);}).join(' '));
      parts.push(t('evo.held') + ' ' + (currentLang==='pl' ? heldPL : heldEN));
    }
    // Time of day
    if (det.time_of_day === 'day') {
      parts.push('+ ' + t('evo.day'));
    } else if (det.time_of_day === 'night') {
      parts.push('+ ' + t('evo.night'));
    }
    // Rain
    if (det.needs_overworld_rain) {
      parts.push('+ ' + t('evo.rain'));
    }
    // Gender
    if (det.gender === 1) {
      parts.push(t('evo.female'));
    } else if (det.gender === 2) {
      parts.push(t('evo.male'));
    }
    // Known move
    if (det.known_move) {
      parts.push(t('evo.move') + ' ' + det.known_move.name.replace(/-/g,' '));
    }
    // Known move type
    if (det.known_move_type) {
      parts.push(t('evo.moveType') + ' ' + typeName(det.known_move_type.name));
    }
    // Relative physical stats (Tyrogue)
    if (det.relative_physical_stats === 1) parts.push(t('evo.atkGtDef'));
    else if (det.relative_physical_stats === -1) parts.push(t('evo.defGtAtk'));
    else if (det.relative_physical_stats === 0) parts.push(t('evo.atkEqDef'));
    // Beauty (Feebas)
    if (det.min_beauty) {
      parts.push('Beauty \u2265 ' + det.min_beauty);
    }
    if (parts.length === 0 && det.trigger) {
      // Fallback
      if (det.trigger.name === 'level-up') parts.push(t('evo.level') + ' ?');
      else parts.push(det.trigger.name.replace(/-/g,' '));
    }
    return parts.map(function(p, i){
      return '<span class="' + (i===0?'evo-cond':'evo-cond-special') + '">' + p + '</span>';
    }).join('');
  }
  function walk(node, incomingTrigger) {
    var name = node.species.name;
    var id = node.species.url.split('/').filter(Boolean).pop();
    var condHTML = incomingTrigger ? '<div class="evo-condition">'+incomingTrigger+'</div>' : '';
    html += '<div class="evo-item" data-evo-name="'+name+'" title="'+(currentLang==='en'?'Click to view details':'Kliknij aby zobaczy\u0107 szczeg\u00f3\u0142y')+'">' +'<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/'+id+'.png" alt="'+name+'"/>' +'<span>'+name+'</span>'+condHTML+'</div>';
    if (node.evolves_to && node.evolves_to.length > 0) {
      node.evolves_to.forEach(function(next) {
        var det = next.evolution_details && next.evolution_details[0];
        var toName = next.species.name;
        var triggerHtml = buildTriggerText(det, name, toName);
        html += '<span class="evo-arrow">\u2192</span>';
        walk(next, triggerHtml);
      });
    }
  }
  walk(chain, '');
  return html;
}

/* ================================================================
   TYPE CHART RENDERER
   ================================================================ */
/* Weakness Checker state */
var wcType1 = '';
var wcType2 = '';

function renderWeaknessChecker(){
  var html = '<div class="wc-wrap">';
  html += '<div class="wc-intro">'+t('tc.intro')+'</div>';
  // Selector panel
  html += '<div class="wc-selector-panel">';
  html += '<div class="wc-selector-row">';
  // Type 1
  html += '<div class="wc-selector-col"><label>'+t('tc.type1')+'</label><div class="wc-type-grid" id="wc-grid1">';
  ALL_TYPES.forEach(function(tp){
    html += '<span class="wc-type-btn type-badge type-'+tp+'" data-type="'+tp+'" onclick="wcSelectType(1,\''+tp+'\')">'+typeName(tp)+'</span>';
  });
  html += '</div></div>';
  // Type 2
  html += '<div class="wc-selector-col"><label>'+t('tc.type2')+'</label><div class="wc-type-grid" id="wc-grid2">';
  html += '<span class="wc-type-btn wc-none-btn" data-type="" onclick="wcSelectType(2,\'\')">'+t('tc.none')+'</span>';
  ALL_TYPES.forEach(function(tp){
    html += '<span class="wc-type-btn type-badge type-'+tp+'" data-type="'+tp+'" onclick="wcSelectType(2,\''+tp+'\')">'+typeName(tp)+'</span>';
  });
  html += '</div></div>';
  html += '</div>'; // selector-row
  // Selected display
  html += '<div class="wc-selected-display" id="wc-display"></div>';
  html += '</div>'; // selector-panel
  // Results area
  html += '<div id="wc-results"><div class="wc-empty-state">'+t('tc.emptyState')+'</div></div>';
  html += '</div>'; // wc-wrap
  return html;
}

function wcSelectType(slot, tp){
  if(slot === 1) {
    wcType1 = tp;
    // highlight
    var g1 = document.getElementById('wc-grid1');
    if(g1){
      g1.querySelectorAll('.wc-type-btn').forEach(function(b){ b.classList.remove('wc-selected'); });
      if(tp) { var sel=g1.querySelector('[data-type="'+tp+'"]'); if(sel) sel.classList.add('wc-selected'); }
    }
  } else {
    wcType2 = tp;
    var g2 = document.getElementById('wc-grid2');
    if(g2){
      g2.querySelectorAll('.wc-type-btn').forEach(function(b){ b.classList.remove('wc-selected'); });
      var sel2=g2.querySelector('[data-type="'+tp+'"]'); if(sel2) sel2.classList.add('wc-selected');
    }
  }
  wcUpdateDisplay();
  wcCalc();
}

function wcUpdateDisplay(){
  var el = document.getElementById('wc-display');
  if(!el) return;
  if(!wcType1) { el.innerHTML = '<span style="color:#555">'+t('tc.pickType')+'</span>'; return; }
  var html = t('tc.analyzing')+' <span class="type-badge type-'+wcType1+'">'+typeName(wcType1)+'</span>';
  if(wcType2 && wcType2 !== wcType1) html += ' / <span class="type-badge type-'+wcType2+'">'+typeName(wcType2)+'</span>';
  el.innerHTML = html;
}

function wcCalc(){
  var out = document.getElementById('wc-results');
  if(!out) return;
  if(!wcType1){ out.innerHTML = '<div class="wc-empty-state">'+t('tc.emptyState')+'</div>'; return; }
  var x4=[],x2=[],half=[],quarter=[],zero=[],neutral=[];
  ALL_TYPES.forEach(function(atk){
    var m = 1;
    if(TYPE_EFF[wcType1]){
      if(TYPE_EFF[wcType1].immune.indexOf(atk)!==-1) m*=0;
      else if(TYPE_EFF[wcType1].weak.indexOf(atk)!==-1) m*=2;
      else if(TYPE_EFF[wcType1].resist.indexOf(atk)!==-1) m*=0.5;
    }
    if(wcType2 && wcType2!==wcType1 && TYPE_EFF[wcType2]){
      if(TYPE_EFF[wcType2].immune.indexOf(atk)!==-1) m*=0;
      else if(TYPE_EFF[wcType2].weak.indexOf(atk)!==-1) m*=2;
      else if(TYPE_EFF[wcType2].resist.indexOf(atk)!==-1) m*=0.5;
    }
    var badge='<span class="type-badge type-'+atk+'">'+typeName(atk)+'</span>';
    if(m===0) zero.push(badge);
    else if(m>=4) x4.push(badge);
    else if(m>=2) x2.push(badge);
    else if(m<=0.25) quarter.push(badge);
    else if(m<=0.5) half.push(badge);
    else neutral.push(badge);
  });
  var html = '';
  // Critical x4 banner
  if(x4.length){
    html += '<div class="wc-critical"><h4>'+t('tc.critical')+'</h4><div class="wc-badge-row">';
    x4.forEach(function(b){ html += b; });
    html += '</div></div>';
  }
  // Threats section (x2)
  if(x2.length){
    html += '<div class="wc-section wc-threats"><h4>'+t('tc.threats')+' <span style="font-family:VT323,monospace;font-size:14px">(\u00d72)</span></h4>';
    html += '<div class="wc-badge-row">';
    x2.forEach(function(b){ html += b; });
    html += '</div></div>';
  }
  // Resistances section
  if(half.length || quarter.length){
    html += '<div class="wc-section wc-resists"><h4>'+t('tc.resists')+'</h4>';
    if(half.length){
      html += '<div class="wc-badge-row" style="margin-bottom:8px"><span class="wc-mult-label wc-mult-half">'+t('tc.resHalf')+'</span> ';
      half.forEach(function(b){ html += b; });
      html += '</div>';
    }
    if(quarter.length){
      html += '<div class="wc-badge-row"><span class="wc-mult-label wc-mult-quarter">'+t('tc.resQuarter')+'</span> ';
      quarter.forEach(function(b){ html += b; });
      html += '</div>';
    }
    html += '</div>';
  }
  // Immunity section
  if(zero.length){
    html += '<div class="wc-section wc-immune"><h4>'+t('tc.immune')+'</h4>';
    html += '<div class="wc-badge-row">';
    zero.forEach(function(b){ html += b; });
    html += '</div></div>';
  }
  // Neutral
  if(neutral.length){
    html += '<div class="wc-section" style="border-color:#1a1a2a"><h4 style="color:#666">'+t('tc.neutral')+'</h4>';
    html += '<div class="wc-badge-row wc-neutral-row">';
    neutral.forEach(function(b){ html += b; });
    html += '</div></div>';
  }
  out.innerHTML = '<div class="wc-results">'+html+'</div>';
}

/* ================================================================
   BATTLE SIM ENGINE
   ================================================================ */
const NATURE_MODS = {
  'Hardy':{up:null,down:null},'Lonely':{up:'attack',down:'defense'},
  'Brave':{up:'attack',down:'speed'},'Adamant':{up:'attack',down:'special-attack'},
  'Naughty':{up:'attack',down:'special-defense'},'Bold':{up:'defense',down:'attack'},
  'Docile':{up:null,down:null},'Relaxed':{up:'defense',down:'speed'},
  'Impish':{up:'defense',down:'special-attack'},'Lax':{up:'defense',down:'special-defense'},
  'Timid':{up:'speed',down:'attack'},'Hasty':{up:'speed',down:'defense'},
  'Serious':{up:null,down:null},'Jolly':{up:'speed',down:'special-attack'},
  'Naive':{up:'speed',down:'special-defense'},'Modest':{up:'special-attack',down:'attack'},
  'Mild':{up:'special-attack',down:'defense'},'Quiet':{up:'special-attack',down:'speed'},
  'Bashful':{up:null,down:null},'Rash':{up:'special-attack',down:'special-defense'},
  'Calm':{up:'special-defense',down:'attack'},'Gentle':{up:'special-defense',down:'defense'},
  'Sassy':{up:'special-defense',down:'speed'},'Careful':{up:'special-defense',down:'special-attack'},
  'Quirky':{up:null,down:null}
};
const ALL_NATURES = Object.keys(NATURE_MODS);
const BATTLE_LEVEL = 50;
const BATTLE_STAT_ORDER = ['hp','attack','defense','special-attack','special-defense','speed'];
let battleState = null;
let battleSetupData = { player: null, opponent: null };
let battleSearchTimeout = null;

function battleCalcStat(baseStat, iv, ev, statName, nature) {
  if (statName === 'hp') {
    return Math.floor(((2 * baseStat + iv + Math.floor(ev / 4)) * BATTLE_LEVEL / 100)) + BATTLE_LEVEL + 10;
  }
  var raw = Math.floor(((2 * baseStat + iv + Math.floor(ev / 4)) * BATTLE_LEVEL / 100)) + 5;
  var mod = NATURE_MODS[nature];
  if (mod && mod.up === statName) raw = Math.floor(raw * 1.1);
  if (mod && mod.down === statName) raw = Math.floor(raw * 0.9);
  return raw;
}

function battleGetEff(moveType, defenderTypes) {
  var mult = 1;
  defenderTypes.forEach(function(dt) {
    if (!TYPE_EFF[dt]) return;
    if (TYPE_EFF[dt].immune.indexOf(moveType) !== -1) mult *= 0;
    else if (TYPE_EFF[dt].weak.indexOf(moveType) !== -1) mult *= 2;
    else if (TYPE_EFF[dt].resist.indexOf(moveType) !== -1) mult *= 0.5;
  });
  return mult;
}

function battleCalcDamage(attacker, defender, move) {
  if (move.power === 0) return { damage: 0, effectiveness: 1 };
  var atkStat, defStat;
  if (move.category === 'P') {
    atkStat = attacker.computedStats['attack'];
    defStat = defender.computedStats['defense'];
  } else {
    atkStat = attacker.computedStats['special-attack'];
    defStat = defender.computedStats['special-defense'];
  }
  var dmg = ((2 * BATTLE_LEVEL / 5 + 2) * move.power * atkStat / defStat) / 50 + 2;
  if (attacker.types.includes(move.type)) dmg *= 1.5;
  var eff = battleGetEff(move.type, defender.types);
  dmg *= eff;
  dmg *= (0.85 + Math.random() * 0.15);
  return { damage: Math.max(1, Math.floor(dmg)), effectiveness: eff };
}

function detectRoleBattle(statMap) {
  var atk = statMap['attack'] || 0, spatk = statMap['special-attack'] || 0;
  var def = statMap['defense'] || 0, spdef = statMap['special-defense'] || 0;
  var spe = statMap['speed'] || 0;
  return {
    isPhys: atk >= spatk + 15, isSpec: spatk >= atk + 15,
    isMixed: !(atk >= spatk + 15) && !(spatk >= atk + 15),
    isTank: (def + spdef) / 2 >= 90 && spe < 80, isFast: spe >= 80
  };
}

function battleAutoEV(statMap) {
  var r = detectRoleBattle(statMap);
  var evs = { hp: 0, attack: 0, defense: 0, 'special-attack': 0, 'special-defense': 0, speed: 0 };
  if (r.isPhys && r.isFast) { evs.attack = 252; evs.speed = 252; evs.hp = 4; }
  else if (r.isPhys) { evs.attack = 252; evs.hp = 252; evs.defense = 4; }
  else if (r.isSpec && r.isFast) { evs['special-attack'] = 252; evs.speed = 252; evs.hp = 4; }
  else if (r.isSpec) { evs['special-attack'] = 252; evs.hp = 252; evs['special-defense'] = 4; }
  else if (r.isTank) { evs.hp = 252; evs.defense = 128; evs['special-defense'] = 128; }
  else { evs.hp = 4; evs.attack = 126; evs['special-attack'] = 126; evs.speed = 252; }
  return evs;
}

function battleSelectMoves(pokemonData, types, statMap) {
  var r = detectRoleBattle(statMap);
  var typeSet = new Set(types);
  var pool = [];
  pokemonData.moves.forEach(function(m) {
    var vgd = m.version_group_details.slice().sort(function(a, b) {
      return b.version_group.url.localeCompare(a.version_group.url, undefined, { numeric: true });
    })[0];
    if (!vgd) return;
    var method = vgd.move_learn_method.name;
    if (!['level-up', 'machine', 'egg'].includes(method)) return;
    var nm = m.move.name, md = MOVE_DATA[nm];
    if (!md || md[0] === 0) return;
    var power = md[0], mtype = md[1], cat = md[2];
    if (cat === 'Z') return;
    var score = power;
    if ((r.isPhys && cat === 'P') || (r.isSpec && cat === 'S')) score *= 1.4;
    if (typeSet.has(mtype)) score *= 1.5;
    pool.push({ name: nm, power: power, type: mtype, category: cat, score: score });
  });
  var seen = new Set();
  var unique = pool.filter(function(m) { if (seen.has(m.name)) return false; seen.add(m.name); return true; });
  unique.sort(function(a, b) { return b.score - a.score; });
  var chosen = [], typeCounts = {};
  for (var i = 0; i < unique.length && chosen.length < 4; i++) {
    var m = unique[i], tc = typeCounts[m.type] || 0;
    if (tc >= 2) continue;
    typeCounts[m.type] = (tc || 0) + 1; chosen.push(m);
  }
  for (var i = 0; i < unique.length && chosen.length < 4; i++) {
    if (!chosen.includes(unique[i])) chosen.push(unique[i]);
  }
  if (chosen.length === 0) {
    chosen.push({ name: 'tackle', power: 40, type: 'normal', category: 'P', score: 40 });
  }
  return chosen;
}

async function battleBuildPokemon(id, ivs, nature, abilitySlug) {
  var data = detailCache[id];
  if (!data) {
    var res = await fetch('https://pokeapi.co/api/v2/pokemon/' + id);
    var p = await res.json();
    data = { p: p }; detailCache[id] = data;
  }
  var p = data.p;
  var types = p.types.map(function(t) { return t.type.name; });
  var statMap = {}; p.stats.forEach(function(s) { statMap[s.stat.name] = s.base_stat; });
  var evs = battleAutoEV(statMap);
  var computedStats = {};
  BATTLE_STAT_ORDER.forEach(function(sn) {
    computedStats[sn] = battleCalcStat(statMap[sn] || 50, ivs[sn] || 0, evs[sn] || 0, sn, nature);
  });
  var moves = battleSelectMoves(p, types, statMap);
  var ability = abilitySlug || (p.abilities[0] ? p.abilities[0].ability.name : 'unknown');
  return {
    id: id, name: p.name, types: types, baseStats: statMap, ivs: ivs, evs: evs,
    nature: nature, ability: ability, computedStats: computedStats, moves: moves,
    maxHp: computedStats.hp, currentHp: computedStats.hp,
    sprite: p.sprites.front_default || 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/' + id + '.png',
    artwork: (p.sprites.other && p.sprites.other['official-artwork'] ? p.sprites.other['official-artwork'].front_default : null)
      || 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/' + id + '.png'
  };
}

function battleRandomIVs() {
  var ivs = {};
  BATTLE_STAT_ORDER.forEach(function(sn) { ivs[sn] = Math.floor(Math.random() * 32); });
  return ivs;
}

async function battleRandomPokemon(side) {
  var poke = allPokemon[Math.floor(Math.random() * allPokemon.length)];
  var data = detailCache[poke.id];
  if (!data) {
    var res = await fetch('https://pokeapi.co/api/v2/pokemon/' + poke.id);
    var pData = await res.json();
    data = { p: pData }; detailCache[poke.id] = data;
  }
  var ivs = battleRandomIVs();
  var nature = ALL_NATURES[Math.floor(Math.random() * ALL_NATURES.length)];
  var abilities = data.p.abilities;
  var ability = abilities.length ? abilities[Math.floor(Math.random() * abilities.length)].ability.name : 'unknown';
  var pokemon = await battleBuildPokemon(poke.id, ivs, nature, ability);
  battleSetupData[side] = { id: poke.id, ivs: ivs, nature: nature, ability: ability, pokemon: pokemon, data: data };
  battleRenderSetupPreview(side);
}

async function battleSelectPokemon(side, id) {
  var data = detailCache[id];
  if (!data) {
    var res = await fetch('https://pokeapi.co/api/v2/pokemon/' + id);
    var pData = await res.json();
    data = { p: pData }; detailCache[id] = data;
  }
  var ivs = {}; BATTLE_STAT_ORDER.forEach(function(sn) { ivs[sn] = 31; });
  var statMap = {}; data.p.stats.forEach(function(s) { statMap[s.stat.name] = s.base_stat; });
  var r = detectRoleBattle(statMap);
  var nature;
  if (r.isPhys && r.isFast) nature = 'Jolly';
  else if (r.isPhys) nature = 'Adamant';
  else if (r.isSpec && r.isFast) nature = 'Timid';
  else if (r.isSpec) nature = 'Modest';
  else nature = 'Hardy';
  var ability = data.p.abilities[0] ? data.p.abilities[0].ability.name : 'unknown';
  var pokemon = await battleBuildPokemon(id, ivs, nature, ability);
  battleSetupData[side] = { id: id, ivs: ivs, nature: nature, ability: ability, pokemon: pokemon, data: data };
  battleRenderSetupPreview(side);
}

function battleRenderSetupPreview(side) {
  var setup = battleSetupData[side];
  if (!setup) return;
  var pokemon = setup.pokemon;
  var container = document.getElementById('battle-preview-' + side);
  if (!container) return;
  var typesHTML = pokemon.types.map(function(tp) {
    return '<span class="type-badge type-' + tp + '" style="font-size:12px;padding:1px 6px">' + typeName(tp) + '</span>';
  }).join('');
  var movesHTML = pokemon.moves.map(function(m) {
    return '<span class="battle-move-chip">' + typeIconHTML(m.type, 14) + ' ' + m.name.replace(/-/g, ' ') + ' <span style="color:#f8d030;font-size:12px">' + m.power + '</span></span>';
  }).join('');
  container.innerHTML =
    '<div class="battle-preview">' +
    '<img src="' + pokemon.artwork + '" onerror="this.src=\'' + pokemon.sprite + '\'" />' +
    '<div class="battle-preview-info"><div class="battle-preview-name">' + pokemon.name + '</div>' +
    '<div class="battle-preview-types">' + typesHTML + '</div>' +
    '<div style="font-size:14px;color:#888;margin-top:4px">HP: ' + pokemon.maxHp + ' | ' +
    t('build.nature') + ': ' + natureName(pokemon.nature) + '</div></div></div>' +
    '<div class="battle-moves-preview"><div class="battle-moves-preview-title">' + t('build.best4') + ':</div>' + movesHTML + '</div>';
  // Update IV inputs
  BATTLE_STAT_ORDER.forEach(function(sn) {
    var inp = document.getElementById('biv-' + side + '-' + sn);
    if (inp) inp.value = setup.ivs[sn];
  });
  var natSel = document.getElementById('bnat-' + side);
  if (natSel) natSel.value = setup.nature;
  var abilSel = document.getElementById('babil-' + side);
  if (abilSel) {
    abilSel.innerHTML = '';
    setup.data.p.abilities.forEach(function(a) {
      var opt = document.createElement('option');
      opt.value = a.ability.name;
      opt.textContent = a.ability.name.replace(/-/g, ' ') + (a.is_hidden ? ' [' + (currentLang === 'en' ? 'hidden' : 'ukryta') + ']' : '');
      if (a.ability.name === setup.ability) opt.selected = true;
      abilSel.appendChild(opt);
    });
  }
  var startBtn = document.getElementById('battle-start-btn');
  if (startBtn) startBtn.disabled = !(battleSetupData.player && battleSetupData.opponent);
}

async function battleUpdateFromInputs(side) {
  var setup = battleSetupData[side];
  if (!setup) return;
  var ivs = {};
  BATTLE_STAT_ORDER.forEach(function(sn) {
    var inp = document.getElementById('biv-' + side + '-' + sn);
    ivs[sn] = inp ? Math.min(31, Math.max(0, parseInt(inp.value) || 0)) : setup.ivs[sn];
  });
  var natSel = document.getElementById('bnat-' + side);
  var nature = natSel ? natSel.value : setup.nature;
  var abilSel = document.getElementById('babil-' + side);
  var ability = abilSel ? abilSel.value : setup.ability;
  setup.ivs = ivs; setup.nature = nature; setup.ability = ability;
  var pokemon = await battleBuildPokemon(setup.id, ivs, nature, ability);
  setup.pokemon = pokemon;
  battleSetupData[side] = setup;
  battleRenderSetupPreview(side);
}

function battleOnSearch(side, input) {
  clearTimeout(battleSearchTimeout);
  var q = input.value.trim().toLowerCase();
  var results = document.getElementById('battle-search-results-' + side);
  if (q.length < 2) { results.classList.remove('open'); return; }
  battleSearchTimeout = setTimeout(function() {
    var matches = allPokemon.filter(function(p) {
      return p.name.includes(q) || String(p.id).includes(q);
    }).slice(0, 8);
    if (!matches.length) {
      results.innerHTML = '<div class="team-search-item" style="color:#666">' + t('gen.noResults') + '</div>';
      results.classList.add('open'); return;
    }
    results.innerHTML = matches.map(function(p) {
      return '<div class="team-search-item" onclick="battlePickFromSearch(\'' + side + '\',' + p.id + ')">' +
        '<img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/' + p.id + '.png" style="width:32px;height:32px"/>' +
        '<span style="text-transform:capitalize">' + p.name + '</span>' +
        '<span style="color:#666;margin-left:auto">#' + String(p.id).padStart(3, '0') + '</span></div>';
    }).join('');
    results.classList.add('open');
  }, 200);
}

async function battlePickFromSearch(side, id) {
  var results = document.getElementById('battle-search-results-' + side);
  results.classList.remove('open');
  var inp = document.getElementById('battle-search-' + side);
  if (inp) inp.value = '';
  await battleSelectPokemon(side, id);
}

async function battleStart() {
  if (!battleSetupData.player || !battleSetupData.opponent) return;
  await battleUpdateFromInputs('player');
  await battleUpdateFromInputs('opponent');
  battleState = {
    player: JSON.parse(JSON.stringify(battleSetupData.player.pokemon)),
    opponent: JSON.parse(JSON.stringify(battleSetupData.opponent.pokemon)),
    log: [], turn: 0, isPlayerTurn: true, battleOver: false
  };
  if (battleState.opponent.computedStats.speed > battleState.player.computedStats.speed) {
    battleState.isPlayerTurn = false;
  }
  battleRenderArena();
  if (!battleState.isPlayerTurn) {
    battleAddLog(t('battle.fasterOpp'), 'neutral');
    battleRenderArena();
    setTimeout(function() { battleAITurn(); }, 1000);
  }
}

function battleAddLog(msg, type) {
  battleState.log.push({ msg: msg, type: type || 'neutral' });
}

function getHpColor(pct) {
  if (pct > 50) return '#55ff55';
  if (pct > 20) return '#f8d030';
  return '#ff5555';
}

function battleRenderArena() {
  if (!battleState) return;
  var main = document.getElementById('main-area');
  var p = battleState.player, o = battleState.opponent;
  var pHpPct = Math.max(0, p.currentHp / p.maxHp * 100);
  var oHpPct = Math.max(0, o.currentHp / o.maxHp * 100);

  var moveBtns = p.moves.map(function(m, i) {
    var eff = battleGetEff(m.type, o.types);
    var effClass = '', effText = '';
    if (eff >= 2) { effClass = ' super-effective'; effText = '<span class="battle-move-eff se">' + t('battle.se') + '</span>'; }
    else if (eff > 0 && eff < 1) { effClass = ' not-very-effective'; effText = '<span class="battle-move-eff nve">' + t('battle.nve') + '</span>'; }
    else if (eff === 0) { effClass = ' immune'; effText = '<span class="battle-move-eff imm">IMM</span>'; }
    var disabled = battleState.battleOver || !battleState.isPlayerTurn ? ' disabled' : '';
    var catLabel = m.category === 'P' ? t('battle.phys') : t('battle.spec');
    return '<button class="battle-move-btn' + effClass + '"' + disabled + ' onclick="battlePlayerMove(' + i + ')">' +
      effText +
      '<span class="battle-move-name">' + typeIconHTML(m.type, 16) + ' ' + m.name.replace(/-/g, ' ') + '</span>' +
      '<span class="battle-move-meta"><span>' + catLabel + '</span> | <span style="color:#f8d030">PWR: ' + m.power + '</span></span></button>';
  }).join('');

  var pStatsHTML = BATTLE_STAT_ORDER.map(function(sn) {
    return '<div class="battle-stat-item"><span class="bs-name" style="color:' + (STAT_COLORS[sn] || '#888') + '">' + (STAT_NAMES[sn] || sn) + '</span><span class="bs-val">' + p.computedStats[sn] + '</span></div>';
  }).join('');
  var oStatsHTML = BATTLE_STAT_ORDER.map(function(sn) {
    return '<div class="battle-stat-item"><span class="bs-name" style="color:' + (STAT_COLORS[sn] || '#888') + '">' + (STAT_NAMES[sn] || sn) + '</span><span class="bs-val">' + o.computedStats[sn] + '</span></div>';
  }).join('');
  var pTypesHTML = p.types.map(function(tp) { return '<span class="type-badge type-' + tp + '" style="font-size:12px;padding:1px 6px">' + typeName(tp) + '</span>'; }).join('');
  var oTypesHTML = o.types.map(function(tp) { return '<span class="type-badge type-' + tp + '" style="font-size:12px;padding:1px 6px">' + typeName(tp) + '</span>'; }).join('');
  var logHTML = battleState.log.map(function(entry) {
    return '<div class="battle-log-entry ' + entry.type + '">' + entry.msg + '</div>';
  }).join('');
  var waitingHTML = (!battleState.isPlayerTurn && !battleState.battleOver)
    ? '<div class="battle-waiting">' + t('battle.opponentThink') + '</div>' : '';
  var resultHTML = '';
  if (battleState.battleOver) {
    var isWin = o.currentHp <= 0;
    resultHTML = '<div class="battle-result ' + (isWin ? 'victory' : 'defeat') + '">' +
      '<h2>' + (isWin ? t('battle.victory') : t('battle.defeat')) + '</h2>' +
      '<div style="font-size:18px;color:#aaa">' +
      (isWin ? t('battle.yourWon').replace('%p', p.name) : t('battle.yourLost').replace('%p', p.name)) + '</div>' +
      '<div class="battle-result-buttons">' +
      '<button class="mc-btn" onclick="battleStart()" style="background:#2a5a2a;border-top-color:#5a8a5a;border-left-color:#5a8a5a">' + t('battle.rematch') + '</button>' +
      '<a class="mc-btn" href="arena.html" style="text-decoration:none">' + t('battle.newBattle') + '</a></div></div>';
  }

  main.innerHTML =
    '<div class="page-title"><span>\u2694 ' + t('nav.battle') + '</span></div>' +
    '<div class="battle-page">' +
    '<div class="battle-arena">' +
    '<div class="battle-card player-card">' +
    '<div style="font-family:\'Press Start 2P\',monospace;font-size:9px;color:var(--green);margin-bottom:8px">' + t('battle.yourPoke') + '</div>' +
    '<div class="battle-pokemon-header">' +
    '<img class="battle-pokemon-img" src="' + p.artwork + '" onerror="this.src=\'' + p.sprite + '\'" />' +
    '<div class="battle-pokemon-info"><div class="battle-pokemon-name">' + p.name + '</div>' +
    '<div class="battle-pokemon-types">' + pTypesHTML + '</div>' +
    '<div style="font-size:13px;color:#888;margin-top:2px">' + natureName(p.nature) + ' | ' + p.ability.replace(/-/g, ' ') + '</div></div></div>' +
    '<div class="battle-hp-section"><div class="battle-hp-label"><span class="hp-text">HP</span><span class="hp-val">' + Math.max(0, p.currentHp) + ' / ' + p.maxHp + '</span></div>' +
    '<div class="battle-hp-bar-bg"><div class="battle-hp-bar-fill" style="width:' + pHpPct + '%;background:' + getHpColor(pHpPct) + '"></div></div></div>' +
    '<div class="battle-stat-preview">' + pStatsHTML + '</div>' +
    '<div class="battle-moves-grid">' + moveBtns + '</div>' + waitingHTML + '</div>' +
    '<div class="battle-card opponent-card">' +
    '<div style="font-family:\'Press Start 2P\',monospace;font-size:9px;color:var(--red);margin-bottom:8px">' + t('battle.opponent') + '</div>' +
    '<div class="battle-pokemon-header">' +
    '<img class="battle-pokemon-img" src="' + o.artwork + '" onerror="this.src=\'' + o.sprite + '\'" />' +
    '<div class="battle-pokemon-info"><div class="battle-pokemon-name">' + o.name + '</div>' +
    '<div class="battle-pokemon-types">' + oTypesHTML + '</div>' +
    '<div style="font-size:13px;color:#888;margin-top:2px">' + natureName(o.nature) + ' | ' + o.ability.replace(/-/g, ' ') + '</div></div></div>' +
    '<div class="battle-hp-section"><div class="battle-hp-label"><span class="hp-text">HP</span><span class="hp-val">' + Math.max(0, o.currentHp) + ' / ' + o.maxHp + '</span></div>' +
    '<div class="battle-hp-bar-bg"><div class="battle-hp-bar-fill" style="width:' + oHpPct + '%;background:' + getHpColor(oHpPct) + '"></div></div></div>' +
    '<div class="battle-stat-preview">' + oStatsHTML + '</div>' +
    '<div style="margin-top:12px"><div style="font-size:14px;color:#666;margin-bottom:4px">' + t('battle.knownMoves') + '</div>' +
    o.moves.map(function(m) {
      return '<span class="battle-move-chip">' + typeIconHTML(m.type, 14) + ' ' + m.name.replace(/-/g, ' ') + ' <span style="color:#f8d030;font-size:12px">' + m.power + '</span></span>';
    }).join('') + '</div></div>' +
    '</div>' + resultHTML +
    '<div class="battle-log" id="battle-log">' + logHTML + '</div>' +
    '</div>';
  var logEl = document.getElementById('battle-log');
  if (logEl) logEl.scrollTop = logEl.scrollHeight;
}

function battlePlayerMove(moveIdx) {
  if (!battleState || battleState.battleOver || !battleState.isPlayerTurn) return;
  var p = battleState.player, o = battleState.opponent;
  var move = p.moves[moveIdx];
  var result = battleCalcDamage(p, o, move);
  o.currentHp -= result.damage;
  if (o.currentHp < 0) o.currentHp = 0;
  var effMsg = '', logType = 'neutral';
  if (result.effectiveness >= 2) { effMsg = ' (' + t('battle.superEff') + ')'; logType = 'se'; }
  else if (result.effectiveness > 0 && result.effectiveness < 1) { effMsg = ' (' + t('battle.notVeryEff') + ')'; logType = 'nve'; }
  else if (result.effectiveness === 0) { effMsg = ' (' + t('battle.noEffect') + ')'; logType = 'imm'; }
  var logMsg = t('battle.yourUsed').replace('%p', p.name).replace('%m', move.name.replace(/-/g, ' ')) + ' (-' + result.damage + ' HP)' + effMsg;
  battleAddLog(logMsg, logType);
  battleState.isPlayerTurn = false;
  battleState.turn++;
  if (o.currentHp <= 0) {
    battleAddLog(t('battle.fainted').replace('%p', o.name), 'faint');
    battleState.battleOver = true;
    battleRenderArena(); return;
  }
  battleRenderArena();
  setTimeout(function() { battleAITurn(); }, 1000);
}

function battleAITurn() {
  if (!battleState || battleState.battleOver) return;
  var o = battleState.opponent, p = battleState.player;
  var bestMove = null, bestDmgEst = -1;
  o.moves.forEach(function(m) {
    var eff = battleGetEff(m.type, p.types);
    var est = m.power * eff;
    if (o.types.includes(m.type)) est *= 1.5;
    if (m.category === 'P' && o.computedStats.attack > o.computedStats['special-attack']) est *= 1.1;
    if (m.category === 'S' && o.computedStats['special-attack'] > o.computedStats.attack) est *= 1.1;
    if (est > bestDmgEst) { bestDmgEst = est; bestMove = m; }
  });
  if (!bestMove) bestMove = o.moves[0];
  var result = battleCalcDamage(o, p, bestMove);
  p.currentHp -= result.damage;
  if (p.currentHp < 0) p.currentHp = 0;
  var effMsg = '', logType = 'neutral';
  if (result.effectiveness >= 2) { effMsg = ' (' + t('battle.superEff') + ')'; logType = 'se'; }
  else if (result.effectiveness > 0 && result.effectiveness < 1) { effMsg = ' (' + t('battle.notVeryEff') + ')'; logType = 'nve'; }
  else if (result.effectiveness === 0) { effMsg = ' (' + t('battle.noEffect') + ')'; logType = 'imm'; }
  var logMsg = t('battle.oppUsed').replace('%p', o.name).replace('%m', bestMove.name.replace(/-/g, ' ')) + ' (-' + result.damage + ' HP)' + effMsg;
  battleAddLog(logMsg, logType);
  battleState.isPlayerTurn = true;
  if (p.currentHp <= 0) {
    battleAddLog(t('battle.fainted').replace('%p', p.name), 'faint');
    battleState.battleOver = true;
  }
  battleRenderArena();
}

function renderBattleSetupPage() {
  var natureOpts = ALL_NATURES.map(function(n) {
    var nm = NATURE_MODS[n];
    var hint = '';
    if (nm.up && nm.down) {
      var upN = STAT_NAMES[nm.up] || nm.up, downN = STAT_NAMES[nm.down] || nm.down;
      hint = ' (+' + upN + ' / -' + downN + ')';
    }
    return '<option value="' + n + '">' + natureName(n) + ' (' + n + ')' + hint + '</option>';
  }).join('');

  function buildSetupCard(side, label, color) {
    var ivInputs = BATTLE_STAT_ORDER.map(function(sn) {
      return '<div class="battle-iv-box"><label style="color:' + (STAT_COLORS[sn] || '#888') + '">' + (STAT_NAMES[sn] || sn) + '</label>' +
        '<div class="calc-iv-hybrid"><input type="range" min="0" max="31" value="31" oninput="syncBattleIVHybrid(this,\'range\',\'' + side + '\',\'' + sn + '\')" />' +
        '<input type="number" min="0" max="31" value="31" id="biv-' + side + '-' + sn + '" oninput="syncBattleIVHybrid(this,\'number\',\'' + side + '\',\'' + sn + '\')" /></div></div>';
    }).join('');
    return '<div class="battle-setup-card ' + side + '">' +
      '<h3 style="color:' + color + '">' + label + '</h3>' +
      '<button class="battle-random-btn" onclick="battleRandomPokemon(\'' + side + '\')">' + t('battle.random') + '</button>' +
      '<div class="battle-search-wrap">' +
      '<input class="mc-input" id="battle-search-' + side + '" type="text" placeholder="' + t('battle.searchPoke') + '" oninput="battleOnSearch(\'' + side + '\',this)" autocomplete="off" />' +
      '<div class="battle-search-results" id="battle-search-results-' + side + '"></div></div>' +
      '<div id="battle-preview-' + side + '" style="min-height:60px"><div style="color:#555;text-align:center;padding:20px;font-size:18px">' + t('battle.selectFirst') + '</div></div>' +
      '<div style="margin-top:8px;font-size:14px;color:#888">' + t('battle.ivLabel') + ':</div>' +
      '<div class="battle-iv-grid">' + ivInputs + '</div>' +
      '<div class="battle-select-row"><label>' + t('build.nature') + '</label>' +
      '<select id="bnat-' + side + '" onchange="battleUpdateFromInputs(\'' + side + '\')">' + natureOpts + '</select></div>' +
      '<div class="battle-select-row"><label>' + t('build.ability') + '</label>' +
      '<select id="babil-' + side + '" onchange="battleUpdateFromInputs(\'' + side + '\')"><option>' + t('battle.selectFirst') + '</option></select></div>' +
      '</div>';
  }
  return '<div class="page-title"><span>\u2694 ' + t('nav.battle') + '</span></div>' +
    '<div class="battle-page">' +
    '<div style="text-align:center;margin-bottom:16px;font-size:16px;color:#888">' + t('battle.intro') + '</div>' +
    '<div class="battle-setup">' +
    buildSetupCard('player', t('battle.yourPoke'), 'var(--green)') +
    buildSetupCard('opponent', t('battle.opponent'), 'var(--red)') +
    '</div>' +
    '<div class="battle-start-wrap">' +
    '<button class="battle-start-btn" id="battle-start-btn" onclick="battleStart()" disabled>\u2694 ' + t('battle.startBattle') + '</button>' +
    '</div></div>';
}

/* ================================================================
   PAGES
   ================================================================ */
/* ================================================================
   PAGES
   ================================================================ */
/* ── RANKING RENDERER ── */
function renderRankingPage() {
  var html = '<div class="page-title"><span>'+t('sec.ranking')+'</span></div>';
  html += '<div style="text-align:center;font-size:16px;color:#888;margin-bottom:16px">'+t('ranking.desc')+'</div>';
  html += '<div class="ranking-nav-btns">';
  ALL_TYPES.forEach(function(tp) {
    var cls = tp === rankingSelectedType ? 'ranking-nav-btn type-badge type-'+tp+' active-rank' : 'ranking-nav-btn type-badge type-'+tp;
    html += '<button class="'+cls+'" onclick="selectRankingType(\''+tp+'\')">' + typeName(tp) + '</button>';
  });
  html += '</div>';
  var pokes = TYPE_RANKING[rankingSelectedType] || [];
  var counters = COUNTER_PICKS[rankingSelectedType] || [];
  html += '<div class="ranking-section">';
  html += '<div class="ranking-type-header"><span class="type-badge type-'+rankingSelectedType+'" style="font-size:18px!important;padding:6px 18px!important">' + typeName(rankingSelectedType) + '</span>';
  html += '<h3>Top 6 ' + typeName(rankingSelectedType) + '</h3></div>';
  html += '<div class="ranking-grid">';
  pokes.forEach(function(p, idx) {
    var artUrl = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/' + p[0] + '.png';
    var spriteUrl = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/' + p[0] + '.png';
    var typeBadges = p[2].map(function(tp){ return '<span class="type-badge type-'+tp+'">'+typeName(tp)+'</span>'; }).join('');
    var counterHTML = '';
    counters.forEach(function(c) {
      var cSprite = 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/' + c.id + '.png';
      var reason = c.r[currentLang] || c.r.en;
      counterHTML += '<div class="ranking-counter-item">' +
        '<img src="'+cSprite+'" loading="lazy" alt="'+c.name+'"/>' +
        '<span class="ranking-counter-name">' + c.name + '</span>' +
        '<span class="ranking-counter-reason">' + reason + '</span></div>';
    });
    html += '<div class="ranking-card">' +
      '<span class="ranking-card-rank">#' + (idx+1) + '</span>' +
      '<div class="ranking-card-header">' +
      '<img src="'+artUrl+'" loading="lazy" onerror="this.src=\''+spriteUrl+'\'" alt="'+p[1]+'"/>' +
      '<div><div class="ranking-card-name">' + p[1] + '</div>' +
      '<div class="ranking-card-types">' + typeBadges + '</div></div></div>' +
      '<div class="ranking-counters">' +
      '<div class="ranking-counters-title">\u2694 ' + t('ranking.counters') + '</div>' +
      counterHTML + '</div>' +
      '<button class="ranking-build-btn" onclick="loadBuildFromRanking('+p[0]+',\''+p[1]+'\')">' +
      '\ud83d\udccb ' + t('ranking.buildBtn') + '</button></div>';
  });
  html += '</div></div>';
  return html;
}
function selectRankingType(tp) {
  rankingSelectedType = tp;
  showPage('ranking');
}
function loadBuildFromRanking(id, name) {
  loadDetail(id, name).then(function() {
    setTimeout(function() {
      var comp = document.querySelector('.comp-section');
      if (comp) comp.scrollIntoView({behavior:'smooth',block:'start'});
    }, 600);
  });
}

function showPage(page) {
  currentPage = page;
  var main = document.getElementById('main-area');

  if (page === 'welcome') {
    main.innerHTML =
      '<div class="page-title"><span>\ud83c\udfe0 Cobblemon Mastery Guide</span></div>'
      + renderFavoritesSection()
      + '<div class="welcome-grid">'
      + '<div class="welcome-card"><h3>\u2694 '+t('welcome.what')+'</h3><p>'+t('welcome.whatDesc')+'</p></div>'
      + '<div class="welcome-card"><h3>\ud83d\udd0d '+t('welcome.howUse')+'</h3><ul><li>'+(currentLang==='en'?'Search for a Pok\u00e9mon in the sidebar':'Wyszukaj Pok\u00e9mona w pasku po lewej')+'</li><li>'+(currentLang==='en'?'Filter by generation (I\u2013IX)':'Filtruj wed\u0142ug generacji (I\u2013IX)')+'</li><li>\u2665 = '+(currentLang==='en'?'friendship evolution':'ewolucja przez przyja\u017a\u0144')+'</li><li>\u21c4 = '+(currentLang==='en'?'trade evolution':'ewolucja przez wymian\u0119')+'</li><li>\u2b50 = '+(currentLang==='en'?'add to favorites':'dodaj do ulubionych')+'</li></ul></div>'
      + '<div class="welcome-card"><h3>\ud83d\udc9b '+t('welcome.friend')+'</h3><p>'+(currentLang==='en'?'In Cobblemon, check friendship evolution with:':'W Cobblemonie ewolucje przez przyja\u017a\u0144 sprawdzasz komend\u0105:')+'</p><div class="cmd-block">/checkfriendship @s</div><p style="margin-top:8px;font-size:16px;color:#888">'+(currentLang==='en'?'You need min. 160/255.':'Potrzebujesz min. 160/255.')+'</p></div>'
      + '<div class="welcome-card"><h3>\ud83d\udd17 '+t('welcome.link')+'</h3><p>'+(currentLang==='en'?'Replaces the Pok\u00e9mon trade from the original games. Activate in hand near another player.':'Zast\u0119puje wymian\u0119 Pok\u00e9mon\u00f3w z oryginalnych gier. Aktywuj w r\u0119ce, b\u0119d\u0105c blisko innego gracza.')+'</p></div>'
      + '<div class="welcome-card"><h3>\ud83c\udf4e '+t('nav.apricorns')+'</h3><p>'+(currentLang==='en'?'Collect Apricorns from trees and craft unique Pok\u00e9balls!':'Zbieraj Apricorny z drzew i craftuj unikalne Pokeballsy!')+'</p><p style="margin-top:6px"><button class="mc-btn" onclick="showPage(\'apricorns\')">\u2192 '+t('nav.apricorns')+'</button></p></div>'
      + '<div class="welcome-card"><h3>\ud83d\udce6 '+t('nav.items')+'</h3><p>'+(currentLang==='en'?'All key items in one place.':'Wszystkie wa\u017cne przedmioty w jednym miejscu.')+'</p><p style="margin-top:6px"><button class="mc-btn" onclick="showPage(\'items\')">\u2192 '+t('nav.items')+'</button></p></div>'
      + '<div class="welcome-card"><h3>\u2694 '+t('nav.team')+'</h3><p>'+(currentLang==='en'?'Analyze your PvP team composition and type coverage.':'Analizuj sk\u0142ad dru\u017cyny PvP i pokrycie typ\u00f3w.')+'</p><p style="margin-top:6px"><button class="mc-btn" onclick="showPage(\'team-analyzer\')">\u2192 '+t('nav.team')+'</button></p></div>'
      + '<div class="welcome-card"><h3>\u2696 '+t('nav.typechart')+'</h3><p>'+(currentLang==='en'?'Check your Pok\u00e9mon\'s weaknesses, resistances and immunities with dual-type support.':'Sprawd\u017a s\u0142abo\u015bci, odporno\u015bci i immunitety swojego Pok\u00e9mona z obs\u0142ug\u0105 podw\u00f3jnych typ\u00f3w.')+'</p><p style="margin-top:6px"><button class="mc-btn" onclick="showPage(\'type-chart\')">\u2192 '+t('nav.typechart')+'</button></p></div>'
      + '<div class="welcome-card" style="border-top-color:#5a5a8a;border-left-color:#5a5a8a"><h3 style="color:#c084fc">\ud83c\udfc6 '+t('nav.ranking')+'</h3><p>'+(currentLang==='en'?'Explore the Top 6 Pok\u00e9mon of each type with counter-strategies and build recommendations.':'Przegl\u0105daj Top 6 Pok\u00e9mon\u00f3w ka\u017cdego typu z kontrstrategiami i rekomendacjami build\u00f3w.')+'</p><p style="margin-top:6px"><button class="mc-btn" onclick="showPage(\'ranking\')" style="background:#2a2a5a;border-top-color:#5a5a8a;border-left-color:#5a5a8a">\u2192 '+t('nav.ranking')+'</button></p></div>'
      + '<div class="welcome-card" style="border-top-color:#8a5a5a;border-left-color:#8a5a5a"><h3 style="color:var(--red)">\u2694 '+t('nav.battle')+'</h3><p>'+t('battle.welcomeDesc')+'</p><p style="margin-top:6px"><a class="mc-btn" href="arena.html" style="background:#5a2a2a;border-top-color:#8a5a5a;border-left-color:#8a5a5a;text-decoration:none">\u2192 '+t('nav.battle')+'</a></p></div>'
      + '</div>';
  }

  if (page === 'detail-loading') {
    main.innerHTML = '<div class="empty-state"><span class="big-icon">\u2699</span>'+(currentLang==='en'?'Loading Pok\u00e9mon data...':'\u0141adowanie danych Pok\u00e9mona...')+'</div>';
  }

  if (page === 'items') {
    main.innerHTML =
      '<div class="page-title"><span>\ud83d\udce6 '+t('sec.items')+'</span></div>'
      + '<div class="items-grid">' + renderItems() + '</div>';
  }

  if (page === 'apricorns') {
    main.innerHTML =
      '<div class="page-title"><span>\ud83c\udf4e '+t('sec.apricorns')+'</span></div>'
      + '<div class="mc-panel" style="margin-bottom:16px"><h2>\u2139\ufe0f '+t('apricorn.how')+'</h2><p style="font-size:18px;color:#aaa;line-height:1.6">'+t('apricorn.howDesc')+'</p></div>'
      + '<div class="apricorn-grid">' + renderApricorns() + '</div>';
  }

  if (page === 'team-analyzer') {
    loadTeam();
    main.innerHTML =
      '<div class="page-title"><span>\u2694 '+t('sec.team')+'</span></div>'
      + '<div class="team-section"><h2>\ud83d\udee1 '+t('sec.team')+'</h2>'
      + '<div id="team-analyzer-content"></div></div>';
    renderTeamPage();
  }

  if (page === 'type-chart') {
    wcType1 = ''; wcType2 = '';
    main.innerHTML =
      '<div class="page-title"><span>'+t('sec.typechart')+'</span></div>'
      + renderWeaknessChecker();
    wcUpdateDisplay();
  }

  if (page === 'battle-sim') {
    window.location.href = 'arena.html';
    return;
  }

  if (page === 'ranking') {
    main.innerHTML = renderRankingPage();
  }
}

/* ================================================================
   ITEMS DATA & RENDER
   ================================================================ */
var ITEMS_DATA = [
  { name:{pl:'Link Cable',en:'Link Cable'},                    slug:'linking-cord',   desc:{pl:'Zast\u0119puje wymian\u0119 Pok\u00e9mon\u00f3w. Aktywuj w r\u0119ce blisko gracza.',en:'Replaces Pok\u00e9mon trade. Activate in hand near a player.'}, tag:{pl:'Ewolucja',en:'Evolution'} },
  { name:{pl:'Kamie\u0144 Gromu',en:'Thunder Stone'},          slug:'thunder-stone',  desc:{pl:'Ewoluuje: Pikachu\u2192Raichu, Eevee\u2192Jolteon',en:'Evolves: Pikachu\u2192Raichu, Eevee\u2192Jolteon'}, tag:{pl:'Kamie\u0144',en:'Stone'} },
  { name:{pl:'Kamie\u0144 Ognia',en:'Fire Stone'},             slug:'fire-stone',     desc:{pl:'Ewoluuje: Vulpix\u2192Ninetales, Growlithe\u2192Arcanine, Eevee\u2192Flareon',en:'Evolves: Vulpix\u2192Ninetales, Growlithe\u2192Arcanine, Eevee\u2192Flareon'}, tag:{pl:'Kamie\u0144',en:'Stone'} },
  { name:{pl:'Kamie\u0144 Wody',en:'Water Stone'},             slug:'water-stone',    desc:{pl:'Ewoluuje: Poliwhirl\u2192Poliwrath, Shellder\u2192Cloyster, Eevee\u2192Vaporeon',en:'Evolves: Poliwhirl\u2192Poliwrath, Shellder\u2192Cloyster, Eevee\u2192Vaporeon'}, tag:{pl:'Kamie\u0144',en:'Stone'} },
  { name:{pl:'Kamie\u0144 Li\u015bcia',en:'Leaf Stone'},       slug:'leaf-stone',     desc:{pl:'Ewoluuje: Exeggcute\u2192Exeggutor, Weepinbell\u2192Victreebel',en:'Evolves: Exeggcute\u2192Exeggutor, Weepinbell\u2192Victreebel'}, tag:{pl:'Kamie\u0144',en:'Stone'} },
  { name:{pl:'Kamie\u0144 Ksi\u0119\u017cyca',en:'Moon Stone'},slug:'moon-stone',     desc:{pl:'Ewoluuje: Nidorina\u2192Nidoqueen, Clefairy\u2192Clefable',en:'Evolves: Nidorina\u2192Nidoqueen, Clefairy\u2192Clefable'}, tag:{pl:'Kamie\u0144',en:'Stone'} },
  { name:{pl:'Kamie\u0144 S\u0142o\u0144ca',en:'Sun Stone'},   slug:'sun-stone',      desc:{pl:'Ewoluuje: Gloom\u2192Bellossom, Sunkern\u2192Sunflora',en:'Evolves: Gloom\u2192Bellossom, Sunkern\u2192Sunflora'}, tag:{pl:'Kamie\u0144',en:'Stone'} },
  { name:{pl:'Kamie\u0144 Zmierzchu',en:'Dusk Stone'},         slug:'dusk-stone',     desc:{pl:'Ewoluuje: Murkrow\u2192Honchkrow, Misdreavus\u2192Mismagius',en:'Evolves: Murkrow\u2192Honchkrow, Misdreavus\u2192Mismagius'}, tag:{pl:'Kamie\u0144',en:'Stone'} },
  { name:{pl:'Kamie\u0144 \u015awietlisty',en:'Shiny Stone'},  slug:'shiny-stone',    desc:{pl:'Ewoluuje: Togetic\u2192Togekiss, Roselia\u2192Roserade',en:'Evolves: Togetic\u2192Togekiss, Roselia\u2192Roserade'}, tag:{pl:'Kamie\u0144',en:'Stone'} },
  { name:{pl:'Kamie\u0144 Lodu',en:'Ice Stone'},               slug:'ice-stone',      desc:{pl:'Ewoluuje: Alolan Sandshrew\u2192Sandslash, Alolan Vulpix\u2192Ninetales',en:'Evolves: Alolan Sandshrew\u2192Sandslash, Alolan Vulpix\u2192Ninetales'}, tag:{pl:'Kamie\u0144',en:'Stone'} },
  { name:{pl:'Metalowa Pow\u0142oka',en:'Metal Coat'},         slug:'metal-coat',     desc:{pl:'Trzymany przez Onix\u2192Steelix lub Scyther\u2192Scizor (Link Cable)',en:'Held by Onix\u2192Steelix or Scyther\u2192Scizor (Link Cable)'}, tag:{pl:'Trzymany',en:'Held Item'} },
  { name:{pl:'Smocza \u0141uska',en:'Dragon Scale'},           slug:'dragon-scale',   desc:{pl:'Trzymany przez Seadra\u2192Kingdra (Link Cable)',en:'Held by Seadra\u2192Kingdra (Link Cable)'}, tag:{pl:'Trzymany',en:'Held Item'} },
  { name:{pl:'Ska\u0142a Kr\u00f3la',en:"King's Rock"},        slug:'kings-rock',     desc:{pl:'Slowpoke\u2192Slowking lub Poliwhirl\u2192Politoed (Link Cable)',en:'Slowpoke\u2192Slowking or Poliwhirl\u2192Politoed (Link Cable)'}, tag:{pl:'Trzymany',en:'Held Item'} },
  { name:{pl:'Ulepszenie',en:'Up-Grade'},                      slug:'up-grade',       desc:{pl:'Porygon\u2192Porygon2 (Link Cable)',en:'Porygon\u2192Porygon2 (Link Cable)'}, tag:{pl:'Trzymany',en:'Held Item'} },
  { name:{pl:'W\u0105tpliwy Dysk',en:'Dubious Disc'},          slug:'dubious-disc',   desc:{pl:'Porygon2\u2192Porygon-Z (Link Cable)',en:'Porygon2\u2192Porygon-Z (Link Cable)'}, tag:{pl:'Trzymany',en:'Held Item'} },
  { name:{pl:'Z\u0105b G\u0142\u0119bin',en:'Deep Sea Tooth'}, slug:'deep-sea-tooth', desc:{pl:'Clamperl\u2192Huntail (Link Cable)',en:'Clamperl\u2192Huntail (Link Cable)'}, tag:{pl:'Trzymany',en:'Held Item'} },
  { name:{pl:'\u0141uska G\u0142\u0119bin',en:'Deep Sea Scale'},slug:'deep-sea-scale', desc:{pl:'Clamperl\u2192Gorebyss (Link Cable)',en:'Clamperl\u2192Gorebyss (Link Cable)'}, tag:{pl:'Trzymany',en:'Held Item'} },
  { name:{pl:'Saszetka',en:'Sachet'},                          slug:'sachet',         desc:{pl:'Spritzee\u2192Aromatisse (Link Cable)',en:'Spritzee\u2192Aromatisse (Link Cable)'}, tag:{pl:'Trzymany',en:'Held Item'} },
  { name:{pl:'Bita \u015amietana',en:'Whipped Dream'},         slug:'whipped-dream',  desc:{pl:'Swirlix\u2192Slurpuff (Link Cable)',en:'Swirlix\u2192Slurpuff (Link Cable)'}, tag:{pl:'Trzymany',en:'Held Item'} },
  { name:{pl:'Pryzmowa \u0141uska',en:'Prism Scale'},          slug:'prism-scale',    desc:{pl:'Feebas\u2192Milotic (Link Cable)',en:'Feebas\u2192Milotic (Link Cable)'}, tag:{pl:'Trzymany',en:'Held Item'} },
  { name:{pl:'Mikstura',en:'Potion / Max Potion'},             slug:'potion',         desc:{pl:'Leczy P\u017b pok\u00e9mona.',en:'Heals Pok\u00e9mon HP.'}, tag:{pl:'Leczenie',en:'Healing'} },
  { name:{pl:'O\u017cywienie',en:'Revive'},                    slug:'revive',         desc:{pl:'Przywraca omdla\u0142ego pok\u00e9mona do 50% P\u017b',en:'Revives fainted Pok\u00e9mon to 50% HP'}, tag:{pl:'Leczenie',en:'Healing'} },
  { name:{pl:'Dzwonek \u0141agodno\u015bci',en:'Soothe Bell'}, slug:'soothe-bell',    desc:{pl:'Przyspiesza zdobywanie Friendship.',en:'Speeds up Friendship gain.'}, tag:{pl:'Przyja\u017a\u0144',en:'Friendship'} },
  { name:{pl:'Resztki',en:'Leftovers'},                        slug:'leftovers',      desc:{pl:'Regeneruje 1/16 P\u017b co tur\u0119.',en:'Restores 1/16 HP per turn.'}, tag:{pl:'Trzymany',en:'Held Item'} },
  { name:{pl:'Tarcza Umiej\u0119tno\u015bci',en:'Ability Shield'},slug:'ability-shield',desc:{pl:'Chroni umiej\u0119tno\u015b\u0107 posiadacza przed zmian\u0105 lub zablokowaniem.',en:'Protects the holder\u2019s Ability from being changed or suppressed.'}, tag:{pl:'PvP',en:'PvP'} },
  { name:{pl:'Kamizelka Szturmowa',en:'Assault Vest'},         slug:'assault-vest',   desc:{pl:'Zwi\u0119ksza Sp. Def o 50%, ale blokuje ruchy statusowe.',en:'Boosts Sp. Def by 50% but prevents status moves.'}, tag:{pl:'PvP',en:'PvP'} },
  { name:{pl:'Wst\u0119ga Wyboru',en:'Choice Band'},           slug:'choice-band',    desc:{pl:'Zwi\u0119ksza Atak o 50%, ale pozwala u\u017cywa\u0107 tylko jednego ruchu.',en:'Boosts Attack by 50% but locks into one move.'}, tag:{pl:'PvP',en:'PvP'} },
  { name:{pl:'Szalik Wyboru',en:'Choice Scarf'},               slug:'choice-scarf',   desc:{pl:'Zwi\u0119ksza Szybko\u015b\u0107 o 50%, ale pozwala u\u017cywa\u0107 tylko jednego ruchu.',en:'Boosts Speed by 50% but locks into one move.'}, tag:{pl:'PvP',en:'PvP'} },
  { name:{pl:'Okulary Wyboru',en:'Choice Specs'},              slug:'choice-specs',   desc:{pl:'Zwi\u0119ksza Sp. Atak o 50%, ale pozwala u\u017cywa\u0107 tylko jednego ruchu.',en:'Boosts Sp. Atk by 50% but locks into one move.'}, tag:{pl:'PvP',en:'PvP'} },
  { name:{pl:'Eviolit',en:'Eviolite'},                         slug:'eviolite',       desc:{pl:'Zwi\u0119ksza Def i Sp.Def o 50% dla Pok\u00e9mon\u00f3w, kt\u00f3re mog\u0105 jeszcze ewoluowa\u0107.',en:'Boosts Def and Sp.Def by 50% for Pok\u00e9mon that can still evolve.'}, tag:{pl:'PvP',en:'PvP'} },
  { name:{pl:'Szarfa Skupienia',en:'Focus Sash'},              slug:'focus-sash',     desc:{pl:'Pozwala prze\u017cy\u0107 atak z 1 HP przy pe\u0142nym zdrowiu (zu\u017cywa si\u0119).',en:'Survives a KO hit with 1 HP at full health (consumed).'}, tag:{pl:'PvP',en:'PvP'} },
  { name:{pl:'Sfera \u017bycia',en:'Life Orb'},                slug:'life-orb',       desc:{pl:'Zwi\u0119ksza moc atak\u00f3w o 30%, ale zabiera 10% HP przy ka\u017cdym trafieniu.',en:'Boosts move power by 30% but costs 10% HP per hit.'}, tag:{pl:'PvP',en:'PvP'} },
  { name:{pl:'Skalny He\u0142m',en:'Rocky Helmet'},            slug:'rocky-helmet',   desc:{pl:'Zadaje obra\u017cenia przeciwnikowi przy ataku fizycznym na posiadacza.',en:'Damages the attacker when they make contact.'}, tag:{pl:'PvP',en:'PvP'} },
  { name:{pl:'Jagoda Sitrus',en:'Sitrus Berry'},               slug:'sitrus-berry',   desc:{pl:'Leczy 25% HP, gdy zdrowie spadnie poni\u017cej 50%.',en:'Restores 25% HP when health drops below 50%.'}, tag:{pl:'Jagoda',en:'Berry'} },
  { name:{pl:'Jagoda Lum',en:'Lum Berry'},                     slug:'lum-berry',      desc:{pl:'Leczy dowolny status (zatrucie, para\u017c, sen itp.).',en:'Cures any status condition (poison, paralysis, sleep, etc.).'}, tag:{pl:'Jagoda',en:'Berry'} },
];

function renderItems() {
  return ITEMS_DATA.map(function(item) {
    var imgTag = '<img class="item-icon-img" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/'+item.slug+'.png" onerror="this.parentNode.innerHTML=\'<span style=color:#555;font-size:28px>\u25A1</span>\'" />';
    var itemName = typeof item.name==='object'?item.name[currentLang]||item.name.pl:item.name;
    var desc = typeof item.desc==='object'?item.desc[currentLang]||item.desc.pl:item.desc;
    var tag = typeof item.tag==='object'?item.tag[currentLang]||item.tag.pl:item.tag;
    return '<div class="item-card"><div class="item-icon-only">'+imgTag+'</div><div><div class="item-name">'+itemName+'</div><div class="item-desc">'+desc+'</div><span class="item-tag">'+tag+'</span></div></div>';
  }).join('');
}

/* ================================================================
   APRICORNS DATA & RENDER
   ================================================================ */
var APRICORNS_DATA = [
  { hex:'#222', color:{pl:'Czarny',en:'Black'}, ball:'Heavy Ball', ballSlug:'heavy-ball', effect:{pl:'\u0141atwiej \u0142apa\u0107 ci\u0119\u017ckie Pok\u00e9mony (\u2265 451.5 kg)',en:'Easier to catch heavy Pok\u00e9mon (\u2265451.5 kg)'} },
  { hex:'#3366cc', color:{pl:'Niebieski',en:'Blue'}, ball:'Lure Ball', ballSlug:'lure-ball', effect:{pl:'3\u00d7 skuteczno\u015b\u0107 przy \u0142apaniu w wodzie',en:'3\u00d7 catch rate when fishing'} },
  { hex:'#33aa33', color:{pl:'Zielony',en:'Green'}, ball:'Friend Ball', ballSlug:'friend-ball', effect:{pl:'Z\u0142owiony Pok\u00e9mon startuje z 200 Friendship',en:'Caught Pok\u00e9mon starts with 200 Friendship'} },
  { hex:'#dd66aa', color:{pl:'R\u00f3\u017cowy',en:'Pink'}, ball:'Love Ball', ballSlug:'love-ball', effect:{pl:'8\u00d7 skuteczno\u015b\u0107 na t\u0119 sam\u0105 sp., odmient\u0105 p\u0142e\u0107',en:'8\u00d7 rate on same species, different gender'} },
  { hex:'#cc3333', color:{pl:'Czerwony',en:'Red'}, ball:'Level Ball', ballSlug:'level-ball', effect:{pl:'Wy\u017cszy mno\u017cnik gdy Tw\u00f3j Pok\u00e9mon ma wy\u017cszy level',en:'Higher multiplier when your Pok\u00e9mon has higher level'} },
  { hex:'#ddd', color:{pl:'Bia\u0142y',en:'White'}, ball:'Fast Ball', ballSlug:'fast-ball', effect:{pl:'4\u00d7 skuteczno\u015b\u0107 na Pok\u00e9mony, kt\u00f3re uciekaj\u0105',en:'4\u00d7 rate on Pok\u00e9mon that flee'} },
  { hex:'#ddcc33', color:{pl:'\u017b\u00f3\u0142ty',en:'Yellow'}, ball:'Moon Ball', ballSlug:'moon-ball', effect:{pl:'4\u00d7 skuteczno\u015b\u0107 na ewoluuj\u0105ce Moon Stonem',en:'4\u00d7 rate on Moon Stone evolutions'} },
];

function renderApricorns() {
  return APRICORNS_DATA.map(function(a) {
    var ballImg = '<img class="item-icon-img" src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/'+a.ballSlug+'.png" onerror="this.parentNode.innerHTML=\'\u25cf\'" style="vertical-align:middle" />';
    var colorName = typeof a.color==='object'?a.color[currentLang]||a.color.pl:a.color;
    var effect = typeof a.effect==='object'?a.effect[currentLang]||a.effect.pl:a.effect;
    return '<div class="apricorn-card"><div class="apricorn-fruit" style="background:'+a.hex+'"></div><div class="apricorn-name">'+colorName+' Apricorn</div><div class="apricorn-arrow">\u25bc</div><div class="apricorn-ball">'+ballImg+' '+a.ball+'</div><div class="apricorn-effect">'+effect+'</div></div>';
  }).join('');
}

/* ================================================================
   UTILITIES
   ================================================================ */
function setStatus(text, loading) {
  document.getElementById('status-text').textContent = text;
  document.getElementById('spinner').classList.toggle('active', loading);
}

function switchMovesTab(btn, panelId) {
  var section = btn.closest('.moves-section');
  section.querySelectorAll('.moves-tab').forEach(function(b){b.classList.remove('active');});
  section.querySelectorAll('.moves-panel').forEach(function(p){p.classList.remove('active');});
  btn.classList.add('active');
  var panel = document.getElementById(panelId);
  if (panel) panel.classList.add('active');
}

function switchBuildTab(btn, panelId) {
  var section = btn.closest('.comp-section');
  section.querySelectorAll('.build-tab').forEach(function(b){b.classList.remove('active');});
  section.querySelectorAll('.build-panel').forEach(function(p){p.classList.remove('active');});
  btn.classList.add('active');
  var panel = document.getElementById(panelId);
  if (panel) panel.classList.add('active');
}

function getIVSliderColor(val) {
  if (val >= 31) return '#55ffff';
  if (val >= 26) return '#88ff88';
  if (val >= 16) return '#f8d030';
  return '#ff5555';
}

function applyIVSliderStyle(rangeEl, val) {
  var color = getIVSliderColor(val);
  var pct = Math.round(val / 31 * 100);
  rangeEl.style.setProperty('--iv-thumb', color);
  rangeEl.style.setProperty('--iv-track', color);
  rangeEl.style.setProperty('--iv-pct', pct + '%');
  var parent = rangeEl.closest('.iv-hybrid, .calc-iv-hybrid');
  if (parent) {
    parent.style.setProperty('--iv-thumb', color);
    parent.style.setProperty('--iv-track', color);
    parent.style.setProperty('--iv-pct', pct + '%');
  }
}

function syncIVHybrid(el, source) {
  var container = el.closest('.iv-hybrid');
  if (!container) return;
  var rangeEl = container.querySelector('input[type="range"]');
  var numEl = container.querySelector('input[type="number"]');
  var val = parseInt(el.value);
  if (isNaN(val)) val = 0;
  if (val < 0) val = 0; if (val > 31) val = 31;
  rangeEl.value = val;
  numEl.value = val;
  applyIVSliderStyle(rangeEl, val);
  updateIVBar(numEl);
}

function syncCalcIVHybrid(el, source, sn) {
  var container = el.closest('.calc-iv-hybrid');
  if (!container) return;
  var rangeEl = container.querySelector('input[type="range"]');
  var numEl = container.querySelector('input[type="number"]');
  var val = parseInt(el.value);
  if (isNaN(val)) val = 0;
  if (val < 0) val = 0; if (val > 31) val = 31;
  rangeEl.value = val;
  numEl.value = val;
  applyIVSliderStyle(rangeEl, val);
}

function syncBattleIVHybrid(el, source, side, sn) {
  var container = el.closest('.calc-iv-hybrid');
  if (!container) return;
  var rangeEl = container.querySelector('input[type="range"]');
  var numEl = container.querySelector('input[type="number"]');
  var val = parseInt(el.value);
  if (isNaN(val)) val = 0;
  if (val < 0) val = 0; if (val > 31) val = 31;
  rangeEl.value = val;
  numEl.value = val;
  applyIVSliderStyle(rangeEl, val);
  battleUpdateFromInputs(side);
}

function initAllIVSliders() {
  document.querySelectorAll('.iv-hybrid input[type="range"], .calc-iv-hybrid input[type="range"]').forEach(function(r) {
    applyIVSliderStyle(r, parseInt(r.value) || 0);
  });
}

function updateIVBar(input) {
  var val = parseInt(input.value);
  if (isNaN(val)) val = 0;
  if (val < 0) val = 0; if (val > 31) val = 31;
  input.value = val;
  var sn = input.dataset.stat;
  var pct = Math.round(val / 31 * 100);
  var bar = document.getElementById('ivbar-' + sn);
  var lbl = document.getElementById('ivlabel-' + sn);
  if (!bar || !lbl) return;
  var color = val>=28?'#55ff55':val>=20?'#f8d030':val>=10?'#f08030':'#ff5555';
  bar.style.width = pct + '%'; bar.style.background = color;
  if(val>=28) lbl.innerHTML='<span style="color:#55ff55">Doskona\u0142e</span>';
  else if(val>=20) lbl.innerHTML='<span style="color:#f8d030">Dobre</span>';
  else if(val>=10) lbl.innerHTML='<span style="color:#f08030">S\u0142abe</span>';
  else lbl.innerHTML='<span style="color:#ff5555">Z\u0142e</span>';
}

/* ================================================================
   EVENT LISTENERS
   ================================================================ */
document.getElementById('search-input').addEventListener('input', function(e) {
  searchQuery = e.target.value; applyFilters();
});
document.getElementById('gen-filters').addEventListener('click', function(e) {
  var btn = e.target.closest('.gen-filter-btn');
  if (!btn) return;
  document.querySelectorAll('.gen-filter-btn').forEach(function(b){b.classList.remove('active');});
  btn.classList.add('active');
  selectedGen = parseInt(btn.dataset.gen);
  applyFilters();
});

/* ================================================================
   START
   ================================================================ */
init();
</script>
</body>
</html>